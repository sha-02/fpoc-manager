# fpoc02 Spoke01 FortiOS 7.0.3
# context = {'i': 1, 'ike': '2', 'overlay': 'modecfg', 'routing': 'ibgp', 'advpn': True, 'nat_hub': 'None', 'hub': '198.51.100.1', 'hub_dnat': '198.51.100.201', 'nat': 'None', 'name': 'Spoke01', 'fos_version': '7.0.3', 'FOS': 7000003, 'mgmt_fpoc': '172.16.31.254', 'HA': FortiGate_HA(mode=<Modes.STANDALONE: 0>, role=<Roles.STANDALONE: 0>, group_id=None, group_name=None, hbdev=None, sessyncdev=None, monitordev=None, priority=None), 'wan': WAN(inet=WanSettings(port='port1', vlanid=0, subnet='203.0.113'), inet_snat=WanSettings(port='port1', vlanid=200, subnet='192.168.200'), inet_dnat=WanSettings(port='port1', vlanid=201, subnet='192.168.201'), inet1=WanSettings(port='port1', vlanid=21, subnet='100.64.21'), inet1_snat=WanSettings(port='port1', vlanid=210, subnet='192.168.210'), inet1_dnat=WanSettings(port='port1', vlanid=211, subnet='192.168.211'), inet2=WanSettings(port='port1', vlanid=22, subnet='100.64.22'), inet2_snat=WanSettings(port='port1', vlanid=220, subnet='192.168.220'), inet2_dnat=WanSettings(port='port1', vlanid=221, subnet='192.168.221'), inet3=WanSettings(port='port1', vlanid=23, subnet='100.64.23'), inet3_snat=WanSettings(port='port1', vlanid=230, subnet='192.168.230'), inet3_dnat=WanSettings(port='port1', vlanid=231, subnet='192.168.231'), mpls1=WanSettings(port='port2', vlanid=24, subnet='10.0.24'), mpls2=WanSettings(port='port2', vlanid=25, subnet='10.0.25')), 'request': <WSGIRequest: POST '/poc/2/'>, 'csrf_input': '<input type="hidden" name="csrfmiddlewaretoken" value="Uq0fwecXXqMvUs00PKDSK9GueuKuUtZJJQi4LHfSUBoV0CvS3wZ3A2l4UIwoNyrj">', 'csrf_token': 'jwGMaunb3PnJu11cHWbWtAqEWHvOGZ238WYBpXq600Z9Abw4VIx7jt5eCVhIz4uD'}
#
##################################################



config system global
    set hostname Spoke01
    set gui-theme mariner
end

# Internet and OOB management interfaces

config system interface
    edit "port1"
        set vdom "root"
        set mode static
        set ip 203.0.113.1 255.255.255.0
        set allowaccess ping
        set description "INET public IP"
        set alias "Inet no NAT 203.0.113.1"
    next
    edit "Internet_SNAT"
        set vdom "root"
        set mode static
        set ip 192.168.200.1 255.255.255.0
        set allowaccess ping
        set description "INET private IP for PAT/SNAT"
        set alias "Inet SNAT 203.0.113.200"
        set interface "port1"
        set vlanid 200
        
            set status down
        
    next
    edit "Internet_VIP"
        set vdom "root"
        set mode static
        set ip 192.168.201.1 255.255.255.0
        set allowaccess ping
        set description "INET private IP for VIP/DNAT"
        set alias "Inet VIP 203.0.113.201"
        set interface "port1"
        set vlanid 201
        
            set status down
        
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip 192.168.1.254 255.255.255.0
        set allowaccess ping https ssh http telnet
        set alias "LAN"
    next
    edit "port10"
        set allowaccess ping https ssh http telnet
        set alias "OOB Management"
    next
end

# addresses and groups

config firewall address
    edit "LAN"
        set subnet 192.168.1.0 255.255.255.0
    next
    edit "CorporateSubnets"
        set subnet 192.168.0.0 255.255.0.0
    next
end

# IPsec


# ADVPN:
# 'net-device enable' since this is compatible with sd-wan
# 'add-route disable' to prevent learning routes from T.S. during shortcut negotiations


config vpn ipsec phase1-interface
    edit "vpn"
        
            set interface "port1"
        
        set ike-version 2
        
        set peertype any
        set proposal aes128-sha1
        set localid "spoke01"
        set localid-type fqdn
        
            set remote-gw 198.51.100.1
        
        set psksecret 111111
        
        
          set auto-discovery-receiver enable
          set net-device enable
          set add-route disable
        
        
        
          set mode-cfg enable
          set add-route disable
        
    next
end



config vpn ipsec phase2-interface
    edit "vpn"
        set phase1name "vpn"
        set proposal aes128-sha1
        set auto-negotiate enable
        
    next
end


#  IPsec interface overlay IP
#

    

config system interface
    edit "vpn"
        
        set allowaccess ping
    next
end


# Policies



config firewall policy
    edit 1
        set name "Deny Internet"
        set srcintf "port5"
        set dstintf "port1" "Internet_SNAT" "Internet_VIP"
        set srcaddr "RFC1918-private-subnets"
        set dstaddr "RFC1918-private-subnets"
        set schedule "always"
        set service "ALL"
        set logtraffic all
    next
    edit 2
        set name "Internet Access"
        set srcintf "port5"
        set dstintf "port1" "Internet_SNAT" "Internet_VIP"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat enable
    next
    edit 3
        set name "to VPN"
        set srcintf "port5"
        set dstintf "vpn"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
    
    next
    
    edit 4
        set name "from VPN"
        set srcintf "vpn"
        set dstintf "port5"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
    next
    
end

# Static default-routes for Internet access

config router static
    edit 1
        set gateway 203.0.113.254
        set device "port1"
        
            set status enable
        
    next
    edit 101
        set gateway 192.168.200.254
        set device "Internet_SNAT"
        
            set status disable
        
    next
    edit 201
        set gateway 192.168.201.254
        set device "Internet_VIP"
        
            set status disable
        
    next
end






# =============== iBGP routing (route reflector) =================================================
#
# when mode-cfg is used, overlay IP is not predictable
# RID is based on internal IP instead of overlay IP so that this config works
# for both exchange-interface-ip and with mode-cfg

config router bgp
    set as 65000
    set router-id 192.168.1.254
    config neighbor
        edit "192.168.255.254"
            set remote-as 65000
            set interface "vpn"
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
        next
    end
    config network
        edit 1
            set prefix 192.168.1.0 255.255.255.0
        next
    end
end

#
#
# when using 'net-device enable' on Hub, /30 masks are pushed from Hub to Spoke with mode-cfg
# so this route is needed to cover the overall overlay subnet
#
#config router static
#    edit 2
#        set dst 192.168.255.0 255.255.255.0
#        set device "Hub"
#        set comment "Mandatory because forcing next-hop-self is not possible on the Hub\'s reflected routes"
#    next
#end
#
# with 'net-device enable' on Hub, a loopback is used on Hub for peering.
# IP of the Hub loopback is .254
#
#config router bgp
#    config neighbor
#        edit "192.168.255.254"
#            set remote-as 65000
#            set keep-alive-timer 10
#            set holdtime-timer 30
#            set connect-timer 1
#        next
#    end
#end





