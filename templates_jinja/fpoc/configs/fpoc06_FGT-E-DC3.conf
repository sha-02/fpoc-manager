# fpoc06 FGT-E-DC3 FortiOS 7.0.3
# context = {'dc_id': 3, 'local_ASN_FOS7': 65003, 'remote_ASN_FOS7': 65012, 'local_ASN_FOS6': 65000, 'remote_ASN_FOS6': 65000, 'remote_internet': 'mpls', 'cross_region_advpn': True, 'datacenter': {'west': {'first': {'id': 1, 'inet1': '100.64.11.1', 'inet2': '100.64.12.1', 'mpls': '10.0.14.1'}, 'second': {'id': 2, 'inet1': '100.64.21.2', 'inet2': '100.64.22.2', 'mpls': '10.0.24.2'}}, 'east': {'first': {'id': 3, 'inet1': '100.64.21.3', 'inet2': '100.64.22.3', 'mpls': '10.0.24.3'}, 'second': {'id': 4, 'inet1': '100.64.21.4', 'inet2': '100.64.22.4', 'mpls': '10.0.24.4'}}}, 'name': 'FGT-E-DC3', 'fos_version': '7.0.3', 'FOS': 7000003, 'mgmt_fpoc': '172.16.31.254', 'HA': FortiGate_HA(mode=<Modes.STANDALONE: 0>, role=<Roles.STANDALONE: 0>, group_id=None, group_name=None, hbdev=None, sessyncdev=None, monitordev=None, priority=None), 'wan': WAN(inet=WanSettings(port='port1', vlanid=0, subnet='203.0.113'), inet_snat=WanSettings(port='port1', vlanid=200, subnet='192.168.200'), inet_dnat=WanSettings(port='port1', vlanid=201, subnet='192.168.201'), inet1=WanSettings(port='port1', vlanid=21, subnet='100.64.21'), inet1_snat=WanSettings(port='port1', vlanid=210, subnet='192.168.210'), inet1_dnat=WanSettings(port='port1', vlanid=211, subnet='192.168.211'), inet2=WanSettings(port='port1', vlanid=22, subnet='100.64.22'), inet2_snat=WanSettings(port='port1', vlanid=220, subnet='192.168.220'), inet2_dnat=WanSettings(port='port1', vlanid=221, subnet='192.168.221'), inet3=WanSettings(port='port1', vlanid=23, subnet='100.64.23'), inet3_snat=WanSettings(port='port1', vlanid=230, subnet='192.168.230'), inet3_dnat=WanSettings(port='port1', vlanid=231, subnet='192.168.231'), mpls1=WanSettings(port='port2', vlanid=24, subnet='10.0.24'), mpls2=WanSettings(port='port2', vlanid=25, subnet='10.0.25')), 'request': <WSGIRequest: POST '/poc/6/'>, 'csrf_input': '<input type="hidden" name="csrfmiddlewaretoken" value="n1z9lFcImJvdc6kASJe3t5l25rMhPsd1crRYA8fDjU7DigPs6vAejY0CLFybIxFB">', 'csrf_token': 'x6xj2OWtmpYeJ8Q6ylcZEHSKm5pT1qe6mwP8hhZojAAEPilYM7yauAxk2jbNUvGG'}
#
##################################################



config system global
    set hostname FGT-E-DC3
    set gui-theme neutrino
end

# "session without SYN" required for ADVPN on Hub
#
config system settings
    set tcp-session-without-syn enable
end

config system alias
    edit "sniff_client1"
        set command "diagnose sniffer packet any \'host 10.0.1.101\' 4"
    next
    edit "sniff_client2"
        set command "diagnose sniffer packet any \'host 10.0.2.101\' 4"
    next
    edit "sniff_client3"
        set command "diagnose sniffer packet any \'host 10.0.3.101\' 4"
    next
    edit "flow_client1"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 10.0.1.101
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_client2"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 10.0.2.101
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_client3"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 10.0.3.101
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_stop"
        set command "
diag debug flow trace stop
diag debug flow filter clear
diag debug console time disable
diag debug disable"
    next
end

# "session without SYN" required for ADVPN on Hub
#
config system settings
    set tcp-session-without-syn enable
end

# Internet and OOB management interfaces

config system interface
    edit "Internet_1"
        set vdom "root"
        set mode static
        set ip 100.64.21.3 255.255.255.0
        set allowaccess ping
        set alias "Internet-1"
        set interface "port1"
        set vlanid 21
        set role wan
    next
    
    edit "Internet_2"
        set vdom "root"
        set mode static
        set ip 100.64.22.3 255.255.255.0
        set allowaccess ping
        set alias "Internet-2"
        set interface "port1"
        set vlanid 22
        set role wan
    next
    
    edit "MPLS"
        set vdom "root"
        set mode static
        set ip 10.0.24.3 255.255.255.0
        set allowaccess ping
        set alias "MPLS"
        set interface "port2"
        set vlanid 24
        set role wan
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip 10.3.0.1 255.255.255.0
        set allowaccess ping
        set alias "DC-LAN"
        set role lan
    next
    edit "lo-HC"
        set vdom "root"
        set ip 10.200.99.1 255.255.255.255
        set allowaccess ping
        set type loopback
        set role wan
    next
    
end

# FW addresses and groups

config firewall address
    edit "DC-LAN"
        set subnet 10.3.0.0 255.255.255.0
    next
    edit "lo-SDWAN-HC"
        set subnet 10.200.99.1 255.255.255.255
    next
    edit "W-DC1"
        set subnet 10.1.0.0 255.255.255.0
    next
    edit "W-DC2"
        set subnet 10.2.0.0 255.255.255.0
    next
    edit "E-DC3"
        set subnet 10.3.0.0 255.255.255.0
    next
    edit "Branches"
        set subnet 10.0.0.0 255.255.0.0
        set allow-routing enable
    next
    edit "Overlays"
        set subnet 10.200.0.0 255.252.0.0
        set allow-routing enable
    next
    edit "Overlay_W-DC1_EDGE_INET1"
        set subnet 10.201.1.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_W-DC1_EDGE_INET2"
        set subnet 10.202.1.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_W-DC1_EDGE_MPLS"
        set subnet 10.203.1.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_W-DC2_EDGE_INET1"
        set subnet 10.201.2.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_W-DC2_EDGE_INET2"
        set subnet 10.202.2.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_W-DC2_EDGE_MPLS"
        set subnet 10.203.2.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_E-DC3_EDGE_INET1"
        set subnet 10.201.3.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_E-DC3_EDGE_INET2"
        set subnet 10.202.3.0 255.255.255.0
        set allow-routing enable
    next
    edit "Overlay_E-DC3_EDGE_MPLS"
        set subnet 10.203.3.0 255.255.255.0
        set allow-routing enable
    next
end

config firewall addrgrp
    edit "DataCenters"
        set member "W-DC1" "W-DC2" "E-DC3"
        set allow-routing enable
    next
    edit "Corporate"
        set member "Branches" "DataCenters" "Overlays"
        set allow-routing enable
    next
end

# IPsec
#
# Edge tunnels to Branches in East Region
#

config vpn ipsec phase1-interface
    edit "EDGE_INET1"
        set type dynamic
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        set network-id 31
        set peertype any
        set net-device disable
        
        set add-route disable
        set mode-cfg enable
        set ipv4-start-ip 10.201.3.1
        set ipv4-end-ip 10.201.3.252
        set ipv4-netmask 255.255.255.0
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret 313131
    next
end

config vpn ipsec phase2-interface
    edit "EDGE_INET1"
        set phase1name "EDGE_INET1"
    next
end

config system interface
    edit "EDGE_INET1"
        set ip 10.201.3.254 255.255.255.255
        set remote-ip 10.201.3.253 255.255.255.0
        set allowaccess ping
    next
end


#

config vpn ipsec phase1-interface
    edit "EDGE_INET2"
        set type dynamic
        set interface "Internet_2"
        set ike-version 2
        set network-overlay enable
        set network-id 32
        set peertype any
        set net-device disable
        
        set add-route disable
        set mode-cfg enable
        set ipv4-start-ip 10.202.3.1
        set ipv4-end-ip 10.202.3.252
        set ipv4-netmask 255.255.255.0
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret 323232
    next
end

config vpn ipsec phase2-interface
    edit "EDGE_INET2"
        set phase1name "EDGE_INET2"
    next
end

config system interface
    edit "EDGE_INET2"
        set ip 10.202.3.254 255.255.255.255
        set remote-ip 10.202.3.253 255.255.255.0
        set allowaccess ping
    next
end

#

config vpn ipsec phase1-interface
    edit "EDGE_MPLS"
        set type dynamic
        set interface "MPLS"
        set ike-version 2
        set network-overlay enable
        set network-id 33
        set peertype any
        set net-device disable
        
        set add-route disable
        set mode-cfg enable
        set ipv4-start-ip 10.203.3.1
        set ipv4-end-ip 10.203.3.252
        set ipv4-netmask 255.255.255.0
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret 333333
    next
end

config vpn ipsec phase2-interface
    edit "EDGE_MPLS"
        set phase1name "EDGE_MPLS"
    next
end

config system interface
    edit "EDGE_MPLS"
        set ip 10.203.3.254 255.255.255.255
        set remote-ip 10.203.3.253 255.255.255.0
        set allowaccess ping
    next
end
#
# Inter-Region tunnels
#

##### EAST DC3 to WEST DC1 ######################

config vpn ipsec phase1-interface
    edit "W1E3_INET1"
        set type static
        set interface "Internet_1"
        set ike-version 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set auto-discovery-sender enable
            set auto-discovery-receiver enable
            set auto-discovery-forwarder enable
        
        
        set dpd on-idle
        set dpd-retrycount 2
        set dpd-retryinterval 10
        set suite-b suite-b-gcm-128
        set psksecret W1E3_INET1
        set remote-gw 100.64.11.1
        set comments "Tunnel between WEST DC1 and EAST DC3 over INET1"
    next
end

config vpn ipsec phase2-interface
    edit "W1E3_INET1"
        set phase1name "W1E3_INET1"
        set keepalive enable
    next
end


config system interface
    edit "W1E3_INET1"
        set ip 10.201.13.2 255.255.255.255
        set remote-ip 10.201.13.1 255.255.255.252
        set allowaccess ping
    next
end


config vpn ipsec phase1-interface
    edit "W1E3_INET2"
        set type static
        set interface "Internet_2"
        set ike-version 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set auto-discovery-sender enable
            set auto-discovery-receiver enable
            set auto-discovery-forwarder enable
        
        
        set dpd on-idle
        set dpd-retrycount 2
        set dpd-retryinterval 10
        set suite-b suite-b-gcm-128
        set psksecret W1E3_INET2
        set remote-gw 100.64.12.1
        set comments "Tunnel between WEST DC1 and EAST DC3 over INET2"
    next
end

config vpn ipsec phase2-interface
    edit "W1E3_INET2"
        set phase1name "W1E3_INET2"
        set keepalive enable
    next
end


config system interface
    edit "W1E3_INET2"
        set ip 10.202.13.2 255.255.255.255
        set remote-ip 10.202.13.1 255.255.255.252
        set allowaccess ping
    next
end


config vpn ipsec phase1-interface
    edit "W1E3_MPLS"
        set type static
        set interface "MPLS"
        set ike-version 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set auto-discovery-sender enable
            set auto-discovery-receiver enable
            set auto-discovery-forwarder enable
        
        
        set dpd on-idle
        set dpd-retrycount 2
        set dpd-retryinterval 10
        set suite-b suite-b-gcm-128
        set psksecret W1E3_MPLS
        set remote-gw 10.0.14.1
        set comments "Tunnel between WEST DC1 and EAST DC3 over MPLS"
    next
end

config vpn ipsec phase2-interface
    edit "W1E3_MPLS"
        set phase1name "W1E3_MPLS"
        set keepalive enable
    next
end


config system interface
    edit "W1E3_MPLS"
        set ip 10.203.13.2 255.255.255.255
        set remote-ip 10.203.13.1 255.255.255.252
        set allowaccess ping
    next
end



##### EAST DC3 to WEST DC2 ######################

config vpn ipsec phase1-interface
    edit "W2E3_INET1"
        set type static
        set interface "Internet_1"
        set ike-version 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set auto-discovery-sender enable
            set auto-discovery-receiver enable
            set auto-discovery-forwarder enable
        
        
        set dpd on-idle
        set dpd-retrycount 2
        set dpd-retryinterval 10
        set suite-b suite-b-gcm-128
        set psksecret W2E3_INET1
        set remote-gw 100.64.21.2
        set comments "Tunnel between WEST DC2 and EAST DC3 over INET1"
    next
end

config vpn ipsec phase2-interface
    edit "W2E3_INET1"
        set phase1name "W2E3_INET1"
        set keepalive enable
    next
end


config system interface
    edit "W2E3_INET1"
        set ip 10.201.23.2 255.255.255.255
        set remote-ip 10.201.23.1 255.255.255.252
        set allowaccess ping
    next
end


config vpn ipsec phase1-interface
    edit "W2E3_INET2"
        set type static
        set interface "Internet_2"
        set ike-version 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set auto-discovery-sender enable
            set auto-discovery-receiver enable
            set auto-discovery-forwarder enable
        
        
        set dpd on-idle
        set dpd-retrycount 2
        set dpd-retryinterval 10
        set suite-b suite-b-gcm-128
        set psksecret W2E3_INET2
        set remote-gw 100.64.22.2
        set comments "Tunnel between WEST DC2 and EAST DC3 over INET2"
    next
end

config vpn ipsec phase2-interface
    edit "W2E3_INET2"
        set phase1name "W2E3_INET2"
        set keepalive enable
    next
end


config system interface
    edit "W2E3_INET2"
        set ip 10.202.23.2 255.255.255.255
        set remote-ip 10.202.23.1 255.255.255.252
        set allowaccess ping
    next
end


config vpn ipsec phase1-interface
    edit "W2E3_MPLS"
        set type static
        set interface "MPLS"
        set ike-version 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set auto-discovery-sender enable
            set auto-discovery-receiver enable
            set auto-discovery-forwarder enable
        
        
        set dpd on-idle
        set dpd-retrycount 2
        set dpd-retryinterval 10
        set suite-b suite-b-gcm-128
        set psksecret W2E3_MPLS
        set remote-gw 10.0.24.2
        set comments "Tunnel between WEST DC2 and EAST DC3 over MPLS"
    next
end

config vpn ipsec phase2-interface
    edit "W2E3_MPLS"
        set phase1name "W2E3_MPLS"
        set keepalive enable
    next
end


config system interface
    edit "W2E3_MPLS"
        set ip 10.203.23.2 255.255.255.255
        set remote-ip 10.203.23.1 255.255.255.252
        set allowaccess ping
    next
end



# SD-WAN manual rules for ADVPN "domain" routing strategy (overlay stickiness)

# SD-WAN manual rules for ADVPN inter-region stickiness


config system sdwan
    set status enable
    config zone
        edit "internet"
        next
        edit "branches"
        next
        edit "inter-regions"
        next
    end
    config members
        edit 1
            set interface "EDGE_INET1"
            set zone "branches"
        next
        edit 2
            set interface "EDGE_INET2"
            set zone "branches"
        next
        edit 3
            set interface "EDGE_MPLS"
            set zone "branches"
        next
        edit 201
            set interface "Internet_1"
            set gateway 100.64.21.254
            set zone "internet"
        next
        edit 202
            set interface "Internet_2"
            set gateway 100.64.22.254
            set zone "internet"
        next
        edit 131
            set interface "W1E3_INET1"
            set zone "inter-regions"
        next
        edit 132
            set interface "W1E3_INET2"
            set zone "inter-regions"
        next
        edit 133
            set interface "W1E3_MPLS"
            set zone "inter-regions"
        next
        edit 231
            set interface "W2E3_INET1"
            set zone "inter-regions"
        next
        edit 232
            set interface "W2E3_INET2"
            set zone "inter-regions"
        next
        edit 233
            set interface "W2E3_MPLS"
            set zone "inter-regions"
        next
    end
    config service
        edit 1
            set name "ADVPN_for_EDGE_INET1"
            set input-device "EDGE_INET1"
            set src "all"
            set dst "all"
            set priority-members 1 2
        next
        edit 2
            set name "ADVPN_for_EDGE_INET2"
            set input-device "EDGE_INET2"
            set src "all"
            set dst "all"
            set priority-members 2 1
        next
        edit 3
            set name "ADVPN_for_EDGE_MPLS"
            set input-device "EDGE_MPLS"
            set src "all"
            set dst "all"
            set priority-members 3
        next
        edit 4
            set name "EDGE_INET1_to_WEST"
            set input-device "EDGE_INET1"
            set src "all"
            set dst "all"
            set priority-members 131 231
        next
        edit 5
            set name "EDGE_INET2_to_WEST"
            set input-device "EDGE_INET2"
            set src "all"
            set dst "all"
            set priority-members 132 232
        next
        edit 6
            set name "EDGE_MPLS_to_WEST"
            set input-device "EDGE_MPLS"
            set src "all"
            set dst "all"
            set priority-members 133 233
        next
        edit 7
            set name "WEST_to_EDGE_INET1"
            set input-device "W1E3_INET1" "W2E3_INET1"
            set src "all"
            set dst "all"
            set priority-members 1
        next
        edit 8
            set name "WEST_to_EDGE_INET2"
            set input-device "W1E3_INET2" "W2E3_INET2"
            set src "all"
            set dst "all"
            set priority-members 2
        next
        edit 9
            set name "WEST_to_EDGE_MPLS"
            set input-device "W1E3_MPLS" "W2E3_MPLS"
            set src "all"
            set dst "all"
            set priority-members 3
        next
    end
end

# FW Policies
# no IPS profile is applied because IPS process did not start correctly when mixing AppCtrl + IPS profiles

config firewall policy
    edit 1
        set name "Deny Internet"
        set srcintf "port5"
        set dstintf "internet"
        set srcaddr "RFC1918-private-subnets"
        set dstaddr "RFC1918-private-subnets"
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Good practice FW rule"
    next
    edit 2
        set name "Internet"
        set srcintf "port5"
        set dstintf "internet"
        set srcaddr "DC-LAN"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set nat enable
    next

    edit 5
        set name "VPN -> Internet (RIA)"
        set srcintf "branches"
        set dstintf "internet"
        set srcaddr "Corporate"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set comments "Remote Internet Breakout for Branches"
        set nat enable
    next

    edit 3
        set name "VPN -> DC"
        set srcintf "branches"
        set dstintf "port5" "lo-HC"
        set srcaddr "Corporate"
        set dstaddr "DC-LAN" "lo-SDWAN-HC"
        set action accept
        set schedule "always"
        set service "ALL"
        set logtraffic all
    next
    edit 4
        set name "VPN <-> VPN"
        set srcintf "branches" "inter-regions"
        
            set dstintf "branches" "inter-regions"
        
        set srcaddr "Corporate"
        set dstaddr "Corporate"
        set action accept
        set schedule "always"
        set service "ALL"

            set anti-replay disable
            set tcp-session-without-syn all

        set logtraffic all
    next
end

## Routing


    
# CONTEXT:
# - FOS >= 7.0
# - Cross-region shortcuts are possible
#
# BR3 must receive each of the 6 BGP NH of BR1/BR2
# DC3 must receive each of the 6 BGP NH of BR1/BR2 (for cross-region edge-to-DC shortcut)
#
# Solution:
# - BGP NH are preserved using eBGP with 'next-hop-unchanged' for cross-region peerings
# - eBGP is possible since eBGP Add-Path is available as of 7.0
# - one BGP peering per inter-region overlay (3 BGP peerings for DC1/DC2 to DC3, 6 BGP peerings for DC3 to DC1/DC2)
# - advertise overlay subnets via BGP since BGP NH recursion via BGP is available as of 7.0

#
# Prefix lists
#

# BGP next-hops for INET1, INET2, MPLS tunnels

config router prefix-list
    edit "PFL_NH_INET1"
        config rule
            edit 1
                set prefix 10.201.0.0 255.255.0.0
                set ge 32
                set le 32
            next
        end
    next
    edit "PFL_NH_INET2"
        config rule
            edit 1
                set prefix 10.202.0.0 255.255.0.0
                set ge 32
                set le 32
            next
        end
    next
    edit "PFL_NH_MPLS"
        config rule
            edit 1
                set prefix 10.203.0.0 255.255.0.0
                set ge 32
                set le 32
            next
        end
    next
end

# Overlay subnets of INET1, INET2, MPLS tunnels

config router prefix-list
    edit "PFL_OL_INET1"
        config rule
            edit 1
                set prefix 10.201.0.0 255.255.0.0
                unset ge
                set le 30
            next
        end
    next
    edit "PFL_OL_INET2"
        config rule
            edit 1
                set prefix 10.202.0.0 255.255.0.0
                unset ge
                set le 30
            next
        end
    next
    edit "PFL_OL_MPLS"
        config rule
            edit 1
                set prefix 10.203.0.0 255.255.0.0
                unset ge
                set le 30
            next
        end
    next
end

# All possible overlay subnets (any subnet component of overlay summary 10.200.0.0/14)

config router prefix-list
    edit "PFL_OL"
        config rule
            edit 1
                set prefix 10.200.0.0 255.252.0.0
                unset ge
                set le 32
            next
        end
    next
end

# Overlay aggregates announced by DCs for recursive BGP NH resolution

config router prefix-list
    edit "PFL_OL_SUMMARY"
        config rule
            edit 1
                set prefix 10.200.0.0 255.252.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PFL_OL_SUMMARY_INET1"
        config rule
            edit 1
                set prefix 10.201.0.0 255.255.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PFL_OL_SUMMARY_INET2"
        config rule
            edit 1
                set prefix 10.202.0.0 255.255.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PFL_OL_SUMMARY_MPLS"
        config rule
            edit 1
                set prefix 10.203.0.0 255.255.0.0
                unset ge
                unset le
            next
        end
    next
    edit "PFL_OL_SUMMARY_GROUP"
        config rule
            edit 1
                set prefix 10.200.0.0 255.252.0.0
                unset ge
                unset le
            next
            edit 2
                set prefix 10.201.0.0 255.255.0.0
                unset ge
                unset le
            next
            edit 3
                set prefix 10.202.0.0 255.255.0.0
                unset ge
                unset le
            next
            edit 4
                set prefix 10.203.0.0 255.255.0.0
                unset ge
                unset le
            next
        end
    next
end

# Route-maps
#

# INTER-REGION
# ============
# Overlay stickiness is done for inter-region advertisement
# Example:
# When DC1 sends prefixes to DC3 over overlay INET1 (W1E3_INET1), it must send:
# - prefixes from edges with a next-hop belonging to overlay INET1 (a /32 within 10.201.0.0/16) -- "match-ip-nexthop"
# - the overlay prefix of EDGE_INET1 (10.201.1.0/24) -- "match-ip-address" (required for BR1/BR2 to DC3 shortcuts)
# - DC1 prefix (10.1.0.0/24) -- tagged as '666' by route-map RM_LOCAL_TAG when injected into the BGP table with the 'network' command
# - filter any aggregate locally generated (10.200.0.0/14, 10.201|202|203.0.0/16) from being sent to other region
#
# On DC1, prefixes sent to DC3 via overlay INET1 (W1E3_INET1) looks like this:
#
# FGT-W-DC1 # get router info bgp neighbors 10.201.13.2 adv
# VRF 0 BGP table version is 18, local router ID is 10.1.0.1
# Status codes: s suppressed, d damped, h history, * valid, > best, i - internal
# Origin codes: i - IGP, e - EGP, ? - incomplete
#
#    Network          Next Hop            Metric LocPrf Weight RouteTag Path
# *>i10.0.1.0/24      10.201.1.2                    100      0        0 i <0/1>
# *>i10.0.2.0/24      10.201.1.1                    100      0        0 i <0/1>
# *>i10.201.0.0/16    10.201.13.1                   100  32768        0 i <0/1>
#

config router route-map
    edit "RM_LOCAL_TAG"
        config rule
            edit 1
                set set-tag 666
            next
        end
    next
    edit "RM_REGION_INET1_OUT"
        config rule
            edit 1
                set match-ip-nexthop "PFL_NH_INET1"
            next
            edit 2
                set action deny
                set match-ip-address "PFL_OL_SUMMARY_GROUP"
            next
            edit 3
                set match-ip-address "PFL_OL_INET1"
            next
            edit 4
                set match-tag 666
            next
        end
    next
    edit "RM_REGION_INET2_OUT"
        config rule
            edit 1
                set match-ip-nexthop "PFL_NH_INET2"
            next
            edit 2
                set action deny
                set match-ip-address "PFL_OL_SUMMARY_GROUP"
            next
            edit 3
                set match-ip-address "PFL_OL_INET2"
            next
            edit 4
                set match-tag 666
            next
        end
    next
    edit "RM_REGION_MPLS_OUT"
        config rule
            edit 1
                set match-ip-nexthop "PFL_NH_MPLS"
            next
            edit 2
                set action deny
                set match-ip-address "PFL_OL_SUMMARY_GROUP"
            next
            edit 3
                set match-ip-address "PFL_OL_MPLS"
            next
            edit 4
                set match-tag 666
            next
        end
    next
end

# EDGE
# =====
# DCs advertise:
# - the overlay aggregate (PFL_OL_SUMMARY 10.200.0.0/14) to the edges over all overlays (INET1/INET2/MPLS) for cross-overlay BGP NH reachability
# - INET1 overlay aggregate (PFL_OL_SUMMARY_INET1 10.201.0.0/16) only over INET1 overlay for cross-region BGP NH reachability
# - INET2 overlay aggregate (PFL_OL_SUMMARY_INET2 10.202.0.0/16) only over INET2 overlay for cross-region BGP NH reachability
# - MPLS overlay aggregate (PFL_OL_SUMMARY_MPLS 10.203.0.0/16) only over MPLS overlay for cross-region BGP NH reachability
# All over overlays (subnet components of 10.200.0.0/14 - PFL_OL) are filtered
#
# The edge devices can build shortcuts to edges other same or other region but they can also establish shortcuts
# with DCs of other region. That's why BGP NH for all edges and all DCs must be preserved.
#
# For e.g., on FGT-W-BR1 cross-overlay/cross-region BGP NH reachability routes look like this:
#
# B       10.200.0.0/14 [200/0] via 10.201.1.254 (recursive via H1_INET1 tunnel 100.64.11.1), 00:08:26
#                       [200/0] via 10.202.1.254 (recursive via H1_INET2 tunnel 100.64.12.1), 00:08:26
#                       [200/0] via 10.203.1.254 (recursive via H1_MPLS tunnel 10.0.14.1), 00:08:26
#                       [200/0] via 10.201.2.254 (recursive via H2_INET1 tunnel 100.64.21.2), 00:08:26
#                       [200/0] via 10.202.2.254 (recursive via H2_INET2 tunnel 100.64.22.2), 00:08:26
#                       [200/0] via 10.203.2.254 (recursive via H2_MPLS tunnel 10.0.24.2), 00:08:26
# B       10.201.0.0/16 [200/0] via 10.201.1.254 (recursive via H1_INET1 tunnel 100.64.11.1), 00:08:26
#                       [200/0] via 10.201.2.254 (recursive via H2_INET1 tunnel 100.64.21.2), 00:08:26
# B       10.202.0.0/16 [200/0] via 10.202.1.254 (recursive via H1_INET2 tunnel 100.64.12.1), 00:08:26
#                       [200/0] via 10.202.2.254 (recursive via H2_INET2 tunnel 100.64.22.2), 00:08:26
# B       10.203.0.0/16 [200/0] via 10.203.1.254 (recursive via H1_MPLS tunnel 10.0.14.1), 00:08:26
#                       [200/0] via 10.203.2.254 (recursive via H2_MPLS tunnel 10.0.24.2), 00:08:26
#
# This is what we had in 6.4 by using static routes configured on the branches themselves.

config router route-map
    edit "RM_EDGE_INET1_OUT"
        config rule
            edit 1
                set match-ip-address "PFL_OL_SUMMARY"
            next
            edit 2
                set match-ip-address "PFL_OL_SUMMARY_INET1"
            next
            edit 3
                set action deny
                set match-ip-address "PFL_OL"
            next
            edit 4
            next
        end
    next
    edit "RM_EDGE_INET2_OUT"
        config rule
            edit 1
                set match-ip-address "PFL_OL_SUMMARY"
            next
            edit 2
                set match-ip-address "PFL_OL_SUMMARY_INET2"
            next
            edit 3
                set action deny
                set match-ip-address "PFL_OL"
            next
            edit 4
            next
        end
    next
    edit "RM_EDGE_MPLS_OUT"
        config rule
            edit 1
                set match-ip-address "PFL_OL_SUMMARY"
            next
            edit 2
                set match-ip-address "PFL_OL_SUMMARY_MPLS"
            next
            edit 3
                set action deny
                set match-ip-address "PFL_OL"
            next
            edit 4
            next
        end
    next
end
    
# BGP peerings

# "additional-path-select 6" because
# - each Branch advertise its subnet with up to 3 different BGP NH
# - but there are 6 overlays with DC1/DC2: 6 different BGP NH can be received from BR1/BR2 via DC1/DC2
# The 6 BGP NH of BR1/BR2 must be sent to BR3 via each overlay. Hence "set adv-additional-path 6" for the edge peering




config router bgp
    set as 65003
    set router-id 10.3.0.1
    set ibgp-multipath enable
    set ebgp-multipath enable
    set additional-path enable

    set additional-path-select 6

    set keepalive-timer 10
    set holdtime-timer 30

    set recursive-next-hop enable
    config aggregate-address
        edit 1
            set prefix 10.201.0.0 255.255.0.0
            set summary-only disable
        next
        edit 2
            set prefix 10.202.0.0 255.255.0.0
            set summary-only disable
        next
        edit 3
            set prefix 10.203.0.0 255.255.0.0
            set summary-only disable
        next
        edit 4
            set prefix 10.200.0.0 255.252.0.0
            set summary-only disable
        next
    end

    config neighbor
        edit "10.201.13.1"
            set interface "W1E3_INET1"
            set remote-as 65012
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET1_OUT"
        next
        edit "10.202.13.1"
            set interface "W1E3_INET2"
            set remote-as 65012
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET2_OUT"
        next
        edit "10.203.13.1"
            set interface "W1E3_MPLS"
            set remote-as 65012
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_MPLS_OUT"
        next
        edit "10.201.23.1"
            set interface "W2E3_INET1"
            set remote-as 65012
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET1_OUT"
        next
        edit "10.202.23.1"
            set interface "W2E3_INET2"
            set remote-as 65012
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET2_OUT"
        next
        edit "10.203.23.1"
            set interface "W2E3_MPLS"
            set remote-as 65012
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_MPLS_OUT"
        next
    end
    config neighbor-group
        edit "EDGE_INET1"
            set interface "EDGE_INET1"
            set update-source "EDGE_INET1"
            set remote-as 65003
            set additional-path send

            set adv-additional-path 6

            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable

            set route-map-out "RM_EDGE_INET1_OUT"
        next
        edit "EDGE_INET2"
            set interface "EDGE_INET2"
            set update-source "EDGE_INET2"
            set remote-as 65003
            set additional-path send

            set adv-additional-path 6

            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable

            set route-map-out "RM_EDGE_INET2_OUT"
        next
        edit "EDGE_MPLS"
            set interface "EDGE_MPLS"
            set update-source "EDGE_MPLS"
            set remote-as 65003
            set additional-path send

            set adv-additional-path 6

            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable

            set route-map-out "RM_EDGE_MPLS_OUT"
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.201.3.0 255.255.255.0
            set neighbor-group "EDGE_INET1"
        next
        edit 2
            set prefix 10.202.3.0 255.255.255.0
            set neighbor-group "EDGE_INET2"
        next
        edit 3
            set prefix 10.203.3.0 255.255.255.0
            set neighbor-group "EDGE_MPLS"
        next
    end
    config network
        edit 1
            set prefix 10.3.0.0 255.255.255.0
            set route-map "RM_LOCAL_TAG"
        next
        edit 2
            set prefix 10.201.3.0 255.255.255.0
        next
        edit 3
            set prefix 10.202.3.0 255.255.255.0
        next
        edit 4
            set prefix 10.203.3.0 255.255.255.0
        next
    end
end

#
# BGP routes
#

# FGT-E-DC3 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.1.0/24 [200/0] via 10.201.1.1 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:32:33
#                     [200/0] via 10.201.2.1 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:32:33
#                     [200/0] via 10.202.1.1 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:32:33
#                     [200/0] via 10.202.2.1 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:32:33
#                     [200/0] via 10.203.1.1 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:32:33
#                     [200/0] via 10.203.2.1 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:32:33
# B       10.0.2.0/24 [200/0] via 10.201.1.2 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:32:33
#                     [200/0] via 10.201.2.2 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:32:33
#                     [200/0] via 10.202.1.2 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:32:33
#                     [200/0] via 10.202.2.2 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:32:33
#                     [200/0] via 10.203.1.2 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:32:33
#                     [200/0] via 10.203.2.2 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:32:33
# B       10.0.3.0/24 [200/0] via 10.201.3.1 (recursive via EDGE_INET1 tunnel 10.201.3.1), 00:33:20
#                     [200/0] via 10.202.3.1 (recursive via EDGE_INET2 tunnel 10.202.3.1), 00:33:20
#                     [200/0] via 10.203.3.1 (recursive via EDGE_MPLS tunnel 10.203.3.1), 00:33:20
# B       10.1.0.0/24 [200/0] via 10.201.13.1 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:33:20
#                     [200/0] via 10.202.13.1 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:33:20
#                     [200/0] via 10.203.13.1 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:33:20
# B       10.2.0.0/24 [200/0] via 10.201.23.1 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:33:22
#                     [200/0] via 10.202.23.1 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:33:22
#                     [200/0] via 10.203.23.1 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:33:22
# B       10.200.0.0/14 [200/0] is a summary, Null, 00:33:25
# B       10.201.0.0/16 [200/0] is a summary, Null, 00:33:25
# B       10.201.1.0/24 [200/0] via 10.201.13.1 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:33:25
# B       10.201.2.0/24 [200/0] via 10.201.23.1 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:33:22
# B       10.202.0.0/16 [200/0] is a summary, Null, 00:33:25
# B       10.202.1.0/24 [200/0] via 10.202.13.1 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:33:23
# B       10.202.2.0/24 [200/0] via 10.202.23.1 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:33:25
# B       10.203.0.0/16 [200/0] is a summary, Null, 00:33:25
# B       10.203.1.0/24 [200/0] via 10.203.13.1 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:33:20
# B       10.203.2.0/24 [200/0] via 10.203.23.1 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:33:25









# Static default-routes


config router static
    edit 1
        set sdwan-zone "internet"
        set comment "Default-route via Internet links"
    next
end



# MPLS underlay
config router static
    edit 3
        set dstaddr "MPLS_Underlay"
        set device "MPLS"
        set gateway 10.0.24.254
        set comment "MPLS underlay"
    next
end




