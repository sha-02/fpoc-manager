# fpoc05 FGT-SDW-2 FortiOS 7.0.3
# context = {'i': 2, 'overlay': 'modecfg', 'duplicate_paths': 'keep_duplicates', 'override_with_hub_nexthop': False, 'feasible_routes': 'remote_internet_mpls', 'hub_inet1': '100.64.11.3', 'hub_inet2': '100.64.12.3', 'hub_lte': '100.64.11.3', 'hub_mpls': '10.0.14.3', 'name': 'FGT-SDW-2', 'fos_version': '7.0.3', 'FOS': 7000003, 'mgmt_fpoc': '172.16.31.254', 'HA': FortiGate_HA(mode=<Modes.STANDALONE: 0>, role=<Roles.STANDALONE: 0>, group_id=None, group_name=None, hbdev=None, sessyncdev=None, monitordev=None, priority=None), 'wan': WAN(inet=WanSettings(port='port1', vlanid=0, subnet='192.0.2'), inet_snat=WanSettings(port='port1', vlanid=200, subnet='192.168.200'), inet_dnat=WanSettings(port='port1', vlanid=201, subnet='192.168.201'), inet1=WanSettings(port='port1', vlanid=31, subnet='100.64.31'), inet1_snat=WanSettings(port='port1', vlanid=210, subnet='192.168.210'), inet1_dnat=WanSettings(port='port1', vlanid=211, subnet='192.168.211'), inet2=WanSettings(port='port1', vlanid=32, subnet='100.64.32'), inet2_snat=WanSettings(port='port1', vlanid=220, subnet='192.168.220'), inet2_dnat=WanSettings(port='port1', vlanid=221, subnet='192.168.221'), inet3=WanSettings(port='port1', vlanid=33, subnet='100.64.33'), inet3_snat=WanSettings(port='port1', vlanid=230, subnet='192.168.230'), inet3_dnat=WanSettings(port='port1', vlanid=231, subnet='192.168.231'), mpls1=WanSettings(port='port2', vlanid=34, subnet='10.0.34'), mpls2=WanSettings(port='port2', vlanid=35, subnet='10.0.35')), 'request': <WSGIRequest: POST '/poc/5/'>, 'csrf_input': '<input type="hidden" name="csrfmiddlewaretoken" value="b9PvObHrmLfwBKo8qJLTvNz1brUb6r2o0z7k3EKmjWRWHUT0Ev74lGeBRFG5ZwuY">', 'csrf_token': 'XKiCjaWRWRevWepdcc6sMOUAdZhCWCHZMaAryDZMT2QV2oU5qYsDCHzaTd3wPH9z'}
#
##################################################



config system global
    set hostname FGT-SDW-2
    
        set gui-theme mariner
    
end

config system alias
    edit "sniff_client11"
        set command "diagnose sniffer packet any \'host 192.168.1.11\' 4"
    next
    edit "sniff_client22"
        set command "diagnose sniffer packet any \'host 192.168.2.22\' 4"
    next
    edit "flow_client11"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 192.168.1.11
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_client22"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 192.168.2.22
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_stop"
        set command "
diag debug flow trace stop
diag debug flow filter clear
diag debug console time disable
diag debug disable"
    next
end


# location-id is sent by branch to Hub during IKEv2 AUTH
# Use case: there are multiple IPsec tunnels from Branch terminated on the same dialup phase1-interface on Hub
# Hub's behavior:
# - all tunnels connecting to the same phase1-interface are grouped together if they have the same location-id.
# - In order to reply symmetrically, original incoming tunnel is cached in session.
# - For outgoing traffic, FOS does not necessarily use the tunnel returned by the routing lookup to send.
#   Instead, FOS tries to pick original incoming tunnel from the group to send.
#
# There is no real need for location-id in this PoC since no branch terminates multiple tunnels to the same phase1
# on the Hub. But I've configured location-id in a some kind of "provisioning" or "don't forget the feature" idea
# Here, I'm using the BGP RID as location-id
config system settings
    set location-id 192.168.2.2
end


# Internet and OOB management interfaces

config system interface
    edit "Internet_1"
        set vdom "root"
        set mode static
        set ip 100.64.31.2 255.255.255.0
        set allowaccess ping
        set alias "Internet-1"
        set interface "port1"
        set vlanid 31
        set role wan
    next
    edit "Internet_1_SNAT"
        set vdom "root"
        set mode static
        set ip 192.168.210.2 255.255.255.0
        set allowaccess ping
        set description "INET1 private IP for PAT/SNAT"
        set alias "Inet SNAT 100.64.31.210"
        set interface "port1"
        set vlanid 210
        set status down
    next
    edit "Internet_2"
        set vdom "root"
        set mode static
        set ip 100.64.32.2 255.255.255.0
        set allowaccess ping
        set alias "Internet-2"
        set interface "port1"
        set vlanid 32
        set role wan
    next
    edit "Internet_2_SNAT"
        set vdom "root"
        set mode static
        set ip 192.168.220.2 255.255.255.0
        set allowaccess ping
        set description "INET2 private IP for PAT/SNAT"
        set alias "Inet SNAT 100.64.32.220"
        set interface "port1"
        set vlanid 220
        set status down
    next
    edit "LTE"
        set vdom "root"
        set mode static
        set ip 100.64.33.2 255.255.255.0
        set allowaccess ping
        set alias "LTE"
        set interface "port1"
        set vlanid 33
        set role wan
    next
    edit "MPLS"
        set vdom "root"
        set mode static
        set ip 10.0.34.2 255.255.255.0
        set allowaccess ping
        set alias "MPLS"
        set interface "port2"
        set vlanid 34
        set role wan
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip 192.168.2.2 255.255.255.0
        set allowaccess ping
        set alias "LAN"
        set role lan
    next
end


# FW addresses and groups

config firewall address
    edit "LAN"
        set subnet 192.168.2.0 255.255.255.0
    next
    edit "DataCenter"
        set subnet 192.168.3.0 255.255.255.0
    next
    edit "Corporate_LANs"
        set subnet 192.168.0.0 255.255.0.0
        set allow-routing enable
    next
    edit "Overlay_summary"
        set subnet 10.255.0.0 255.255.0.0
        set allow-routing enable
    next
    edit "MPLS_interco_summary"
        set subnet 10.0.0.0 255.255.0.0
        set allow-routing enable
    next
end

config firewall addrgrp
    edit "Corporate_subnets"
        set member "Corporate_LANs" "Overlay_summary"
        set allow-routing enable
    next
end

# IPsec

# ADVPN1 over Internet-1 - overlay subnet 10.255.1.0/24
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd optimized for Lab purpose

config vpn ipsec phase1-interface
    edit "advpn1"
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        set network-id 1
        set peertype any
        set localid "FGT-SDW-2_advpn1"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        
            set mode-cfg enable
        
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw 100.64.11.3
        set psksecret advpn1
    next
end

config vpn ipsec phase2-interface
    edit "advpn1"
        set phase1name "advpn1"
    next
end

config system interface
    edit "advpn1"
        
        set allowaccess ping
    next
end


# ADVPN2 over Internet-2 - overlay subnet 10.255.2.0/24
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd optimized for Lab purpose

config vpn ipsec phase1-interface
    edit "advpn2"
        set interface "Internet_2"
        set ike-version 2
        set network-overlay enable
        set network-id 2
        set peertype any
        set localid "FGT-SDW-2_advpn2"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        
            set mode-cfg enable
        
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw 100.64.12.3
        set psksecret advpn2
    next
end

config vpn ipsec phase2-interface
    edit "advpn2"
        set phase1name "advpn2"
    next
end

config system interface
    edit "advpn2"
        
        set allowaccess ping
    next
end


# ADVPN3 over LTE - overlay subnet 10.255.3.0/24
# remote-gw is the IP of port1 (Internet-1) on FGT-DC
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd-ondemand + interval 60 sec bcse LTE link

config vpn ipsec phase1-interface
    edit "advpn3"
        set interface "LTE"
        set ike-version 2
        set network-overlay enable
        set network-id 3
        set peertype any
        set localid "FGT-SDW-2_advpn3"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        
            set mode-cfg enable
        
        set dpd on-demand
        set dpd-retryinterval 60
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw 100.64.11.3
        set psksecret advpn3
    next
end

config vpn ipsec phase2-interface
    edit "advpn3"
        set phase1name "advpn3"
    next
end

config system interface
    edit "advpn3"
        
        set allowaccess ping
    next
end

# ADVPN4 over MPLS - overlay subnet 10.255.4.0/24
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd optimized for Lab purpose

config vpn ipsec phase1-interface
    edit "advpn4"
        set interface "MPLS"
        set ike-version 2
        set network-overlay enable
        set network-id 4
        set peertype any
        set localid "FGT-SDW-2_advpn4"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        
            set mode-cfg enable
        
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw 10.0.14.3
        set psksecret advpn4
    next
end

config vpn ipsec phase2-interface
    edit "advpn4"
        set phase1name "advpn4"
    next
end

config system interface
    edit "advpn4"
        
        set allowaccess ping
    next
end




# SD-WAN




# 'set hold-down-time 20' to prevent falling back to most-preferred shortcut before measuring its quality
#

# FOS 7.0+
# 'set tie-break fib-best-match' to select path with best-route to another shortcut instead of
# going back to feasible routes via Hub


config system sdwan
    set status enable
    config zone
        edit "internet"
        next
        edit "mpls"
        next
        edit "overlay"
        next
    end
    config members
        edit 1
            set interface "advpn1"
            set zone "overlay"
            
            set priority 35
        next
        edit 2
            set interface "advpn2"
            set zone "overlay"
            
            set priority 35
        next
        edit 3
            set interface "advpn3"
            set zone "overlay"
            
            set priority 35
        next
        edit 4
            set interface "advpn4"
            set zone "overlay"
            
            set priority 30
        next
        edit 201
            set interface "Internet_1"
            set zone "internet"
            set gateway 100.64.31.254
            set priority 10
        next
        edit 202
            set interface "Internet_2"
            set zone "internet"
            set gateway 100.64.32.254
            set priority 10
        next
        edit 203
            set interface "LTE"
            set zone "internet"
            set gateway 100.64.33.254
            set priority 20
        next
        edit 204
            set interface "MPLS"
            set zone "mpls"
            set gateway 10.0.34.254
            set priority 40
        next
    end






    config health-check
        edit "SLA_DC"
            set server "192.168.3.4"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 1 2 3 4
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_advpn1"
            set server "10.255.1.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 1
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_advpn2"
            set server "10.255.2.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 2
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_advpn3"
            set server "10.255.3.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 3
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_advpn4"
            set server "10.255.4.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 4
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_Internet"
            set server "198.18.8.8"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            
            
                set members 201 202 203 4
            
            
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
                edit 2
                    set link-cost-factor latency
                    set latency-threshold 300
                next
            end
        next
        edit "SLA_inet1"
            set server "100.64.31.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 201
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_inet2"
            set server "100.64.32.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 202
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_lte"
            set server "100.64.33.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 203
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
        edit "SLA_mpls"
            set server "10.0.34.254"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 204
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
    end
    config service
        edit 1
            set name "Corporate_SSH"
            set mode priority
            set src "LAN"
                set hold-down-time 20
            
                set tie-break fib-best-match
            
            set internet-service enable
            set internet-service-app-ctrl 16060
            set health-check "SLA_DC"
            set priority-members 1 2
        next
        edit 2
            set name "Corporate_PING"
            set mode sla
            set src "LAN"
                set hold-down-time 20
            
                set tie-break fib-best-match
            
            set internet-service enable
            set internet-service-app-ctrl 24466
            set hold-down-time 20
            config sla
                edit "SLA_DC"
                    set id 1
                next
            end
            set priority-members 2 1
        next
        edit 3
            set name "Corporate"
            set mode sla
            set dst "Corporate_LANs"
            set src "LAN"
                set hold-down-time 20
            
                set tie-break fib-best-match
            
            config sla
                edit "SLA_DC"
                    set id 1
                next
            end
            set priority-members 1 2 3 4
        next
        edit 4
            set name "Internet_HighPriority"
            set mode sla
            set src "LAN"
            set internet-service enable
            set internet-service-app-ctrl 16354 16920
            config sla
                edit "SLA_Internet"
                    set id 1
                next
            end
            
            
                set priority-members 201 202 4 203
            
            
        next
        edit 5
            set name "Internet_MedPriority"
            set mode sla
            set src "LAN"
            set internet-service enable
            set internet-service-app-ctrl 33182 41468
            config sla
                edit "SLA_Internet"
                    set id 2
                next
            end
            
            
                set priority-members 201 202 4
            
            
        next
        edit 6
            set name "Internet"
            set mode sla
            set dst "all"
            set src "LAN"
            config sla
                edit "SLA_Internet"
                    set id 2
                next
            end
            set priority-members 202 201
        next
    end
end

# SD-WAN rules for Overlay:
# ------------------------
# rules 1 and 2 leverages AppCtrl routing while rule 3 has no AppCtrl
# during learning phase, rule 1 and 2 cannot be matched which means learning traffic hits rule 3 and can get sent out members "1 2 3 4" depending on SLA conditions
# learning traffic will hit firewall policy 3 (Corporate Out) which has AppCtrl enabled and therefore allows to populate 5-tuple for appctrl isdb cache
#
# SD-WAN rules for Internet underlay:
# ----------------------------------
# rules 4 and 5 leverage AppCtrl routing while rule 6 has no AppCtrl
# during learning phase, rule 4 and 5 cannot be matched which means learning traffic hits rule 6 and can get sent out members "202 201" depending on SLA conditions
# learning traffic will hit firewall policy 2 (Internet DIA) which has AppCtrl enabled and therefore allows to populate 5-tuple for appctrl isdb cache
# subsequent traffic to dstip-dport in appctrl cache can hit sdwan rules 4 or 5 and can be sent out members "201 202 203 4" depending on SLA conditions
# and can be allowed by firewall policies 2 (Internet DIA) or 5 (Internet RIA)
#
# There is no need to have AppCtrl enabled in firewall policy 5 (Internet RIA) because if all DIA Internet links
# go down: only advpn4 (overlay MPLS) can be used to access Internet
# Since there is a single MPLS overlay, Internet traffic goes over it, there is no sdwan choice to be made
# If there were two MPLS overlays with an order ot preference in sdwan rules 4/5 (eg, advpn4 preferred over advpn5)
# then appctrl would be needed in RIA FW policy.
#
# If advpn104 (member 4) which is used for RIA was configured in sdwan rule 6 then learning traffic could go out member 4 and could hit RIA policy 5
# In such case, AppCtrl would need to be enabled firewall policy 5 (Internet RIA) to populate appctrl cache
#
# A rule of thumb could be: Enable AppCtrl on all FW policies which have egress interfaces that leverage AppCtrl routing at sdwan layer.

# FW Policies
# no IPS profile is applied because IPS process did not start correctly when mixing AppCtrl + IPS profiles

config firewall policy
    edit 1
        set name "Deny Internet"
        set srcintf "port5"
         
            set dstintf "internet"
        
        set srcaddr "RFC1918-private-subnets"
        set dstaddr "RFC1918-private-subnets"
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Good practice FW rule"
    next
    edit 2
        set name "Internet (DIA)"
        set srcintf "port5"
         
            set dstintf "internet"
        
        set srcaddr "LAN"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set nat enable
    next
    edit 3
        set name "Corporate Out"
        set srcintf "port5"
         
            set dstintf "overlay"
        
        set srcaddr "LAN"
        set dstaddr "Corporate_subnets"
        set action accept
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set application-list "default"
        set schedule "always"
        set service "ALL"
        set logtraffic all
    next

    edit 5
        set name "Internet (RIA)"
        set srcintf "port5"
         
            set dstintf "overlay"
        
        set srcaddr "LAN"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Remote Internet Breakout - no NAT"
    next

    edit 4
        set name "Corporate In"
         
            set srcintf "overlay"
        
        set dstintf "port5"
        set srcaddr "Corporate_subnets"
        set dstaddr "LAN"
        set action accept
        set schedule "always"
        set service "ALL"
        set logtraffic all
    next
end




## Routing


# Static default-routes

    
    config router static
        edit 1
            set sdwan-zone "internet" "overlay"
            set comment "Default-route via Internet and all overlays"
        next
    end
    
    
    






# MPLS underlay
config router static
    edit 4
        set dstaddr "MPLS_interco_summary"
        set device "MPLS"
        set gateway 10.0.34.254
        set comment "interco subnets of MPLS underlay"
    next
end








# BGP peerings over VPN overlays
# 'set interface' only taken into account for ipv4 as of 6.4/6.2.4 (0611900)
# default BGP timers (1min/3min) for advpn3 (LTE overlay)

config router bgp
    set as 65000
    set router-id 192.168.2.2
    set keepalive-timer 10
    set holdtime-timer 30
    set ibgp-multipath enable
    
    
        set recursive-next-hop enable
    
    config neighbor
        edit "10.255.1.254"
            set interface "advpn1"
            set remote-as 65000
            set additional-path receive
            set connect-timer 1
            set advertisement-interval 1
            set link-down-failover enable
            
        next
        edit "10.255.2.254"
            set interface "advpn2"
            set remote-as 65000
            set additional-path receive
            set connect-timer 1
            set advertisement-interval 1
            set link-down-failover enable
            
        next
        edit "10.255.3.254"
            set interface "advpn3"
            set remote-as 65000
            set additional-path receive
            set keep-alive-timer 60
            set holdtime-timer 180
            set connect-timer 1
            set advertisement-interval 1
            set link-down-failover enable
            
        next
        edit "10.255.4.254"
            set interface "advpn4"
            set remote-as 65000
            set additional-path receive
            set connect-timer 1
            set advertisement-interval 1
            set link-down-failover enable
            
        next
    end
    config network
        edit 1
            set prefix 192.168.2.0 255.255.255.0
        next
    end
end








