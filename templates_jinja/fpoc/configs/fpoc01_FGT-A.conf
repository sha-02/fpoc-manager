# fpoc01 FGT-A FortiOS 7.0.3
# context = {'i': 1, 'overlay': '10.255', 'hub': '100.64.31.1', 'name': 'FGT-A', 'fos_version': '7.0.3', 'FOS': 7000003, 'mgmt_fpoc': '172.16.31.254', 'HA': FortiGate_HA(mode=<Modes.STANDALONE: 0>, role=<Roles.STANDALONE: 0>, group_id=None, group_name=None, hbdev=None, sessyncdev=None, monitordev=None, priority=None), 'wan': WAN(inet=WanSettings(port='port1', vlanid=0, subnet='198.51.100'), inet_snat=WanSettings(port='port1', vlanid=200, subnet='192.168.200'), inet_dnat=WanSettings(port='port1', vlanid=201, subnet='192.168.201'), inet1=WanSettings(port='port1', vlanid=11, subnet='100.64.11'), inet1_snat=WanSettings(port='port1', vlanid=210, subnet='192.168.210'), inet1_dnat=WanSettings(port='port1', vlanid=211, subnet='192.168.211'), inet2=WanSettings(port='port1', vlanid=12, subnet='100.64.12'), inet2_snat=WanSettings(port='port1', vlanid=220, subnet='192.168.220'), inet2_dnat=WanSettings(port='port1', vlanid=221, subnet='192.168.221'), inet3=WanSettings(port='port1', vlanid=13, subnet='100.64.13'), inet3_snat=WanSettings(port='port1', vlanid=230, subnet='192.168.230'), inet3_dnat=WanSettings(port='port1', vlanid=231, subnet='192.168.231'), mpls1=WanSettings(port='port2', vlanid=14, subnet='10.0.14'), mpls2=WanSettings(port='port2', vlanid=15, subnet='10.0.15')), 'request': <WSGIRequest: POST '/poc/1/'>, 'csrf_input': '<input type="hidden" name="csrfmiddlewaretoken" value="lEOKVTId7bz6HEMNszo7UVxN43jw4xfIa46zamL84mbwNOhFGlKiKOcnKh5qXCHi">', 'csrf_token': 'fUTtcpWuP0BymrG4WyEkDkBnWKIr8mMe4kbirSZpMbdYsBbWak0vtdgXCYul1reO'}
#
##################################################



config system global
    set hostname FGT-A
    
        
            set gui-theme jade
        
    
end

# location-id is sent by branch to Hub during IKEv2 AUTH
# Use case: there are multiple IPsec tunnels from Branch terminated on the same dialup phase1-interface on Hub
# Hub's behavior:
# - all tunnels connecting to the same phase1-interface are grouped together if they have the same location-id.
# - In order to reply symmetrically, original incoming tunnel is cached in session.
# - For outgoing traffic, FOS does not necessarily use the tunnel returned by the routing lookup to send.
#   Instead, FOS tries to pick original incoming tunnel from the group to send.
#
# Here, I'm using the LAN IP@ as location-id
config system settings
    set location-id 192.168.1.254
end


# ===== Interfaces
#

config system interface
    edit "Inet1"
        set vdom "root"
        set interface "port1"
        set vlanid 11
        set mode static
        set ip 100.64.11.1 255.255.255.0
        set allowaccess ping
        set alias "Internet-1"
        set role wan
    next
    edit "Inet2"
        set vdom "root"
        set interface "port1"
        set vlanid 12
        set mode static
        set ip 100.64.12.1 255.255.255.0
        set allowaccess ping
        set alias "Internet-2"
        set role wan
    next
    edit "Inet3"
        set vdom "root"
        set interface "port1"
        set vlanid 13
        set mode static
        set ip 100.64.13.1 255.255.255.0
        set allowaccess ping
        set alias "Internet-3"
        set role wan
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip 192.168.1.254 255.255.255.0
        set allowaccess ping
        set alias "LAN"
        set role lan
    next
    edit "port10"
        set vdom "root"
        set allowaccess ping https ssh http telnet
        set alias "OOB MGMT"
        set role lan
    next
end

config firewall address
    edit "LAN"
        set subnet 192.168.1.0 255.255.255.0
    next
    edit "DataCenter"
        set allow-routing enable
        set subnet 192.168.255.0 255.255.255.0
    next
    edit "Inet-SRV"
        set subnet 100.64.41.254 255.255.255.255
    next
end

# ===== IPsec
#

config vpn ipsec phase1-interface
    edit "vpn1"
        set interface "Inet1"
        set peertype any
        set suite-b suite-b-gcm-128
        set remote-gw 100.64.31.1
        set psksecret fortinet
        set dpd on-idle
        set localid "BR1_vpn1"
    next
    edit "vpn2"
        set interface "Inet2"
        set peertype any
        set suite-b suite-b-gcm-128
        set remote-gw 100.64.31.1
        set psksecret fortinet
        set dpd on-idle
        set localid "BR1_vpn2"
    next
    edit "vpn3"
        set interface "Inet3"
        set peertype any
        set suite-b suite-b-gcm-128
        set remote-gw 100.64.31.1
        set psksecret fortinet
        set dpd on-idle
        set localid "BR1_vpn3"
    next
end

# IPsec interfaces

config system interface
    edit "vpn1"
        set ip 10.255.1.1 255.255.255.255
        set remote-ip 10.255.1.254 255.255.255.0
    next
    edit "vpn2"
        set ip 10.255.2.1 255.255.255.255
        set remote-ip 10.255.2.254 255.255.255.0
    next
    edit "vpn3"
        set ip 10.255.3.1 255.255.255.255
        set remote-ip 10.255.3.254 255.255.255.0
    next
end

# Traffic selectors used to announce local-LAN and local overlay-ip

config vpn ipsec phase2-interface
    edit "vpn1"
        set phase1name "vpn1"
        set auto-negotiate enable
        set src-addr-type name
        set dst-addr-type name
        set src-name "LAN"
        set dst-name "all"
    next
    edit "vpn1_overlay"
        set phase1name "vpn1"
        set auto-negotiate enable
        set src-subnet 10.255.1.1 255.255.255.255
    next
    edit "vpn2"
        set phase1name "vpn2"
        set auto-negotiate enable
        set src-addr-type name
        set dst-addr-type name
        set src-name "LAN"
        set dst-name "all"
    next
    edit "vpn2_overlay"
        set phase1name "vpn2"
        set auto-negotiate enable
        set src-subnet 10.255.2.1 255.255.255.255
    next
    edit "vpn3"
        set phase1name "vpn3"
        set auto-negotiate enable
        set src-addr-type name
        set dst-addr-type name
        set src-name "LAN"
        set dst-name "all"
    next
    edit "vpn3_overlay"
        set phase1name "vpn3"
        set auto-negotiate enable
        set src-subnet 10.255.3.1 255.255.255.255
    next
end

## SD-WAN
#
#


config system sdwan

    set status enable
    config members
        edit 1
            set interface "Inet1"
            set gateway 100.64.11.254
        next
        edit 2
            set interface "Inet2"
            set gateway 100.64.12.254
        next
        edit 3
            set interface "Inet3"
            set gateway 100.64.13.254
        next
        edit 101
            set interface "vpn1"
            
            set priority 10
        next
        edit 102
            set interface "vpn2"
            
            set priority 10
        next
        edit 103
            set interface "vpn3"
            
            set priority 10
        next
    end
    config health-check
        edit "SLA_Internet"
            set server "198.18.8.8"
            set members 1 2 3
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 300
                next
                edit 2
                    set link-cost-factor packet-loss
                    set packetloss-threshold 5
                next
                edit 3
                    set link-cost-factor latency packet-loss
                    set latency-threshold 300
                    set packetloss-threshold 5
                next
            end
        next
        edit "SLA_DC"
            set server "192.168.255.100"
            set members 101 102 103
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 300
                next
                edit 2
                    set link-cost-factor packet-loss
                    set packetloss-threshold 5
                next
                edit 3
                    set link-cost-factor latency packet-loss
                    set latency-threshold 300
                    set packetloss-threshold 5
                next
            end
        next
        edit "SLA_vpn1"
            set server "10.255.1.254"
            set members 101
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 300
                next
            end
        next
        edit "SLA_vpn2"
            set server "10.255.2.254"
            set members 102
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 300
                next
            end
        next
        edit "SLA_vpn3"
            set server "10.255.3.254"
            set members 103
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 300
                next
            end
        next
    end
end


### FW policies
#
#

# Policy with AppCtrl and deep-inspection

config application list
    edit "AC_monitor_all"
        set comment "Monitor all applications."
        set unknown-application-log enable
        config entries
            edit 1
                set action pass
            next
        end
    next
end

config firewall ssl-ssh-profile
edit "TLS_inspect"
    set comment "Inspect TLS traffic"
    config https
        set ports 443
    end
    config ftps
        set ports 990
    end
    config imaps
        set ports 993
    end
    config pop3s
        set ports 995
    end
    config smtps
        set ports 465
    end
    config ssh
        set ports 22
    end
next
end

config firewall policy
    edit 1
        set name "VPN out"
        set srcintf "port5"
        set dstintf "virtual-wan-link"
        set srcaddr "LAN"
        set dstaddr "DataCenter"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set logtraffic all
        set application-list "AC_monitor_all"
        set ssl-ssh-profile "TLS_inspect"
    next
    edit 2
        set name "Inet out"
        set srcintf "port5"
        set dstintf "virtual-wan-link"
        set srcaddr "LAN"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set logtraffic all
        set application-list "AC_monitor_all"
        set ssl-ssh-profile "TLS_inspect"
        set nat enable
    next
end


# ===== Routing
#

# delete static route #1 which is the default via OOB added by FortiPoC

config router static
    delete 1
    edit 1
        set distance 1
        set comment "default-route for all sdw members"

        
            set sdwan-zone virtual-wan-link
        

    next
    edit 101
        set device "vpn1"
        set dstaddr "DataCenter"
    next
    edit 102
        set device "vpn2"
        set dstaddr "DataCenter"
    next
    edit 103
        set device "vpn3"
        set dstaddr "DataCenter"
    next
    edit 666
        set distance 254
        set blackhole enable
        set dstaddr "DataCenter"
    next
end