# fpoc02 Hub FortiOS 7.0.3
# context = {'ike': '2', 'overlay': 'modecfg', 'routing': 'ibgp', 'advpn': True, 'nat_hub': 'None', 'hub': '198.51.100.1', 'hub_dnat': '198.51.100.201', 'nat': 'None', 'name': 'Hub', 'fos_version': '7.0.3', 'FOS': 7000003, 'mgmt_fpoc': '172.16.31.254', 'HA': FortiGate_HA(mode=<Modes.STANDALONE: 0>, role=<Roles.STANDALONE: 0>, group_id=None, group_name=None, hbdev=None, sessyncdev=None, monitordev=None, priority=None), 'wan': WAN(inet=WanSettings(port='port1', vlanid=0, subnet='198.51.100'), inet_snat=WanSettings(port='port1', vlanid=200, subnet='192.168.200'), inet_dnat=WanSettings(port='port1', vlanid=201, subnet='192.168.201'), inet1=WanSettings(port='port1', vlanid=11, subnet='100.64.11'), inet1_snat=WanSettings(port='port1', vlanid=210, subnet='192.168.210'), inet1_dnat=WanSettings(port='port1', vlanid=211, subnet='192.168.211'), inet2=WanSettings(port='port1', vlanid=12, subnet='100.64.12'), inet2_snat=WanSettings(port='port1', vlanid=220, subnet='192.168.220'), inet2_dnat=WanSettings(port='port1', vlanid=221, subnet='192.168.221'), inet3=WanSettings(port='port1', vlanid=13, subnet='100.64.13'), inet3_snat=WanSettings(port='port1', vlanid=230, subnet='192.168.230'), inet3_dnat=WanSettings(port='port1', vlanid=231, subnet='192.168.231'), mpls1=WanSettings(port='port2', vlanid=14, subnet='10.0.14'), mpls2=WanSettings(port='port2', vlanid=15, subnet='10.0.15')), 'request': <WSGIRequest: POST '/poc/2/'>, 'csrf_input': '<input type="hidden" name="csrfmiddlewaretoken" value="RbpH6nj9EwzWprYaIeJ5GU0D5FaiIM8dGBHwlQm4BHbmvBt2W05gwNFdLTWcBRAN">', 'csrf_token': 'Nk1U9APrG3RBKYKb8W4h4onS7EW3W6oFCKjJo3SmDet1Q8f3mIqsUh2sNSIXPbQf'}
#
##################################################



config system global
    set hostname Hub
    
        set gui-theme graphite
    
end

# Internet and OOB management interfaces

config system interface
    edit "port1"
        set vdom "root"
        set mode static
        set ip 198.51.100.1 255.255.255.0
        set allowaccess ping
        set description "Internet (198.51.100.1)"
        set alias "Inet 198.51.100.1"
    next
    edit "Internet_VIP"
        set vdom "root"
        set mode static
        set ip 192.168.201.1 255.255.255.0
        set allowaccess ping
        set description "Internet with one-to-one NAT (VIP) to 198.51.100.201"
        set alias "Inet VIP 198.51.100.201"
        set interface "port1"
        set vlanid 201
        
            set status down
        
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip 192.168.0.254 255.255.255.0
        set allowaccess ping https ssh http telnet
        set alias "LAN"
    next
    edit "port9"
        set vdom "root"
        set allowaccess ping https ssh http telnet
    next
    edit "port10"
        set vdom "root"
        set allowaccess ping https ssh http telnet
        set alias "OOB Management"
    next
end

# addresses and groups

config firewall address
    edit "LAN"
        set subnet 192.168.0.0 255.255.255.0
    next
    edit "CorporateSubnets"
        set subnet 192.168.0.0 255.255.0.0
    next
end

# IPsec

config user local
    edit "spoke01"
        set type password
        set passwd 111111
    next
    edit "spoke02"
        set type password
        set passwd 222222
    next
    edit "spoke03"
        set type password
        set passwd 333333
    next
    edit "spoke04"
        set type password
        set passwd 444444
    next
end

config user group
    edit "Spokes-ID-PSK"
        set member "spoke01" "spoke02" "spoke03" "spoke04"
    next
end





#
# ======== Dynamic overlay (mode-cfg) =============================================================================
#
# 'net-device disable' to share a common tunnel interface by all dialers
# 'add-route disable' + 'tunnel-search nexthop' since dynamic routing is used
# mode-cfg for tunnel overlay subnet
# ipv4-start-ip = 192.168.255.1
# ipv4-end-ip = 192.168.255.252
# IP .253 is remote-ip of Hub's tunnel interface
# IP .254 is local-ip of Hub's tunnel interface
# ipv4-netmask 255.255.255.0 , mask assigned to Spokes. Mandatory to cover the Hub's IP otherwise packets inbound OSPF hellos are not forwarded to OSPF process


config vpn ipsec phase1-interface
    edit "vpn"
        set type dynamic
        
            set interface "port1"
        
        set net-device disable
        set ike-version 2
        
        set peertype dialup
        set usrgrp "Spokes-ID-PSK"
        unset psksecret
        set proposal aes128-sha1
        
        
        
        
            set add-route disable
            
            set mode-cfg enable
            set ipv4-start-ip 192.168.255.1
            set ipv4-end-ip 192.168.255.252
            set ipv4-netmask 255.255.255.0
        
        
          set auto-discovery-sender enable
        
    next
end

config vpn ipsec phase2-interface
    edit "vpn"
        set phase1name "vpn"
        set proposal aes128-sha1
    next
end



#  IPsec interface overlay IP
#
# the remote-ip is dummy but the mask must encompass all Peer's overlay tunnel IP

  

config system interface
    edit "vpn"
        set ip 192.168.255.254 255.255.255.255
        set remote-ip 192.168.255.253 255.255.255.0
        set allowaccess ping
    next
end


# Policies




config firewall policy
    edit 1
        set name "Deny Internet"
        set srcintf "port5"
        set dstintf "port1" "Internet_VIP"
        set srcaddr "RFC1918-private-subnets"
        set dstaddr "RFC1918-private-subnets"
        set schedule "always"
        set service "ALL"
        set logtraffic all
    next
    edit 2
        set name "Internet Access"
        set srcintf "port5"
        set dstintf "port1" "Internet_VIP"
        set srcaddr "LAN"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat enable
    next
    
    edit 3
        set name "to VPN"
        set srcintf "port5"
        set dstintf "vpn"
        set srcaddr "LAN"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
    next
    
    edit 4
        set name "from VPN"
        set srcintf "vpn"
        set dstintf "port5"
        set srcaddr "all"
        set dstaddr "LAN"
        set action accept
        set schedule "always"
        set service "ALL"
        
    next
    
    edit 5
        set name "VPN to VPN"
        set srcintf "vpn"
        set dstintf "vpn"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
    next
    
end

# Static default-routes for Internet access

config router static
    edit 1
        set gateway 198.51.100.254
        set device "port1"
        
            set status enable
        
    next
    edit 201
        set gateway 192.168.201.254
        set device "Internet_VIP"
        
            set status disable
        
    next
end






# =============== iBGP routing (route reflector) =================================================
#
# Hub is BGP route reflector
# RID is based on internal IP for consistency with spokes when mode-cfg is used

config router bgp
    set as 65000
    set router-id 192.168.0.254
    config neighbor-group
        edit "spokes"
            set remote-as 65000
            set keep-alive-timer 10
            set holdtime-timer 30
            set route-reflector-client enable
        next
    end
    config neighbor-range
        edit 1
            set prefix 192.168.255.0 255.255.255.0
            set neighbor-group "spokes"
        next
    end
    config network
        edit 1
            set prefix 192.168.0.0 255.255.255.0
        next
    end
end

########### info for net-device enable

# When using "net-device enable", must use a loopback for BGP peering with the Spokes
#
#config system interface
#    edit "loopback_BGP"
#        set vdom "root"
#        set ip 192.168.255.254 255.255.255.255
#        set allowaccess ping
#        set type loopback
#    next
#end

# When using 'net-device enable', the mode-cfg pool stops at 192.168.255.251
# so that the last /30 subnet is not used. It allows to keep address 192.168.255.254 for the loopback
#config vpn ipsec phase1-interface
#    edit "vpn"
#        set net-device enable
#        set ipv4-start-ip 192.168.255.0
#        set ipv4-end-ip 192.168.255.251
#    next
#end

# When using 'net-device enable', need to allow traffic to the loopback interface
#
#config firewall address
#    edit "VPN_Overlay"
#        set subnet 192.168.255.0 255.255.255.0
#    next
#    edit "BGP_peering_overlay_IP"
#        set subnet 192.168.255.254 255.255.255.255
#    next
#end
#
#config firewall policy
#    edit 0
#        set name "Allow BGP peerings"
#        set srcintf "vpn"
#        set dstintf "loopback_BGP"
#        set srcaddr "VPN_Overlay"
#        set dstaddr "BGP_peering_overlay_IP"
#        set action accept
#        set schedule "always"
#        set service "BGP" "PING"
#    next
#end

# when using 'net-device enable', need to specify loopback interface for peering
#config router bgp
#    config neighbor-group
#        edit "spokes"
#            set update-source "loopback_BGP"
#        next
#    end
#end




