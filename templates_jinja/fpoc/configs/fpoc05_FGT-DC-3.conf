# fpoc05 FGT-DC-3 FortiOS 7.0.3
# context = {'i': 3, 'overlay': 'modecfg', 'duplicate_paths': 'keep_duplicates', 'override_with_hub_nexthop': False, 'feasible_routes': 'remote_internet_mpls', 'hub_inet1': '100.64.11.3', 'hub_inet2': '100.64.12.3', 'hub_lte': '100.64.11.3', 'hub_mpls': '10.0.14.3', 'name': 'FGT-DC-3', 'fos_version': '7.0.3', 'FOS': 7000003, 'mgmt_fpoc': '172.16.31.254', 'HA': FortiGate_HA(mode=<Modes.STANDALONE: 0>, role=<Roles.STANDALONE: 0>, group_id=None, group_name=None, hbdev=None, sessyncdev=None, monitordev=None, priority=None), 'wan': WAN(inet=WanSettings(port='port1', vlanid=0, subnet='198.51.100'), inet_snat=WanSettings(port='port1', vlanid=200, subnet='192.168.200'), inet_dnat=WanSettings(port='port1', vlanid=201, subnet='192.168.201'), inet1=WanSettings(port='port1', vlanid=11, subnet='100.64.11'), inet1_snat=WanSettings(port='port1', vlanid=210, subnet='192.168.210'), inet1_dnat=WanSettings(port='port1', vlanid=211, subnet='192.168.211'), inet2=WanSettings(port='port1', vlanid=12, subnet='100.64.12'), inet2_snat=WanSettings(port='port1', vlanid=220, subnet='192.168.220'), inet2_dnat=WanSettings(port='port1', vlanid=221, subnet='192.168.221'), inet3=WanSettings(port='port1', vlanid=13, subnet='100.64.13'), inet3_snat=WanSettings(port='port1', vlanid=230, subnet='192.168.230'), inet3_dnat=WanSettings(port='port1', vlanid=231, subnet='192.168.231'), mpls1=WanSettings(port='port2', vlanid=14, subnet='10.0.14'), mpls2=WanSettings(port='port2', vlanid=15, subnet='10.0.15')), 'request': <WSGIRequest: POST '/poc/5/'>, 'csrf_input': '<input type="hidden" name="csrfmiddlewaretoken" value="hhD99MZwduF0GediQhiPumI9OZWQMr5O6HVYof2raFhqMoIa43E0kfnJudIKFwxo">', 'csrf_token': 'k277WiU6R4fptQVqrEcyUiRpoZx0E6Ps9spWbLX1OfRPz0qiFqyJKbwZ4djUxbh2'}
#
##################################################



config system global
    set hostname FGT-DC-3
    set gui-theme neutrino
end

config system alias
    edit "sniff_client11"
        set command "diagnose sniffer packet any \'host 192.168.1.11\' 4"
    next
    edit "sniff_client22"
        set command "diagnose sniffer packet any \'host 192.168.2.22\' 4"
    next
    edit "flow_client11"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 192.168.1.11
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_client22"
        set command "
diag debug flow filter clear
diag debug flow show function-name enable
diag debug flow filter addr 192.168.2.22
diag debug flow trace start 5
diag debug console time enable
diag debug enable"
    next
    edit "flow_stop"
        set command "
diag debug flow trace stop
diag debug flow filter clear
diag debug console time disable
diag debug disable"
    next
end

# "session without SYN" required for ADVPN on Hub
#
config system settings
    set tcp-session-without-syn enable
end

# Internet and OOB management interfaces

config system interface
    edit "Internet_1"
        set vdom "root"
        set mode static
        set ip 100.64.11.3 255.255.255.0
        set allowaccess ping
        set alias "Internet-1"
        set interface "port1"
        set vlanid 11
        set role wan
    next
    edit "Internet_1_VIP"
        set vdom "root"
        set mode static
        set ip 192.168.211.3 255.255.255.0
        set allowaccess ping
        set description "Internet1 with one-to-one NAT (VIP) to 100.64.11.211"
        set alias "Inet1 VIP 100.64.11.211"
        set interface "port1"
        set vlanid 211
        set status down
        set role wan
    next
    edit "Internet_2"
        set vdom "root"
        set mode static
        set ip 100.64.12.3 255.255.255.0
        set allowaccess ping
        set alias "Internet-2"
        set interface "port1"
        set vlanid 12
        set role wan
    next
    edit "Internet_2_VIP"
        set vdom "root"
        set mode static
        set ip 192.168.221.3 255.255.255.0
        set allowaccess ping
        set description "Internet2 with one-to-one NAT (VIP) to 100.64.12.221"
        set alias "Inet2 VIP 100.64.12.221"
        set interface "port1"
        set vlanid 221
        set status down
        set role wan
    next
    edit "MPLS"
        set vdom "root"
        set mode static
        set ip 10.0.14.3 255.255.255.0
        set allowaccess ping
        set alias "MPLS"
        set interface "port2"
        set vlanid 14
        set role wan
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip 192.168.3.3 255.255.255.0
        set allowaccess ping
        set alias "LAN"
        set role lan
    next
end

# addresses and groups

config firewall address
    edit "DataCenter"
        set subnet 192.168.3.0 255.255.255.0
    next
    edit "Corporate_LANs"
        set subnet 192.168.0.0 255.255.0.0
        set allow-routing enable
    next
    edit "Overlay_summary"
        set subnet 10.255.0.0 255.255.0.0
        set allow-routing enable
    next
    edit "MPLS_interco_summary"
        set subnet 10.0.0.0 255.255.0.0
        set allow-routing enable
    next
end

config firewall addrgrp
    edit "Corporate_subnets"
        set member "Corporate_LANs" "Overlay_summary"
        set allow-routing enable
    next
end

# IPsec

# ADVPN1 over Internet-1 - overlay subnet 10.255.1.0/24

config vpn ipsec phase1-interface
    edit "advpn1"
        set type dynamic
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        set network-id 1
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set mode-cfg enable
            set ipv4-start-ip 10.255.1.1
            set ipv4-end-ip 10.255.1.252
            set ipv4-netmask 255.255.255.0
        
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret advpn1
    next
end

config vpn ipsec phase2-interface
    edit "advpn1"
        set phase1name "advpn1"
    next
end

config system interface
    edit "advpn1"
        set ip 10.255.1.254 255.255.255.255
        set remote-ip 10.255.1.253 255.255.255.0
        set allowaccess ping
    next
end


# ADVPN2 over Internet-2 - overlay subnet 10.255.2.0/24

config vpn ipsec phase1-interface
    edit "advpn2"
        set type dynamic
        set interface "Internet_2"
        set ike-version 2
        set network-overlay enable
        set network-id 2
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set mode-cfg enable
            set ipv4-start-ip 10.255.2.1
            set ipv4-end-ip 10.255.2.252
            set ipv4-netmask 255.255.255.0
        
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret advpn2
    next
end

config vpn ipsec phase2-interface
    edit "advpn2"
        set phase1name "advpn2"
    next
end

config system interface
    edit "advpn2"
        set ip 10.255.2.254 255.255.255.255
        set remote-ip 10.255.2.253 255.255.255.0
        set allowaccess ping
    next
end

# ADVPN3 for branches LTE backup - overlay subnet 10.255.3.0/24
# bound to "port1" like ADVPN1
# peerid is used to differentiate advpn3 (only accept ID "LTE") with advpn1 (accept any other ID)

config vpn ipsec phase1-interface
    edit "advpn3"
        set type dynamic
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        set network-id 3
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set mode-cfg enable
            set ipv4-start-ip 10.255.3.1
            set ipv4-end-ip 10.255.3.252
            set ipv4-netmask 255.255.255.0
        
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret advpn3
    next
end

config vpn ipsec phase2-interface
    edit "advpn3"
        set phase1name "advpn3"
    next
end

config system interface
    edit "advpn3"
        set ip 10.255.3.254 255.255.255.255
        set remote-ip 10.255.3.253 255.255.255.0
        set allowaccess ping
    next
end

# ADVPN4 over MPLS - overlay subnet 10.255.4.0/24

config vpn ipsec phase1-interface
    edit "advpn4"
        set type dynamic
        set interface "MPLS"
        set ike-version 2
        set network-overlay enable
        set network-id 4
        set peertype any
        set net-device disable
        
        set add-route disable
        
            set mode-cfg enable
            set ipv4-start-ip 10.255.4.1
            set ipv4-end-ip 10.255.4.252
            set ipv4-netmask 255.255.255.0
        
        set auto-discovery-sender enable
        set dpd on-idle
        set dpd-retryinterval 60
        set suite-b suite-b-gcm-128
        set psksecret advpn4
    next
end

config vpn ipsec phase2-interface
    edit "advpn4"
        set phase1name "advpn4"
    next
end

config system interface
    edit "advpn4"
        set ip 10.255.4.254 255.255.255.255
        set remote-ip 10.255.4.253 255.255.255.0
        set allowaccess ping
    next
end


# SD-WAN manual rules for ADVPN "domain" routing strategy


    config system sdwan
    set status enable
    config zone
        edit "internet"
        next
        edit "overlay"
        next
    end
    config members
        edit 1
            set interface "advpn1"
            set zone "overlay"
        next
        edit 2
            set interface "advpn2"
            set zone "overlay"
        next
        edit 3
            set interface "advpn3"
            set zone "overlay"
        next
        edit 4
            set interface "advpn4"
            set zone "overlay"
        next
        edit 201
            set interface "Internet_1"
            set gateway 100.64.11.254
            set zone "internet"
        next
        edit 202
            set interface "Internet_2"
            set gateway 100.64.12.254
            set zone "internet"
        next
    end







    config service
        edit 1
            set name "from_advpn1_to_advpn1-2-4"
            set input-device "advpn1"
            set src "all"
            set dst "all"
            set priority-members 1 2 4
        next
        edit 2
            set name "from_advpn2_to_advpn2-1-4"
            set input-device "advpn2"
            set src "all"
            set dst "all"
            set priority-members 2 1 4
        next
        edit 3
            set name "from_advpn4_to_advpn4-1-2"
            set input-device "advpn4"
            set src "all"
            set dst "all"
            set priority-members 4 1 2
        next
        edit 4
            set name "from_advpn3_to_advpn1-2-4"
            set input-device "advpn3"
            set src "all"
            set dst "all"
            set priority-members 1 2 4
        next
    end
end


# FW Policies
# no IPS profile is applied because IPS process did not start correctly when mixing AppCtrl + IPS profiles

config firewall policy
    edit 1
        set name "Deny Internet"
        set srcintf "port5"
        
            set dstintf "internet"
        
        set srcaddr "RFC1918-private-subnets"
        set dstaddr "RFC1918-private-subnets"
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Good practice FW rule"
    next
    edit 2
        set name "Internet"
        set srcintf "port5"
        
            set dstintf "internet"
        
        set srcaddr "DataCenter"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set nat enable
    next

    edit 5
        set name "VPN -> Internet (RIA)"
        
            set srcintf "overlay"
        
        
            set dstintf "internet"
        
        set srcaddr "Corporate_subnets"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set comments "Remote Internet Breakout for Branches"
        set nat enable
    next

    edit 3
        set name "VPN -> DC"
        
            set srcintf "overlay"
        
        set dstintf "port5"
        set srcaddr "Corporate_subnets"
        set dstaddr "DataCenter"
        set action accept
        set schedule "always"
        set service "ALL"
        set logtraffic all
    next
    edit 4
        set name "VPN <-> VPN"
        
            set srcintf "overlay"
            set dstintf "overlay"
        
        set srcaddr "Corporate_subnets"
        set dstaddr "Corporate_subnets"
        set action accept
        set schedule "always"
        set service "ALL"

            set anti-replay disable
            set tcp-session-without-syn all

        set logtraffic all
    next
end

## Routing

# Static default-routes


config router static
    edit 1
        set sdwan-zone "internet"
        set comment "Default-route via Internet links"
    next
end


# Other static routes

config router static
    edit 4
        set dstaddr "MPLS_interco_summary"
        set device "MPLS"
        set gateway 10.0.14.254
        set comment "interco subnets of MPLS underlay"
    next
end


# BGP peering over VPNs
# default BGP timers (1min/3min)for advpn3 (LTE overlay)


    # Advertise overlay subnets via BGP since BGP NH recursion via BGP is available as of 7.0


config router bgp
    set as 65000
    set router-id 192.168.3.3
    set ibgp-multipath enable
    set additional-path enable
    set additional-path-select 4
    set keepalive-timer 10
    set holdtime-timer 30
    
    
        config aggregate-address
            edit 1
                set prefix 10.255.1.0 255.255.255.0
                set summary-only enable
            next
            edit 2
                set prefix 10.255.2.0 255.255.255.0
                set summary-only enable
            next
            edit 3
                set prefix 10.255.3.0 255.255.255.0
                set summary-only enable
            next
            edit 4
                set prefix 10.255.4.0 255.255.255.0
                set summary-only enable
            next
        end
    
    config neighbor-group
        edit "advpn1"
            set interface "advpn1"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            
        next
        edit "advpn2"
            set interface "advpn2"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            
        next
        edit "advpn3"
            set interface "advpn3"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set keep-alive-timer 60
            set holdtime-timer 180
            set route-reflector-client enable
            set advertisement-interval 1
            
        next
        edit "advpn4"
            set interface "advpn4"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.255.1.0 255.255.255.0
            set neighbor-group "advpn1"
        next
        edit 2
            set prefix 10.255.2.0 255.255.255.0
            set neighbor-group "advpn2"
        next
        edit 3
            set prefix 10.255.3.0 255.255.255.0
            set neighbor-group "advpn3"
        next
        edit 4
            set prefix 10.255.4.0 255.255.255.0
            set neighbor-group "advpn4"
        next
    end
    config network
        edit 1
            set prefix 192.168.3.0 255.255.255.0
        next
        
            edit 2
                set prefix 10.255.1.254 255.255.255.255
            next
            edit 3
                set prefix 10.255.2.254 255.255.255.255
            next
            edit 4
                set prefix 10.255.3.254 255.255.255.255
            next
            edit 5
                set prefix 10.255.4.254 255.255.255.255
            next
        
    end
end




