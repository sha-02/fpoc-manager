{% extends "./routing.bgp.conf" %} {# shared jinja variables needed for BGP #}
{% block bgp_shortcut %}

# dynamic BGP peerings between Hub in one region with the Branches of the remote region (eBGP peering)
# Only advertise local DC subnets, do not re-advertise any other prefixes (aggregates, ...)
# simple solution done here: tag local LAN with 32768 when injected with 'network' command and only allow sending
# prefixes with this tag over shortcuts

config router route-map
    edit "SET_LOCAL_LAN"
        config rule
            edit 1
                set set-tag 32768
            next
        end
    next
    edit "LOCAL_LAN_ONLY"
        config rule
            edit 1
                set match-tag 32768
            next
        end
    next
end

# ASN range [65001-65254] - # regexp generated by https://3widgets.com/
config router aspath-list
    edit "ASN_REGIONS"
        config rule
            edit 1
                set action permit
                set regexp "(6500[1-9]|650[1-9][0-9]|651[0-9]{2}|652[0-4][0-9]|6525[0-4])"
            next
        end
    next
end

config router bgp
    config network
        edit 1
            set route-map "SET_LOCAL_LAN"
        next
    end
    config neighbor-group
        edit "ADVPN_REGIONS"
# passive enable = let the peer from remote region initiate the BGP session, Hubs are passive for inter-regional branch-to-remoteHub shortcuts
            set passive enable
            set remote-as-filter ASN_REGIONS
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set ebgp-enforce-multihop enable
            set advertisement-interval 1
            set soft-reconfiguration enable
            set next-hop-self enable
            set route-map-out "LOCAL_LAN_ONLY"
        next
    end
    config neighbor-range
        edit 2
            set prefix 10.200.0.0 255.255.0.0
            set neighbor-group "ADVPN_REGIONS"
        next
    end
end

{% endblock %} {# end of extension of 'router.bgp.conf' #}
