###############################################################################################################
# BGP peerings
#

{% extends "./routing.bgp.conf" %} {# shared jinja variables needed for BGP #}
{% block bgp %}
#
# CONTEXT:

# - eBGP between regions
# - intra-regional ADVPN shortcuts:
#     No BGP route-reflection: BGP aggregation is done
#     Branches (eg, WEST-BR1) receive the LAN of their own DCS (10.1.0.0/24, 10.2.0.0/24 for WEST-DC1/2)
#     and the corporate LAN summary (10.0.0.0/8) to reach every other networks from local and remote regions

# - BGP aggregation is no longer done for remote region but it is not realistic. Few customers can aggregate per-region.
# - LAN summarization:
#      DCs send a corporate LAN summary (10.0.0.0/8) to their own Edges

# Routes received from other regions are marked as 'no-advertise' because they must not be re-advertised to Edges.
# Edges reach the local region and remote regions via the corporate summary (10.0.0.0/8)
# Edges must also receive the subnets of their DCs (10.1.0.0/16 and 10.2.0.0/16 for West)

# Tag-based resolution ('merge') is required with this bgp-on-loopback design:
# (1) on DCs to which shortcuts can be established (branches from a remote region building shortcut to the DC),
#     in this PoC this scenario is only when cross_region_advpn is True
# (2) on DCs which can reach branches of a remote region via summary routes from multiple DCs of the remote region
#     in this PoC this is always True for EAST-DC1 because:
#     - without bgp_aggregation: regional loopback summaries are received from WEST-DC1/DC2
#     - with bgp_aggregation: regional LAN summaries are received from WEST-DC1/DC2
#     For WEST-DC1/DC2 this is never True because they connect to a single DC in EAST region
#
# For configuration simplification, tag-based resolution is always enabled on WEST-DC1/DC2, no attempt is made to only
# configure tag-based resolution when only cross_region_advpn is True

#config router access-list
#    edit "LAN_REGIONAL_SUMMARY"
#        config rule
#            edit 1
#                {{ "set prefix 10.0.0.0/14" if region == 'West' else "set prefix 10.4.0.0/14" }}
#                set exact-match enable
#                set action permit
#            next
#        end
#    next
#end

# ADVPNv2.0 control UDP packets must be able to transit from a WEST-BRx loopback to a EAST-BRx loopback via the regional Hubs
# So the regional Hubs must know the loopback summary of its peering region
# E.g., WEST-DC1 must announce 10.200.1.0/24 to EAST-DC1
# These loopback summaries are only for the Hub themselves, they are not sent to any branch

# I think this is no longer needed in 7.4.4, so I remove it and I will see during my test if it is ok

#config router access-list
#    edit "Lo-BGP_REGIONAL_SUMMARY"
#        config rule
#            edit 1
#                set prefix 10.200.{{region_id}}.0 255.255.255.0
#                set exact-match enable
#            next
#        end
#    next
#end

config router route-map
    edit "REGION_IN"
        config rule
            edit 1
                set set-tag 1
                set set-community no-advertise
                set action permit
            next
        end
    next
    edit "REGION_IN2"
        config rule
            edit 1
                set set-tag 2
                set set-community no-advertise
                set action permit
            next
        end
    next
end

# Other region: advertise the LAN regional summary and the local DC LANs (tagged with 32768)

config router route-map
    edit "TAG_LOCAL_LAN"
        config rule
            edit 1
                set set-tag 32768
            next
        end
    next
    edit "REGION_OUT"
        config rule
#            edit 1
#                set match-ip-address "Lo-BGP_REGIONAL_SUMMARY"
#                set action permit
#            next
#            edit 2
#                set match-tag 32768
#                set action permit
#            next
#            edit 3
#                set match-ip-address "LAN_REGIONAL_SUMMARY"
#                set action permit
#            next
#            edit 100
#                set action deny
#            next
            edit 100  {# No regional LAN summaries between the regions, All Hubs know all subnets from all regions #}
                set action permit
            next
        end
    next
end

# Do not advertise regional LAN summary (eg., 10.0.0.0/14 for WEST region) to Edges
# because they will receive the LAN corporate summary (10.0.0.0/8)

config router route-map
    edit "EDGE_OUT"
        config rule
#            edit 1  {# presumably this is no longer needed as of 7.4.4 #}
#                set match-ip-address "Lo-BGP_REGIONAL_SUMMARY"
#                set action deny
#            next
#            edit 2  {# No regional LAN summaries between the regions, All Hubs know all subnets from all regions #}
#                set match-ip-address "LAN_REGIONAL_SUMMARY"
#                set action deny
#            next
            edit 100
                set action permit
            next
        end
    next
end


config router bgp
    set as {{local_ASN}}
    set router-id {{loopback}}
    set keepalive-timer 15
    set holdtime-timer 45
    set ibgp-multipath enable
    set ebgp-multipath enable

    set recursive-next-hop enable
    set tag-resolve-mode merge
    set recursive-inherit-priority enable

    # Aggregate prefixes needed in the BGP table:
    # - regional LAN summary (eg, 10.0.0.0/14 for WEST) to advertise to other regions only
    # - corporate LAN summary (10.0.0.0/8) to advertise to Edges only
    # since 10/14 and 10/8 overlap then summary-only is disabled. We just want the corresponding summary prefixes in the BGP table

    config aggregate-address
        edit 1
            set prefix 10.0.0.0 255.0.0.0
            set as-set disable
            set summary-only disable
        next
        # - ADVPNv2 control UDP packets must be able to transit from Branch to Branch loopback addresses over the Hub
        # I think this was before the new 7.4.4 change where branch can directly send shortcut-query
        # so I will keep the config as commented for the time being and wait to see if it is ok
#        edit 2
#            set prefix 10.200.{{region_id}}.0 255.255.255.0
#            set as-set disable
#            set summary-only enable
#        next
#        edit 3
#            {{ "set prefix 10.0.0.0/14" if region == 'West' else "set prefix 10.4.0.0/14" }}
#            set summary-only disable
#        next
    end

    config neighbor
    {% for neighbor in neighbors -%}
        edit "{{neighbor.ip}}"
            set remote-as {{remote_ASN}}
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set route-map-in "{{neighbor.RM_in}}"
            set route-map-out "REGION_OUT"
            set next-hop-self enable
        next
    {% endfor %}
    end

    config neighbor-group
        edit "EDGE"
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set remote-as {{local_ASN}}
            set advertisement-interval 1
            set soft-reconfiguration enable
            set route-map-out "EDGE_OUT"
            set next-hop-self enable
        next
    end

    config neighbor-range
        edit 1
            set prefix 10.200.{{region_id}}.0 255.255.255.0
            set neighbor-group "EDGE"
        next
    end

    config network
        edit 1
            set prefix {{lan.subnet}} {{lan.mask}}
            set route-map "TAG_LOCAL_LAN"
        next
        # loopback address needed in BGP table to generate the regional loopback aggregate (eg, 10.200.1.0/24)
        edit 2
            set prefix {{loopback}} 255.255.255.255
        next
    end

end


# dynamic BGP peerings between Hub in one region with the Branches of the remote region (eBGP peering)
# Only advertise local DC subnets, do not re-advertise any other prefixes (aggregates, ...)
# simple solution done here: tag local LAN with 32768 when injected with 'network' command and only allow sending
# prefixes with this tag over shortcuts

config router route-map
    edit "LOCAL_LAN_ONLY"
        config rule
            edit 1
                set match-tag 32768
            next
        end
    next
end

# ASN range [65001-65254] - # regexp generated by https://3widgets.com/
config router aspath-list
    edit "ASN_REGIONS"
        config rule
            edit 1
                set action permit
                set regexp "(6500[1-9]|650[1-9][0-9]|651[0-9]{2}|652[0-4][0-9]|6525[0-4])"
            next
        end
    next
end

config router bgp
    config neighbor-group
        edit "ADVPN_REGIONS"
            set remote-as-filter ASN_REGIONS
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set ebgp-enforce-multihop enable
            set advertisement-interval 1
            set soft-reconfiguration enable
            set route-map-out "LOCAL_LAN_ONLY"
            set next-hop-self enable
        next
    end
    config neighbor-range
        edit 2
            set prefix 10.200.0.0 255.255.0.0
            set neighbor-group "ADVPN_REGIONS"
        next
    end
end

{% endblock %} {# end of extension of 'router.bgp.conf' #}
