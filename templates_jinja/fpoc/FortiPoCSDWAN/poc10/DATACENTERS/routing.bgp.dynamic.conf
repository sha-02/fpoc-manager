{% if shortcut_routing == 'dynamic_bgp' and cross_region_advpn %} {# dynamic BGP for shortcuts with remote Branches only needed if cross_region_advpn #}

{% if region == 'West' -%}
    {%- set remote_region_id = 2 -%}
    {%- set remote_region = 'EAST' -%}
{%- else -%} {# East region #}
    {%- set remote_region_id = 1 -%}
    {%- set remote_region = 'WEST' -%}
{%- endif -%}

# dynamic BGP peerings between Hub in one region with the Branches of the remote region (eBGP peering)
# Only advertise local DC subnets, do not re-advertise any other prefixes (aggregates, ...)
# simple solution done here: tag local LAN with 32768 when injected with 'network' command and only allow sending
# prefixes with this tag over shortcuts

config router route-map
    edit "LOCAL_LAN_ONLY"
        config rule
            edit 1
                set match-tag 32768
            next
        end
    next
end

{% set neighbor_name = "ADVPN_"~remote_region|upper %}
{% if FOS >= 7_004_004 %}
    # ASN range [65001-65254]
    # regexp generated by https://3widgets.com/
    config router aspath-list
        edit "ASN_REGIONS"
            config rule
                edit 1
                    set action permit
                    set regexp "(6500[1-9]|650[1-9][0-9]|651[0-9]{2}|652[0-4][0-9]|6525[0-4])"
                next
            end
        next
    end

    {% set neighbor_name = "ADVPN_REGIONS" %}
{% endif %}

config router bgp
    config neighbor-group
        edit "{{neighbor_name}}"
            {% if FOS >= 7_004_004 %}
                set remote-as-filter ASN_REGIONS
            {% else %}
                set remote-as 6500{{remote_region_id}}
            {% endif %}
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set ebgp-enforce-multihop enable
            set advertisement-interval 1
            set soft-reconfiguration enable
            set route-map-out "LOCAL_LAN_ONLY"
        next
    end
    config neighbor-range
        edit 2
            {% if FOS >= 7_004_004 %}
                set prefix 10.200.0.0 255.255.0.0
            {% else %}
                set prefix 10.200.{{remote_region_id}}.0 255.255.255.0
            {% endif %}
            set neighbor-group "{{neighbor_name}}"
        next
    end
end

{% endif %} {# shortcut_routing == 'dynamic_bgp' and cross_region_advpn #}
