##############################################################################################################
# FW Policies
# no IPS profile is applied because IPS process did not start correctly when mixing AppCtrl + IPS profiles

{% set internal = 'port5' %}

config firewall policy
    edit 1
        set name "Deny Internet"
        set srcintf {{internal}}
        set dstintf "internet"
        set srcaddr "RFC1918-private-subnets"
        set dstaddr "RFC1918-private-subnets"
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Good practice FW rule"
        set global-label "INTERNET"
    next
    edit 2
        set name "Internet"
        set srcintf {{internal}}
        set dstintf "internet"
        set srcaddr "DataCenters"
        set dstaddr "Internet"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set nat enable
        set global-label "INTERNET"
    next
{% if remote_internet == 'mpls' or remote_internet == 'all' %}
    edit 5
        set name "VPN -> Internet (RIA)"
        set srcintf "branches"
        set dstintf "internet"
        set srcaddr "Corporate"
        set dstaddr "Internet"
        set action accept
        set schedule "always"
        set service "ALL"
        set utm-status enable
        set ssl-ssh-profile "deep-inspection"
        set av-profile "default"
        set application-list "default"
        set logtraffic all
        set comments "Remote Internet Breakout for Branches"
        set nat enable
        set global-label "INTERNET"
    next
{% endif %}
    edit 3
        set name "VPN -> DC"
        set srcintf "branches" "inter-regions"
        set dstintf {{internal}} "lo-HC"
        set srcaddr "Corporate"
        set dstaddr "DataCenters" "lo-SDWAN-HC"
        set action accept
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set global-label "VPN"
    next
{% if bidir_sdwan != 'none' %}
    edit 6
        set name "DC -> VPN"
        set srcintf {{internal}}
        set dstintf "branches" "inter-regions"
        set srcaddr "DataCenters"
        set dstaddr "Corporate"
        set action accept
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set global-label "VPN"
    next
{% endif %}
{% if shortcut_routing == 'dynamic_bgp' %}
# Workaround for issue 0935130
# Prevent BGP sessions between Branches to flow through the Hub when the shortcut is deleted
# Service "ALL" is used (instead of only BGP) because I observed that shortcut can be re-created by:
# - BGP packet in original direction (src=X, dst=179) or reply direction (src=179, dst=X)
# - PING packet from SD-WAN shortcut monitoring
    edit 7
        set name "VPN<->VPN OVL"
        set srcintf "branches" "inter-regions"
        set dstintf "branches" "inter-regions"
        set srcaddr "Overlays"
        set dstaddr "Overlays"
        set schedule "always"
        set service "ALL"
        set action deny
        set logtraffic all
        set comments "Prevent dynamic BGP for shortcuts to flow through the Hub"
    next
{% endif %}
# logtraffic-start is enabled on branch-to-branch policy 4 so that a log is generated immediately
# and can be used in Demo/EBC to show that traffic initially flowed through the Hub before a shortcut is created
    edit 4
        set name "VPN <-> VPN"
        set srcintf "branches" "inter-regions"
        {% if bgp_aggregation %} {# BGP on loopback for inter regions #}
            set dstintf "branches" "inter-regions" "lo-BGP-REGION"
        {% else %}
            set dstintf "branches" "inter-regions"
        {% endif %}
        set srcaddr "Corporate"
        set dstaddr "Corporate"
        set action accept
        set schedule "always"
        set service "ALL"

            set anti-replay disable
            set tcp-session-without-syn all

        set logtraffic all
        set logtraffic-start enable
        set global-label "VPN"
    next
end
