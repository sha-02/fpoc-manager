{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
    {% set wan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].wan %}
    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
{% endif %}

###############################################################################################################
# SD-WAN manual rules for ADVPN "domain" routing strategy (overlay stickiness)

# SD-WAN manual rules for ADVPN inter-region stickiness to guarantee that traffic initiated by a branch over an overlay
# (e.g., INET1) is forwarded inter-region through the INET1 overlays (DC to DC, and then DC to edge)

# **** TODO ***************************************
# USe the new 7.2 'tie-break input-device' to simplify sdwan rules on Hub
# *****************************************************************************

config system sdwan
    set status enable
    config zone
        edit "internet"
        next
        edit "branches"
        next
        edit "inter-regions"
        next
    end
    config members
        edit 1
            set interface "EDGE_INET1"
            set zone "branches"
        next
        edit 2
            set interface "EDGE_INET2"
            set zone "branches"
        next
        edit 3
            set interface "EDGE_MPLS"
            set zone "branches"
        next
        edit 201
            set interface "Internet_1"
            set gateway {{wan.inet1.subnet}}.254
            set zone "internet"
        next
        edit 202
            set interface "Internet_2"
            set gateway {{wan.inet2.subnet}}.254
            set zone "internet"
        next
        {% if region == 'West' %}
            edit 131
                set interface "EAST_DC3_INET1"
                set zone "inter-regions"
            next
            edit 132
                set interface "EAST_DC3_INET2"
                set zone "inter-regions"
            next
            edit 133
                set interface "EAST_DC3_MPLS"
                set zone "inter-regions"
            next
        {% else %} {# East region #}
            edit 131
                set interface "WEST_DC1_INET1"
                set zone "inter-regions"
            next
            edit 132
                set interface "WEST_DC1_INET2"
                set zone "inter-regions"
            next
            edit 133
                set interface "WEST_DC1_MPLS"
                set zone "inter-regions"
            next
            edit 231
                set interface "WEST_DC2_INET1"
                set zone "inter-regions"
            next
            edit 232
                set interface "WEST_DC2_INET2"
                set zone "inter-regions"
            next
            edit 233
                set interface "WEST_DC2_MPLS"
                set zone "inter-regions"
            next
        {% endif %}
    end
    config health-check
        edit "SLA_Internet"
            set server "198.18.8.8"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 201 202
            config sla
                edit 1
                    set latency-threshold 150
                    set jitter-threshold 30
                    set packetloss-threshold 2
                next
            end
        next
        {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'ecmp_links' %}
            edit "SLA_EDGE"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 1 2 3
                config sla
                    edit 1
                        set link-cost-factor latency
                        set latency-threshold 150
                        set priority-in-sla 11
                        set priority-out-sla 22
                    next
                end
            next
        {% endif %}
        {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'preferred_link' %}
            edit "SLA_EDGE_INET1"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 1
                config sla
                    edit 1
                        set link-cost-factor latency
                        set latency-threshold 150
                        set priority-in-sla 10
                        set priority-out-sla 65531
                    next
                end
            next
            edit "SLA_EDGE_INET2"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 2
                config sla
                    edit 1
                        set link-cost-factor latency
                        set latency-threshold 150
                        set priority-in-sla 20
                        set priority-out-sla 65532
                    next
                end
            next
            edit "SLA_EDGE_MPLS"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 3
                config sla
                    edit 1
                        set link-cost-factor latency
                        set latency-threshold 150
                        set priority-in-sla 30
                        set priority-out-sla 65533
                    next
                end
            next
        {% endif %}
    end
    config service
        edit 1
            set name "ADVPN_for_EDGE_INET1"
            set input-device "EDGE_INET1"
            set src "all"
            set dst "all"
            set priority-members 1 2
        next
        edit 2
            set name "ADVPN_for_EDGE_INET2"
            set input-device "EDGE_INET2"
            set src "all"
            set dst "all"
            set priority-members 2 1
        next
        edit 3
            set name "ADVPN_for_EDGE_MPLS"
            set input-device "EDGE_MPLS"
            set src "all"
            set dst "all"
            set priority-members 3
        next
        {% if region == 'West' %}
            edit 4
                set name "EDGE_INET1_to_EAST"
                set input-device "EDGE_INET1"
                set src "all"
                set dst "all"
                set priority-members 131
            next
            edit 5
                set name "EDGE_INET2_to_EAST"
                set input-device "EDGE_INET2"
                set src "all"
                set dst "all"
                set priority-members 132
            next
            edit 6
                set name "EDGE_MPLS_to_EAST"
                set input-device "EDGE_MPLS"
                set src "all"
                set dst "all"
                set priority-members 133
            next
            edit 7
                set name "EAST_to_EDGE_INET1"
                set input-device "EAST_DC3_INET1"
                set src "all"
                set dst "all"
                set priority-members 1
            next
            edit 8
                set name "EAST_to_EDGE_INET2"
                set input-device "EAST_DC3_INET2"
                set src "all"
                set dst "all"
                set priority-members 2
            next
            edit 9
                set name "EAST_to_EDGE_MPLS"
                set input-device "EAST_DC3_MPLS"
                set src "all"
                set dst "all"
                set priority-members 3
            next
        {% else %} {# East region #}
            edit 4
                set name "EDGE_INET1_to_WEST"
                set input-device "EDGE_INET1"
                set src "all"
                set dst "all"
                set priority-members 131 231
            next
            edit 5
                set name "EDGE_INET2_to_WEST"
                set input-device "EDGE_INET2"
                set src "all"
                set dst "all"
                set priority-members 132 232
            next
            edit 6
                set name "EDGE_MPLS_to_WEST"
                set input-device "EDGE_MPLS"
                set src "all"
                set dst "all"
                set priority-members 133 233
            next
            edit 7
                set name "WEST_to_EDGE_INET1"
                set input-device "WEST_DC1_INET1" "WEST_DC2_INET1"
                set src "all"
                set dst "all"
                set priority-members 1
            next
            edit 8
                set name "WEST_to_EDGE_INET2"
                set input-device "WEST_DC1_INET2" "WEST_DC2_INET2"
                set src "all"
                set dst "all"
                set priority-members 2
            next
            edit 9
                set name "WEST_to_EDGE_MPLS"
                set input-device "WEST_DC1_MPLS" "WEST_DC2_MPLS"
                set src "all"
                set dst "all"
                set priority-members 3
            next
        {% endif %}
        {% if bidir_sdwan == 'route_tag' %}
            edit 11
                set name "EDGE_INET1_SLA_OK"
                set src "DataCenters"
                set route-tag 1
                set priority-members 1
            next
            edit 12
                set name "EDGE_INET2_SLA_OK"
                set src "DataCenters"
                set route-tag 1
                set priority-members 2
            next
            edit 13
                set name "EDGE_MPLS_SLA_OK"
                set src "DataCenters"
                set route-tag 1
                set priority-members 3
            next
            edit 14
                set name "EDGE_SLA_NOK"
                set src "DataCenters"
                set route-tag 2
                set priority-members 1 2 3
            next
        {% endif %}
        edit 20
            set name "Internet"
            set mode sla
            set src "Corporate"
            {% if bidir_sdwan == 'route_tag' %}
              # Must restrict the dst to 'Internet' ('all' minus RFC1918 subnets) (defined in bootstrap config)
              # Otherwise WEST->EAST (or EAST->WEST) traffic hits this rule if dst='all' and is sent to the Internet
              set dst "Internet"
            {% else %} {# 'route_priority' or 'remote_sla' #}
              # Must restrict the dst to 'Internet' ('all' minus RFC1918 subnets) (defined in bootstrap config)
              # Otherwise DC->VPN traffic hits this rule if dst='all' and is sent to the Internet
              set dst "Internet"
            {% endif %}
            config sla
                edit "SLA_Internet"
                    set id 1
                next
            end
            set priority-members 201 202
        next
    end
end
