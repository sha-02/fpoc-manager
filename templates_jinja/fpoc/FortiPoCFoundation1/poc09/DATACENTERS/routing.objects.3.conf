{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
{% endif %}

{% if bidir_sdwan == 'route_tag' or bidir_sdwan == 'route_priority' %}

# CONTEXT:
# Bi-directional SD-WAN (Hub-side Steering) is required
# It is done by using route-tags or by route-priority
#

config router community-list
    edit "SLA_OK"
        config rule
            edit 1
                set action permit
                set match "65000:1"
            next
        end
    next
    edit "SLA_NOK"
        config rule
            edit 1
                set action permit
                set match "65000:2"
            next
        end
    next
end

{% if bidir_sdwan == 'route_priority' %}
# If all links have same SLA status (OK or NOK), all BGP routes get the same priority: that is there is ECMP.
# If it is desired to only select a single preferred link (like we were doing with route-tags and manual sd-wan rules)
# then different communities must be set by the branch, leading to distinct priorities and a single preferred link
# As of 7.2.1 (0818213), the 'priority' BGP attribute can be used for selection of the best path to advertize.
{% endif %}

config router route-map
    edit "routes_for_sdwan"
        config rule
            edit 1
                set match-community "SLA_OK"
                {% if bidir_sdwan == 'route_tag' %}
                    set set-route-tag 1
                {% endif %}
                {% if bidir_sdwan == 'route_priority' %}
                    set set-priority 1
                {% endif %}
            next
            edit 2
                set match-community "SLA_NOK"
                {% if bidir_sdwan == 'route_tag' %}
                    set set-route-tag 2
                {% endif %}
                {% if bidir_sdwan == 'route_priority' %}
                    set set-priority 2
                {% endif %}
            next
        end
    next
end

{% endif %}
