{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
{% endif %}

###

{% set local_ASN = '' %}  {# Initialize variables outside of a 'if' block to avoid FMG creating metadata #}

{% if bidir_sdwan == 'route_tag' or bidir_sdwan == 'route_priority' %}

{# Define which ASN is for local region and which ASN is for the remote region #}
# FOS >= 7.0: always eBGP for cross-region
{%- if region == 'West' -%}
    {%- set local_ASN = 65012 -%}
{%- else -%} {# East region #}
    {%- set local_ASN = 65003 -%}
{%- endif %}

# CONTEXT:
# Bidirectional SD-WAN (Hub-side Steering) is required
# It is done by using route-tags or by route-priority
#

config router community-list
    edit "SLA_OK"
        config rule
            edit 1
                set action permit
                set match "{{local_ASN}}:1"
            next
        end
    next
    edit "SLA_NOK"
        config rule
            edit 1
                set action permit
                set match "{{local_ASN}}:2"
            next
        end
    next
end

{% if bidir_sdwan == 'route_tag' or (bidir_sdwan == 'route_priority' and bgp_priority == 'ecmp_links') %}
  config router route-map
      edit "RM_EDGE_SDWAN"
          config rule
              edit 1
                  set match-community "SLA_OK"
                  {% if bidir_sdwan == 'route_tag' %}
                      set set-route-tag 1
                  {% endif %}
                  {% if bidir_sdwan == 'route_priority' %}
                      set set-priority 11
                  {% endif %}
              next
              edit 2
                  set match-community "SLA_NOK"
                  {% if bidir_sdwan == 'route_tag' %}
                      set set-route-tag 2
                  {% endif %}
                  {% if bidir_sdwan == 'route_priority' %}
                      set set-priority 22
                  {% endif %}
              next
          end
      next
  end
{% endif %}

{% if bidir_sdwan == 'route_priority' and bgp_priority == 'preferred_link' %}

  {# The below PFLs are already defined if cross_region_advpn but they are also needed for 'ADVPN from IPsec selectors' #}
  {# So they are redefined here #}

    # BGP next-hops for INET1, INET2, MPLS tunnels
    config router prefix-list
        edit "PFL_NH_INET1"
            config rule
                edit 1
                    set prefix 10.201.0.0 255.255.0.0
                    set ge 32
                    set le 32
                next
            end
        next
        edit "PFL_NH_INET2"
            config rule
                edit 1
                    set prefix 10.202.0.0 255.255.0.0
                    set ge 32
                    set le 32
                next
            end
        next
        edit "PFL_NH_MPLS"
            config rule
                edit 1
                    set prefix 10.203.0.0 255.255.0.0
                    set ge 32
                    set le 32
                next
            end
        next
    end

  config router route-map
      edit "RM_EDGE_SDWAN"
          config rule
              edit 1
                  set match-community "SLA_OK"
                  set match-ip-nexthop "PFL_NH_INET1"
                  set set-priority 10
              next
              edit 2
                  set match-community "SLA_OK"
                  set match-ip-nexthop "PFL_NH_INET2"
                  set set-priority 20
              next
              edit 3
                  set match-community "SLA_OK"
                  set match-ip-nexthop "PFL_NH_MPLS"
                  set set-priority 30
              next
              edit 4
                  set match-community "SLA_NOK"
                  set match-ip-nexthop "PFL_NH_INET1"
                  set set-priority 65531
              next
              edit 5
                  set match-community "SLA_NOK"
                  set match-ip-nexthop "PFL_NH_INET2"
                  set set-priority 65532
              next
              edit 6
                  set match-community "SLA_NOK"
                  set match-ip-nexthop "PFL_NH_MPLS"
                  set set-priority 65533
              next
          end
      next
  end
{% endif %} {# bidir_sdwan == 'route_priority' and bgp_priority == 'preferred_link' #}

{% endif %} {# if bidir_sdwan == 'route_tag' or bidir_sdwan == 'route_priority' #}
