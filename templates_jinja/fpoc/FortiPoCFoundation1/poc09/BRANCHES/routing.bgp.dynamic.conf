{% if shortcut_routing == 'dynamic_bgp' %}

{% if region == 'West' -%}
    {%- set local_ASN = 65012 -%}
    {%- set prefixes = ['10.201.1.0/24','10.201.2.0/24','10.202.1.0/24','10.202.2.0/24','10.203.1.0/24','10.203.2.0/24'] -%}
    {%- set remote_ASN = 65003 -%}
    {%- set remote_region_id = 2 -%}
    {%- set remote_region = 'EAST' -%}
{%- else -%} {# East region #}
    {%- set local_ASN = 65003 -%}
    {%- set prefixes = ['10.201.3.0/24','10.201.4.0/24','10.202.3.0/24','10.202.4.0/24','10.203.3.0/24','10.203.4.0/24'] -%}
    {%- set remote_ASN = 65012 -%}
    {%- set remote_region_id = 1 -%}
    {%- set remote_region = 'WEST' -%}
{%- endif -%}

# dynamic BGP peerings with Branches in local region (iBGP peering)
# since the Branch is not a route-reflector, it will not re-advertise the iBGP prefixes learned from the Hub

config router bgp
    config neighbor-group
        edit {{"ADVPN_"~region|upper}}
            set passive disable
            set remote-as {{local_ASN}}
            set advertisement-interval 1
            set soft-reconfiguration enable
        next
    end
    config neighbor-range
    {% for prefix in prefixes %}
        edit {{loop.index}}
            set prefix {{prefix}}
            set neighbor-group {{"ADVPN_"~region|upper}}
        next
    {% endfor %}
    end
end

{% if cross_region_advpn %}
# dynamic BGP peerings with Branches in remote region (eBGP peering)
# Only advertise local subnets, do not re-advertise the iBGP prefixes learned from the Hub into this eBGP peering
# simple solution done here: tag local LAN with 32768 when injected with 'network' command and only allow sending
# prefixes with this tag to remote region branches

    config router route-map
        edit "SET_LOCAL_LAN"
            config rule
                edit 1
                    set set-tag 32768
                next
            end
        next
        edit "LOCAL_LAN_ONLY"
            config rule
                edit 1
                    set match-tag 32768
                next
            end
        next
    end

    config router bgp
        config network
            edit 1
                set route-map "SET_LOCAL_LAN"
            next
        end
        config neighbor-group
            edit {{"ADVPN_"~remote_region|upper}}
                set passive disable
                set remote-as {{remote_ASN}}
                set advertisement-interval 1
                set soft-reconfiguration enable
                set route-map-out "LOCAL_LAN_ONLY"
            next
        end
        config neighbor-range
            edit 201
                set prefix 10.201.0.0 255.255.0.0
                set neighbor-group {{"ADVPN_"~remote_region|upper}}
            next
            edit 202
                set prefix 10.202.0.0 255.255.0.0
                set neighbor-group {{"ADVPN_"~remote_region|upper}}
            next
            edit 203
                set prefix 10.203.0.0 255.255.0.0
                set neighbor-group {{"ADVPN_"~remote_region|upper}}
            next
        end
    end
{% endif %}

{% endif %} {# shortcut_routing == 'dynamic_bgp' #}
