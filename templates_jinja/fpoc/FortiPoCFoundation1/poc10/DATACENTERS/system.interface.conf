{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set dc_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].dc_id %}
    {% set wan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].wan %}
    {% set lan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].lan %}
    {% set segments = SETTINGS.DEVICES[FMG_FORTIGATE_ID].segments %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
    {% set vrf_aware_overlay = SETTINGS.DEVICES[FMG_FORTIGATE_ID].vrf_aware_overlay %}
    {% set loopback = SETTINGS.DEVICES[FMG_FORTIGATE_ID].loopback %}
{% endif %}

###############################################################################################################
# Internet and OOB management interfaces

{% set textualize = { 1: 'first', 2: 'second'} %}
{% set wan_dc = datacenter[region|lower][textualize[dc_id]] %}

# On the Hubs, DO NOT use the same loopback for BGP termination and as a health-check server for the Spokes
# Using the same loopback is not supported, because the healh-check routes are statically injected on the Spokes,
# remaining even when the respective overlay is dead.
# As a result, the BGP session will not be able to switchover to another overlay upon failure!

config system interface
    edit "Internet_1"
        set vdom "root"
        set mode static
        set ip {{wan_dc.inet1}} 255.255.255.0
        set allowaccess ping
        set alias "Internet-1"
        set interface "{{wan.inet1.port}}"
        set vlanid {{wan.inet1.vlanid}}
        set role wan
        set monitor-bandwidth enable
    next
    {% if dc_id == 1 %}
        edit "Internet_1_VIP"
            set vdom "root"
            set mode static
            set ip 192.168.{{wan.inet_dnat.vlanid}}.{{dc_id}} 255.255.255.0
            set allowaccess ping
            set description "Internet1 with one-to-one NAT (VIP) to {{wan.inet.subnet}}.{{wan.inet_dnat.vlanid}}"
            set alias "Inet1 VIP {{wan.inet.subnet}}.{{wan.inet_dnat.vlanid}}"
            set interface "{{wan.inet_dnat.port}}"
            set vlanid {{wan.inet_dnat.vlanid}}
            set status down
            set role wan
        next
    {% elif dc_id == 2 %}
        edit "Internet_1_VIP"
            set vdom "root"
            set mode static
            set ip 192.168.{{wan.inet1_dnat.vlanid}}.{{dc_id}} 255.255.255.0
            set allowaccess ping
            set description "Internet1 with one-to-one NAT (VIP) to {{wan.inet1.subnet}}.{{wan.inet1_dnat.vlanid}}"
            set alias "Inet1 VIP {{wan.inet1.subnet}}.{{wan.inet1_dnat.vlanid}}"
            set interface "{{wan.inet1_dnat.port}}"
            set vlanid {{wan.inet1_dnat.vlanid}}
            set status down
            set role wan
        next
    {% endif %}
    edit "Internet_2"
        set vdom "root"
        set mode static
        set ip {{wan_dc.inet2}} 255.255.255.0
        set allowaccess ping
        set alias "Internet-2"
        set interface "{{wan.inet2.port}}"
        set vlanid {{wan.inet2.vlanid}}
        set role wan
        set monitor-bandwidth enable
    next
    {% if dc_id == 1 %}
        edit "Internet_2_VIP"
            set vdom "root"
            set mode static
            set ip 192.168.{{wan.inet2_dnat.vlanid}}.{{dc_id}} 255.255.255.0
            set allowaccess ping
            set description "Internet2 with one-to-one NAT (VIP) to {{wan.inet2.subnet}}.{{wan.inet2_dnat.vlanid}}"
            set alias "Inet2 VIP {{wan.inet2.subnet}}.{{wan.inet2_dnat.vlanid}}"
            set interface "{{wan.inet2_dnat.port}}"
            set vlanid {{wan.inet2_dnat.vlanid}}
            set status down
            set role wan
        next
    {% elif dc_id == 2 %}
        edit "Internet_2_VIP"
            set vdom "root"
            set mode static
            set ip 192.168.{{wan.inet3_dnat.vlanid}}.{{dc_id}} 255.255.255.0
            set allowaccess ping
            set description "Internet2 with one-to-one NAT (VIP) to {{wan.inet3.subnet}}.{{wan.inet3_dnat.vlanid}}"
            set alias "Inet2 VIP {{wan.inet3.subnet}}.{{wan.inet3_dnat.vlanid}}"
            set interface "{{wan.inet3_dnat.port}}"
            set vlanid {{wan.inet3_dnat.vlanid}}
            set status down
            set role wan
        next
    {% endif %}
    edit "MPLS"
        set vdom "root"
        set mode static
        set ip {{wan_dc.mpls}} 255.255.255.0
        set allowaccess ping
        set alias "MPLS"
        set interface "{{wan.mpls1.port}}"
        set vlanid {{wan.mpls1.vlanid}}
        set role wan
        set monitor-bandwidth enable
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip {{lan.ip}} {{lan.mask}}
        set allowaccess ping
        set alias "DC-LAN"
        set role lan
        set monitor-bandwidth enable
    next
    edit "lo-HC"
        set vdom "root"
        set ip 10.200.99.1 255.255.255.255
        set allowaccess ping
        set type loopback
        set role wan
    next
    edit "lo-BGP"
        set vdom "root"
        set ip {{loopback}} 255.255.255.255
        set allowaccess ping
        set type loopback
        set role wan
    next
    {% if vrf_aware_overlay %}
        edit "port5"
            set alias "SEGMENT_0"
        next
        {% for name, segment in segments.items() %}
            edit "{{name}}"
                set vdom "root"
                set vrf {{segment.vrfid}}
                set ip {{segment.ip}} {{segment.mask}}
                set allowaccess ping
                set role lan
                set interface "port5"
                set vlanid {{segment.vlanid}}
            next
        {% endfor %}
    {% endif %}
end
