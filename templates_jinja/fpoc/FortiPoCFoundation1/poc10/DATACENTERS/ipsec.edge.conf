{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set dc_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].dc_id %}
    {% set region_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region_id %}
{% endif %}

###############################################################################################################
# IPsec

#
# Edge tunnels to Branches
#

{% set textualize = { 1: 'first', 2: 'second'} %}
{% set networkid = datacenter[region|lower][textualize[dc_id]].id %}

{% set phase1s = [
    { 'name': 'EDGE_INET1', 'interface': 'Internet_1', 'networkid': networkid ~ '1' },
    { 'name': 'EDGE_INET2', 'interface': 'Internet_2', 'networkid': networkid ~ '2' },
    { 'name': 'EDGE_MPLS', 'interface': 'MPLS', 'networkid': networkid ~ '3' },
    ]
%}

# The Hub must be able to detect link failures on Edge devices, in order to withdraw the loopback routes injected by exchange-ip-addrv4.
# Furthermore, for certain transition scenarios, it is important that the Hub detects such failures faster than other Edge devices
# (for example, those that had an active ADVPN shortcut towards the failed link). Therefore, we enable DPD ( on-idle )
# and we ensure that the DPD timers on Hubs are shorter than those on the Edge devices.

{% for phase1 in phase1s %}
    config vpn ipsec phase1-interface
        edit "{{phase1.name}}"
            set type dynamic
            set interface "{{phase1.interface}}"
            set ike-version 2
            set network-overlay enable
            set network-id {{phase1.networkid}}
            set peertype any
            set net-device disable
            set add-route disable
            set auto-discovery-sender enable
            set exchange-ip-addr4 10.200.{{region_id}}.{{255-dc_id}}
            set dpd on-idle
            set dpd-retrycount 2
            set dpd-retryinterval 5
            set suite-b suite-b-gcm-128
            set psksecret {{phase1.networkid}}{{phase1.networkid}}{{phase1.networkid}}
        next
    end

    config vpn ipsec phase2-interface
        edit "{{phase1.name}}"
            set phase1name "{{phase1.name}}"
        next
    end
{% endfor %}
