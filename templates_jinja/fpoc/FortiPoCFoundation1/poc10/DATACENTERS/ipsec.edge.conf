{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set dc_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].dc_id %}
    {% set region_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region_id %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
    {% set vrf_aware_overlay = SETTINGS.DEVICES[FMG_FORTIGATE_ID].vrf_aware_overlay %}
    {% set multicast = SETTINGS.DEVICES[FMG_FORTIGATE_ID].multicast %}
    {% set overlay = SETTINGS.DEVICES[FMG_FORTIGATE_ID].overlay %}
    {% set loopback = SETTINGS.DEVICES[FMG_FORTIGATE_ID].loopback %}
{% endif %}

###############################################################################################################
# IPsec

#
# Edge tunnels to Branches
#

{#
# WEST-DC1 dc_id = 1, WEST-DC2 dc_id = 2, EAST-DC1 dc_id = 1 , These are the relative DC ID within their region
# 'datacenter' contains an absolute ID for each DC across all Regions:
# WEST-DC1 HubID = 1, WEST-DC2 HubID = 2, EAST-DC1 HubID = 3, [EAST-DC1 HubID = 4]
#}
{% set textualize = { 1: 'first', 2: 'second'} %}
{% set hubid = datacenter[region|lower][textualize[dc_id]].id %}

{% if multicast %}
# PIM does not bind to unnumbered interfaces: overlay IP@ must be configured for IPsec tunnels
{% if overlay == 'mode_cfg' %}
# "dependent" shortcuts are mandatory with mode-cfg overlays (0778974/0793117)
{% endif %}
{% endif %}

{# phase1 info when there is no multicast #}
{% set phase1s = [
    { 'name': 'EDGE_INET1', 'interface': 'Internet_1', 'network_id': hubid ~ '1' },
    { 'name': 'EDGE_INET2', 'interface': 'Internet_2', 'network_id': hubid ~ '2' },
    { 'name': 'EDGE_MPLS', 'interface': 'MPLS', 'network_id': hubid ~ '3' },
    ]
%}

{% set pool_base = '169.254.'~region_id~dc_id %}
{% if multicast and overlay == 'mode_cfg' %}
  # The same mode-cfg pool is used across all Edge IPsec interfaces

  config firewall address
      edit "pool_branches_ipsec"
          set type iprange
          set start-ip {{pool_base}}.1
          set end-ip {{pool_base}}.239
      next
  end

  {# The mask for the remote-ip on the Edge IPsec interfaces is set to /32 to avoid enabling 'subnet-overlap' #}
  {% set phase1s = [
      { 'name': 'EDGE_INET1', 'interface': 'Internet_1', 'network_id': hubid ~ '1',
          'ip': pool_base~'.251 255.255.255.255', 'remote_ip': pool_base~'.241 255.255.255.255' },
      { 'name': 'EDGE_INET2', 'interface': 'Internet_2', 'network_id': hubid ~ '2',
          'ip': pool_base~'.252 255.255.255.255', 'remote_ip': pool_base~'.242 255.255.255.255' },
      { 'name': 'EDGE_MPLS', 'interface': 'MPLS', 'network_id': hubid ~ '3',
          'ip': pool_base~'.253 255.255.255.255', 'remote_ip': pool_base~'.243 255.255.255.255' },
      ]
  %}
{% endif %}

{% set overlay1 = '10.201.' ~ hubid %}
{% set overlay2 = '10.202.' ~ hubid %}
{% set overlay3 = '10.203.' ~ hubid %}
{% if multicast and overlay == 'static' %}
  {% set phase1s = [
      { 'name': 'EDGE_INET1', 'interface': 'Internet_1', 'network_id': hubid ~ '1',
          'ip': overlay1~'.254 255.255.255.255', 'remote_ip': overlay1~'.253 255.255.255.0' },
      { 'name': 'EDGE_INET2', 'interface': 'Internet_2', 'network_id': hubid ~ '2',
          'ip': overlay2~'.254 255.255.255.255', 'remote_ip': overlay2~'.253 255.255.255.0' },
      { 'name': 'EDGE_MPLS', 'interface': 'MPLS', 'network_id': hubid ~ '3',
          'ip': overlay3~'.254 255.255.255.255', 'remote_ip': overlay3~'.253 255.255.255.0' },
      ]
  %}
{% endif %}


# The Hub must be able to detect link failures on Edge devices, in order to withdraw the loopback routes injected by exchange-ip-addrv4.
# Furthermore, for certain transition scenarios, it is important that the Hub detects such failures faster than other Edge devices
# (for example, those that had an active ADVPN shortcut towards the failed link). Therefore, we enable DPD ( on-idle )
# and we ensure that the DPD timers on Hubs are shorter than those on the Edge devices.

{% for phase1 in phase1s %}
    config vpn ipsec phase1-interface
        edit "{{phase1.name}}"
            set type dynamic
            set interface "{{phase1.interface}}"
            set ike-version 2
            set network-overlay enable
            set network-id {{phase1.network_id}}
            set peertype any
            set net-device disable
            set add-route disable
            set auto-discovery-sender enable
            set exchange-ip-addr4 {{loopback}}
            set dpd on-idle
            set dpd-retrycount 2
            set dpd-retryinterval 5
            set psksecret {{phase1.network_id}}{{phase1.network_id}}{{phase1.network_id}}
            {% if multicast and overlay == 'mode_cfg' %}
                set mode-cfg enable
                set assign-ip-from name
                set ipv4-name "pool_branches_ipsec"
                set ipv4-netmask 255.255.255.0
            {% endif %}
            {% if vrf_aware_overlay and FOS >= 7_002_000 %}
                set encapsulation vpn-id-ipip
                set proposal aes128-sha256
                set dhgrp 19
            {% else %}
                set suite-b suite-b-gcm-128
            {% endif %}
        next
    end

    config vpn ipsec phase2-interface
        edit "{{phase1.name}}"
            set phase1name "{{phase1.name}}"
            {% if vrf_aware_overlay and FOS >= 7_002_000 %}
                set proposal null-sha1 aes128gcm
            {% endif %}
        next
    end

    {% if multicast %}
        config system interface
            edit "{{phase1.name}}"
                set ip {{phase1.ip}}
                set remote-ip {{phase1.remote_ip}}
                set allowaccess ping
            next
        end
    {% endif %}
{% endfor %}

{% if multicast and overlay == 'mode_cfg' %}
# The mask for the remote-ip on the Edge IPsec interfaces is set to /32 in order to avoid enabling 'subnet-overlap'
# Static routes for this subnet over the Edge interfaces is added to avoid potential RPF failure for PIM neighboring

    config firewall address
        edit "subnet_branches_ipsec"
            set subnet {{pool_base}}.0 255.255.255.0
            set allow-routing enable
        next
    end

    config router static
        edit 251
            set dstaddr "subnet_branches_ipsec"
            set device "EDGE_INET1"
        next
        edit 252
            set dstaddr "subnet_branches_ipsec"
            set device "EDGE_INET2"
        next
        edit 253
            set dstaddr "subnet_branches_ipsec"
            set device "EDGE_MPLS"
        next
    end
{% endif %}

