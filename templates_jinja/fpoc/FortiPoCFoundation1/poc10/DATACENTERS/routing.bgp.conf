{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set dc_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].dc_id %}
    {% set cross_region_advpn = SETTINGS.DEVICES[FMG_FORTIGATE_ID].cross_region_advpn %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
    {% set region_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region_id %}
    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
    {% set lan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].lan %}
{% endif %}

{# Initialize variables outside of a 'if' block to avoid FMG creating metadata #}
{% set local_ASN = '' %}
{% set remote_ASN = '' %}
{% set neighbors = '' %}

###############################################################################################################
# BGP peerings

{# Define which ASN is for local region and which ASN is for the remote region #}

{% if region == 'West' -%}
    {%- set local_ASN  = 65001 -%}
    {%- set remote_ASN = 65002 -%}
{%- else -%} {# East region #}
    {%- set local_ASN = 65002 -%}
    {%- set remote_ASN = 65001 -%}
{%- endif %}

config router route-map
    edit "LOCAL_REGION_ONLY"
        config rule
            edit 1
                {# Do not advertise to EBGP peers (ie., outside the region) #}
                set set-community "no-export"
            next
        end
    next
end

config router bgp
    set as {{local_ASN}}
    set router-id 10.200.{{region_id}}.{{255-dc_id}}
    set keepalive-timer 15
    set holdtime-timer 45
    set ibgp-multipath enable
    set ebgp-multipath enable
    set recursive-next-hop enable

    {% if not cross_region_advpn -%}
        {# Advertise regional LAN summaries between the regions #}
        config aggregate-address
            edit 1
                {% if region == 'West' %}
                    set prefix 10.0.0.0/14
                {% else %}
                    set prefix 10.4.0.0/14
                {% endif %}
            next
        end
    {% endif -%}

    config neighbor
        {% if region == 'West' -%}
            {% set neighbors = ['10.200.2.254'] %}
        {% else %}
            {% set neighbors = ['10.200.1.254', '10.200.1.253'] %}
        {% endif -%}

        {% for neighbor in neighbors -%}
        edit "{{neighbor}}"
            set remote-as {{remote_ASN}}
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set ebgp-enforce-multihop enable

            {% if cross_region_advpn %}
                set attribute-unchanged next-hop   {# Preserve next-hop for ADVPN #}
            {% endif %}

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set route-map-out "REGION_OUT"
        next
        {% endfor %}
    end

    config neighbor-group
        edit "EDGE"
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set remote-as {{local_ASN}}
            set route-reflector-client enable
            set advertisement-interval 1
            set soft-reconfiguration enable

            {% if cross_region_advpn %}
                set route-map-out "EDGE_OUT"
                {# Preserve next-hop for ADVPN #}
                unset next-hop-self
            {% endif %}
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.200.{{region_id}}.0 255.255.255.0
            set neighbor-group "EDGE"
        next
    end

    config network
        edit 1
            set prefix {{lan.subnet}} {{lan.mask}}
        next
        edit 102
            set prefix 10.200.0.0 255.255.0.0  {# the global loopback summary is not advertised to other regions #}
            set route-map "LOCAL_REGION_ONLY"
        next
        {% if cross_region_advpn %} {# send local region summary to peering regions #}
            edit 103
                set prefix 10.200.{{region_id}}.0 255.255.255.0
            next
        {% endif %}
    end
end

#
# BGP routes
#

{# =========================================================================================================== #}
{% if dc_id == 1 and FOS >= 7_000_004 and cross_region_advpn %}
{% endif %}

{% if dc_id == 2 and FOS >= 7_000_004 and cross_region_advpn %}
{% endif %}

{% if dc_id == 3 and FOS >= 7_000_004 and cross_region_advpn %}
{% endif %}

{# =========================================================================================================== #}

{% if dc_id == 1 and FOS >= 7_000_004 and not cross_region_advpn %}
{% endif %}

{% if dc_id == 2 and FOS >= 7_000_004 and not cross_region_advpn %}
{% endif %}

{% if dc_id == 3 and FOS >= 7_000_004 and not cross_region_advpn %}
{% endif %}
