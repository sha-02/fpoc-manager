{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set vrf_aware_overlay = SETTINGS.DEVICES[FMG_FORTIGATE_ID].vrf_aware_overlay %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
{% endif %}

#########################################################################################

{% if vrf_aware_overlay and FOS >= 7_002_004 %}
# CONTEXT = No ADVPN for VRF2, ADVPN is only for VRF0 and VRF1
#
# - HUBS must advertise a summary route (10.0.0.0/8) into VRF2 EDGE
# - This summary must not be advertised to other regions -> restricted with 'no-export' community
# - HUB must filter VPNV4 prefixes with RT 65000:2 towards the EDGE
# - But the summary route, which also has RT 65000:2 must be allowed so the summary is tagged with 'tag 32768'
#   when it is injected to BGP
# - summary is added by means of a static blackhole route because:
#   . it is not possible to apply a route-map when creating an aggregate so cannot add tag 32768
#   . if an aggregate is used, the summary is not limited to VRF2

# Inject the summary route 10.0.0.0/8 in VRF2 into the BGP table
# Add 'no-export' so that this summary is only announced to EDGE (iBGP) and is not
# announced to another REGION (eBGP)
# Add tag 32768 to indicate that this is locally originated

config router route-map
    edit "EDGE_VRF2_ONLY"
        config rule
            edit 1
                set match-vrf 2
                set set-community "no-export"
                set set-tag 32768
            next
        end
    next
end

# Do not reflect routes from VRF2 to EDGE except if it contains tag 32768 (self-originated summary)

config router extcommunity-list
    edit "VRF2_ROUTE_TAG"
        set type standard
        config rule
            edit 1
                set action permit
                set type rt
                set match "65000:2"
            next
        end
    next
end

config router route-map
    edit "EDGE_OUT_VPNV4"
        config rule
            edit 1
                set action deny
                set match-ip-address "BGP_REGIONAL_SUMMARY"
            next
            edit 2
                set action permit
                set match-extcommunity "VRF2_ROUTE_TAG"
                set match-tag 32768
            next
            edit 3
                set action deny
                set match-extcommunity "VRF2_ROUTE_TAG"
            next
            edit 100
            next
        end
    next
end
{% endif %}
