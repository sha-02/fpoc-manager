{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
    {% set wan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].wan %}
    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
{% endif %}

###############################################################################################################
# SD-WAN manual rules for ADVPN "domain" routing strategy (overlay stickiness)

# SD-WAN manual rules for ADVPN inter-region stickiness to guarantee that traffic initiated by a branch over an overlay
# (e.g., INET1) is forwarded inter-region through the INET1 overlays (DC to DC, and then DC to edge)

{% set remote_region = '' %} {# Initialize variables outside of a 'if' block to avoid FMG creating metadata #}
{% if region == 'West' %}
    {% set remote_region = 'east' %}
{% else %}
    {% set remote_region = 'west' %}
{% endif %}

config system sdwan
    set status enable
    config zone
        edit "internet"
        next
        edit "branches"
        next
        edit "{{remote_region}}"
        next
    end
    config members
        edit 1
            set interface "EDGE_INET1"
            set zone "branches"
        next
        edit 2
            set interface "EDGE_INET2"
            set zone "branches"
        next
        edit 3
            set interface "EDGE_MPLS"
            set zone "branches"
        next
        edit 4
            set interface "Internet_1"
            set gateway {{wan.inet1.subnet}}.254
            set zone "internet"
        next
        edit 5
            set interface "Internet_2"
            set gateway {{wan.inet2.subnet}}.254
            set zone "internet"
        next
        {% if region == 'West' %}
            edit 11
                set interface "EAST1_INET1"
                set zone "east"
            next
            edit 22
                set interface "EAST1_INET2"
                set zone "east"
            next
            edit 12
                set interface "EAST1_INET1X2"
                set zone "east"
            next
            edit 21
                set interface "EAST1_INET2X1"
                set zone "east"
            next
            edit 33
                set interface "EAST1_MPLS"
                set zone "east"
            next
        {% else %} {# East region #}
            edit 111
                set interface "WEST1_INET1"
                set zone "west"
            next
            edit 122
                set interface "WEST1_INET2"
                set zone "west"
            next
            edit 112
                set interface "WEST1_INET1X2"
                set zone "west"
            next
            edit 121
                set interface "WEST1_INET2X1"
                set zone "west"
            next
            edit 133
                set interface "WEST1_MPLS"
                set zone "west"
            next
            edit 211
                set interface "WEST2_INET1"
                set zone "west"
            next
            edit 222
                set interface "WEST2_INET2"
                set zone "west"
            next
            edit 212
                set interface "WEST2_INET1X2"
                set zone "west"
            next
            edit 221
                set interface "WEST2_INET2X1"
                set zone "west"
            next
            edit 233
                set interface "WEST2_MPLS"
                set zone "west"
            next
        {% endif %}
    end
    config health-check
        edit "SLA_Internet"
            set server "198.18.8.8"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 4 5
            config sla
                edit 1
                    set latency-threshold 150
                    set jitter-threshold 30
                    set packetloss-threshold 2
                next
            end
        next
        {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'ecmp_links' %}
            edit "SLA_EDGE"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 1 2 3
                config sla
                    edit 1
                        set latency-threshold 150
                        set jitter-threshold 30
                        set packetloss-threshold 2
                        set priority-in-sla 11
                        set priority-out-sla 22
                    next
                end
            next
        {% endif %}
        {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'preferred_link' %}
            edit "SLA_EDGE_INET1"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 1
                config sla
                    edit 1
                        set latency-threshold 150
                        set jitter-threshold 30
                        set packetloss-threshold 2
                        set priority-in-sla 10
                        set priority-out-sla 65531
                    next
                end
            next
            edit "SLA_EDGE_INET2"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 2
                config sla
                    edit 1
                        set latency-threshold 150
                        set jitter-threshold 30
                        set packetloss-threshold 2
                        set priority-in-sla 20
                        set priority-out-sla 65532
                    next
                end
            next
            edit "SLA_EDGE_MPLS"
                set detect-mode remote
                set sla-id-redistribute 1
                set members 3
                config sla
                    edit 1
                        set latency-threshold 150
                        set jitter-threshold 30
                        set packetloss-threshold 2
                        set priority-in-sla 30
                        set priority-out-sla 65533
                    next
                end
            next
        {% endif %}
    end
    config service
        edit 1
            set name "ADVPN_for_EDGE_INET1"
            set input-device "EDGE_INET1"
            set src "all"
            set dst "all"
            set priority-members 1 2
            {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'ecmp_links' %}
                # Multiple ECMP BGP routes with priorities can exist to reach a Branch via INET1 or INET2
                # When an overlay is bad, its priority gets increased and this route/overlay is no longer eligible due to 'fib-best-match'
                # we prefer using same overlay for shortcut (overlay stickiness) if it is in-sla (eg, INET1->INET1)
                # but if INET1 is out-of-sla but INET2 is in-sla then we select INET2 (thx to fib-best-match)
                # and create cross-overlay shortcut (INET1->INET2)
                set tie-break fib-best-match
            {% endif %}
        next
        edit 2
            set name "ADVPN_for_EDGE_INET2"
            set input-device "EDGE_INET2"
            set src "all"
            set dst "all"
            set priority-members 2 1
            {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'ecmp_links' %}
                # Same strategy as 'ADVPN_for_EDGE_INET1'
                set tie-break fib-best-match
            {% endif %}
        next
        edit 3
            set name "ADVPN_for_EDGE_MPLS"
            set input-device "EDGE_MPLS"
            set src "all"
            set dst "all"
            set priority-members 3
        next
        {% if region == 'West' %}
            edit 4
                set name "EDGE_INET1_to_EAST"
                set input-device "EDGE_INET1"
                set src "all"
                set dst "all"
                set priority-members 11 22
            next
            edit 5
                set name "EAST_INET1_to_EDGE"
                set input-device "EAST1_INET1"
                set src "all"
                set dst "all"
                set priority-members 1 2
            next
            edit 6
                set name "EDGE_INET2_to_EAST"
                set input-device "EDGE_INET2"
                set src "all"
                set dst "all"
                set priority-members 22 11
            next
            edit 7
                set name "EAST_INET2_to_EDGE"
                set input-device "EAST1_INET2"
                set src "all"
                set dst "all"
                set priority-members 2 1
            next
            edit 8
                set name "EDGE_MPLS_to_EAST"
                set input-device "EDGE_MPLS"
                set src "all"
                set dst "all"
                set priority-members 33
            next
            edit 9
                set name "EAST_MPLS_to_EDGE"
                set input-device "EAST1_MPLS"
                set src "all"
                set dst "all"
                set priority-members 3
            next
        {% else %} {# East region #}
            edit 4
                set name "EDGE_INET1_to_WEST"
                set input-device "EDGE_INET1"
                set src "all"
                set dst "all"
                set priority-members 111 211 122 222
            next
            edit 5
                set name "WEST_INET1_to_EDGE"
                set input-device "WEST1_INET1" "WEST2_INET1"
                set src "all"
                set dst "all"
                set priority-members 1
            next
            edit 6
                set name "EDGE_INET2_to_WEST"
                set input-device "EDGE_INET2"
                set src "all"
                set dst "all"
                set priority-members 122 222 111 211
            next
            edit 7
                set name "WEST_INET2_to_EDGE"
                set input-device "WEST1_INET2" "WEST2_INET2"
                set src "all"
                set dst "all"
                set priority-members 2
            next
            edit 8
                set name "EDGE_MPLS_to_WEST"
                set input-device "EDGE_MPLS"
                set src "all"
                set dst "all"
                set priority-members 133 233
            next
            edit 9
                set name "WEST_MPLS_to_EDGE"
                set input-device "WEST1_MPLS" "WEST2_MPLS"
                set src "all"
                set dst "all"
                set priority-members 3
            next
        {% endif %} {# Edge<->Remote-Region rules #}
        {% if bidir_sdwan == 'remote_sla' and bgp_priority == 'ecmp_links' %}
            # Multiple ECMP BGP routes with priorities can exist to reach a Branch
            # We can use sd-wan rules to select whichever overlay we want to use
            # When an overlay is bad, its priority gets increased and this route/overlay is no longer eligible due to 'fib-best-match'
            edit 10
                set name "EDGE_VoIP"
                set mode manual
                set src "DataCenters"
                set dst "Corporate"
                set protocol 17
                set start-port 5061
                set end-port 5061
                set priority-members 3 1 2
                set tie-break fib-best-match
            next
            edit 11
                set name "EDGE"
                set mode manual
                set src "DataCenters"
                set dst "Corporate"
                set priority-members 1 2 3
                set tie-break fib-best-match
            next
        {% endif %}
        edit 20
            set name "Internet"
            set mode sla
            set src "Corporate"
            {% if bidir_sdwan == 'remote_sla' %}
                {% if bgp_priority == 'ecmp_links' -%}
                    # Destination can be 'all' because DC->Edge traffic will hit the 'EDGE' sd-wan rules
                    set dst "all"
                {% else -%} {# 'single_link' BGP priority which means there is no EDGE sdwan rule #}
                    # Must restrict the dst to 'Internet' ('all' minus RFC1918 subnets) (defined in bootstrap config)
                    # Otherwise DC->Edge traffic hits this rule if dst='all' and is sent to the Internet
                    set dst "Internet"
                {% endif -%}
            {% endif %}
            {% if bidir_sdwan == 'none' %}
                # no Hub-side steering, no DC->VPN traffic is expected
                # Must restrict the dst to 'Internet' ('all' minus RFC1918 subnets) (defined in bootstrap config)
                # Otherwise WEST->EAST (or EAST->WEST) traffic hits this rule if dst='all' and is sent to the Internet
                set dst "Internet"
            {% endif %}
            config sla
                edit "SLA_Internet"
                    set id 1
                next
            end
            set priority-members 4 5
        next
    end
end
