{% if vrf_aware_overlay %}
# VRF-aware overlay
#
# VRF {{vrf_pe}} is used as PE VRF to carry vpnv4 prefixes for the CE VRFs
{% if vrf_pe == vrf_seg0 -%}
# It is also used to carry IPv4 prefixes for port5 LAN which is in same VRF as the PE VRF
{% endif -%}
# For VPNv4 RD and RT we DO NOT use the local ASN, we use 65000 for all devices from all regions

    config router bgp
        config neighbor-group
            edit "EDGE"
                set route-reflector-client-vpnv4 enable
                set soft-reconfiguration-vpnv4 enable
                {% if FOS >= 7_002_004 %}
                    # No ADVPN for VRF-RED, only ADVPN for the other VRFs
                    set route-map-out-vpnv4 "EDGE_OUT_VPNV4"
                {% else %}
                    # ADVPN for all VRFs
                    set route-map-out-vpnv4 "EDGE_OUT"
                {% endif %}
                {{ "set next-hop-self-vpnv4 enable" if bgp_aggregation }}
            next
        end

        config neighbor
            {% for neighbor in neighbors -%}
            edit "{{neighbor.ip}}"
                set route-map-in-vpnv4 "{{neighbor.RM_in}}"
                set route-map-out-vpnv4 "REGION_OUT"
                set soft-reconfiguration-vpnv4 enable
                {% if shortcut_routing == 'exchange_ip' and cross_region_advpn %}
                    # Preserve next-hop for ADVPN
                    #
                    # ATTENTION: from tests done with 7.2.5, this setting is not honored
                    # The BGP NH of VPNV4 prefixes is set to the BGP loopback of the DC
                    # So it breaks cross-regional shortcut routing convergence
                    set attribute-unchanged-vpnv4 next-hop
                {% endif %}
            next
            {% endfor %}
        end

        config network
            {% for name, segment in vrf_segments.items() %}
                {% if name != lan.name %}  {# port5/SEG0 is already defined above with bgp config #}
                    edit "{{10+loop.index0}}"
                        set prefix {{segment.subnet}} {{segment.mask}}
                    next
                {% endif %}
            {% endfor %}
            {% if vrf_aware_overlay %}
                # No ADVPN in VRF-RED: filter VRF-RED prefixes based on RT
                # advertise global summary 10.0.0.0/8 to VRF-RED branches
                edit 200
                    set prefix 10.0.0.0 255.0.0.0
                    set route-map "EDGE_VRF-RED_ONLY"
                next
                {% if region == 'West' %}
                    # summaries needed for WEST-DC1 and WEST-DC2 subnets
                    edit 201
                        set prefix 10.{{dc_id}}.0.0 255.255.0.0
                        set route-map "EDGE_VRF-RED_ONLY"
                    next
                {% endif %}
            {% endif %}
        end

        config vrf
            edit "{{vrf_pe}}"
                set role pe
            next
            {% for segment in vrf_segments.values() %}
                {% if segment.vrfid != vrf_pe %}
                    edit "{{segment.vrfid}}"
                        set role ce
                        set rd "65000:{{segment.vrfid}}"
                        set export-rt "65000:{{segment.vrfid}}"
                        set import-rt "65000:{{segment.vrfid}}"
                    next
                {% endif %}
            {% endfor %}
        end
    end
{% endif %}
