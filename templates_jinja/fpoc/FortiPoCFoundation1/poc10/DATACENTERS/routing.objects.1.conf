{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set region_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region_id %}
{% endif %}
#########################################################################################

# CONTEXT:
# - Cross-region shortcuts are possible
#
# Solution:
# - FOS >= 7.0: eBGP for cross-region
# - ADVPN: BGP NH are preserved cross-region with eBGP 'next-hop-unchanged'
# - advertise the regional loopback summary (eg, 10.200.1.0/24) to the peering region
# - the global loopback summary (10.200.0.0/16) is not advertised to other region

# Regional loopback summary (10.200.1.0/24 for WEST region, 10.200.2.0/24 for EAST region)

config router access-list
  {# Regional loopback summary #}
  edit "BGP_REGIONAL_SUMMARY"
    config rule
      edit 1
        set prefix 10.200.{{region_id}}.0 255.255.255.0
        set exact-match enable
      next
    end
  next
end

#
# Egde
#

# Do not advertise regional loopback summary (eg., 10.200.1.0/24 for WEST region) to Edges
# because they already receive global summary 10.200.0.0/16

config router route-map
  edit "EDGE_OUT"
    config rule
      edit 1
        set match-ip-address "BGP_REGIONAL_SUMMARY"
        set action deny
      next
      edit 100
      next
    end
  next
end

#
# Inter-Region
#

# Regional loopback summary is advertised to other region with community 'no-advertise'
# because it is for usage by direct DC peers only
# E.g.:
# WEST-DC1 sends its regional summary 10.200.1.0/24 with no-advertise to EAST-DC1
# EAST-DC1 can now reach all the BGP NH of WEST region but EAST-DC1 does not re-advertise this summary to its Edges
# or to any other region to which it is connected to (eg., AMER)

config router route-map
  edit "REGION_OUT"
    config rule
      edit 1
        set match-ip-address "BGP_REGIONAL_SUMMARY"
        set set-community no-advertise
      next
      edit 100
      next
    end
  next
end

