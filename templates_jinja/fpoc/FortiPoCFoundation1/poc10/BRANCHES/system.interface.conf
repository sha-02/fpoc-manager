{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set branch_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].branch_id %}
    {% set wan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].wan %}
    {% set lan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].lan %}
    {% set segments = SETTINGS.DEVICES[FMG_FORTIGATE_ID].segments %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
    {% set vrf_aware_overlay = SETTINGS.DEVICES[FMG_FORTIGATE_ID].vrf_aware_overlay %}
{% endif %}

###############################################################################################################
# Internet and OOB management interfaces

config system interface
    edit "Internet_1"
        set vdom "root"
        set mode dhcp
        set defaultgw disable
        set dns-server-override disable
        {# set mode static #}
        {# set ip {{wan.inet1.subnet}}.{{branch_id}} 255.255.255.0 #}
        set allowaccess ping
        set alias "Internet-1"
        set interface "{{wan.inet1.port}}"
        set vlanid {{wan.inet1.vlanid}}
        set monitor-bandwidth enable
    next
    edit "Internet_1_SNAT"
        set vdom "root"
        set mode static
        set ip 192.168.{{wan.inet1_snat.vlanid}}.{{branch_id}} 255.255.255.0
        set allowaccess ping
        set description "INET1 private IP for PAT/SNAT"
        set alias "Inet SNAT {{wan.inet1.subnet}}.{{wan.inet1_snat.vlanid}}"
        set interface "{{wan.inet1_snat.port}}"
        set vlanid {{wan.inet1_snat.vlanid}}
        set status down
    next
    edit "Internet_2"
        set vdom "root"
        set mode dhcp
        set defaultgw disable
        set dns-server-override disable
        {# set mode static #}
        {# set ip {{wan.inet2.subnet}}.{{branch_id}} 255.255.255.0 #}
        set allowaccess ping
        set alias "Internet-2"
        set interface "{{wan.inet2.port}}"
        set vlanid {{wan.inet2.vlanid}}
        set monitor-bandwidth enable
    next
    edit "Internet_2_SNAT"
        set vdom "root"
        set mode static
        set ip 192.168.{{wan.inet2_snat.vlanid}}.{{branch_id}} 255.255.255.0
        set allowaccess ping
        set description "INET2 private IP for PAT/SNAT"
        set alias "Inet SNAT {{wan.inet2.subnet}}.{{wan.inet2_snat.vlanid}}"
        set interface "{{wan.inet2_snat.port}}"
        set vlanid {{wan.inet2_snat.vlanid}}
        set status down
    next
    edit "MPLS"
        set vdom "root"
        set mode static
        set ip {{wan.mpls1.subnet}}.{{branch_id}} 255.255.255.0
        set allowaccess ping
        set alias "MPLS"
        set interface "{{wan.mpls1.port}}"
        set vlanid {{wan.mpls1.vlanid}}
        set monitor-bandwidth enable
    next
    edit "port5"
        set vdom "root"
        set mode static
        set ip {{lan.ip}} {{lan.mask}}
        set allowaccess ping
        set alias "LAN"
        set monitor-bandwidth enable
    next
    edit "lo-BGP"
        set vdom "root"
        set ip 10.200.{{region_id}}.{{branch_id}} 255.255.255.255
        set allowaccess ping
        set type loopback
        set role wan
    next
end


{% if vrf_aware_overlay and FOS >= 7_002_000 %}
config system interface

    # LAN segment in VRF0

    edit "port5"
        set alias "SEGMENT_0"
    next

    # LAN segments in other VRFs

    {% for name, segment in segments.items() %}
        edit "{{name}}"
            set vdom "root"
            set vrf {{segment.vrfid}}
            set ip {{segment.ip}} {{segment.mask}}
            set allowaccess ping
            set role lan
            set interface "port5"
            set vlanid {{segment.vlanid}}
        next
    {% endfor %}

    # Inter-VRF interfaces over vdom-link

    {% for name, segments in inter_segments.items() -%}
        {% for segment in segments %}
            edit "{{name}}{{loop.index0}}"
                set vdom "root"
                set vrf {{segment.vrfid}}
                set ip {{segment.ip}} {{segment.mask}}
                set allowaccess ping
            next
        {% endfor %}
    {% endfor -%}
end
{% endif %}
