{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set branch_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].branch_id %}
    {% set lan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].lan %}
    {% set cross_region_advpn = SETTINGS.DEVICES[FMG_FORTIGATE_ID].cross_region_advpn %}
    {% set datacenter = SETTINGS.DEVICES[FMG_FORTIGATE_ID].datacenter %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
    {% set vrf_aware_overlay = SETTINGS.DEVICES[FMG_FORTIGATE_ID].vrf_aware_overlay %}
{% endif %}

###############################################################################################################
# BGP peerings over VPN overlays

{% set dc1 = '' %}  {# Initialize variables outside of a 'if' block to avoid FMG creating metadata #}
{% set dc2 = '' %}
{% set local_ASN = '' %}

{# Define which ASN is for local region and which ASN is for the remote region #}
# FOS >= 7.0: always eBGP for cross-region

{% if region == 'West' -%}
    {%- set local_ASN = 65001 -%}
    {%- set dc1 = datacenter.west.first.id -%}
    {%- set dc2 = datacenter.west.second.id -%}
{%- else -%} {# East region #}
    {%- set local_ASN = 65002 -%}
    {%- set dc1 = datacenter.east.first.id -%}
    {%- set dc2 = datacenter.east.second.id -%}
{%- endif -%}

# BGP timers ( keepalive-timer , holdtime-timer )
# BGP timers are an important consideration in this routing design!
# Traditionally, we try to lower these timers as much as possible, in order to speed up BGP convergence
# caused by failure of a link. This won’t be our goal here!
# Since we build just a single BGP session between the Edge device and each Hub, we must ensure
# that this BGP session can seamlessly switchover from one overlay to another, in case when the first
# overlay goes down. The session can switchover when the route to the Hub’s loopback address via
# the broken overlay disappears. This will happen automatically, when DPD brings the tunnel down.
# Which means that DPD timers must be shorter than BGP Hold-Time!
# Is it a problem to have such slow BGP timers? Not in this design. And here is why.
# As noted above, there will be a single BGP route for each LAN prefix in the network, recursively resolved
# via all the paths available at the moment. This BGP route remains valid, as long as there is at least one
# path to the destination! Therefore, fast withdrawal of that BGP route is not much of an issue for us. We
# should rather focus on fast withdrawal of the unhealthy path via which that BGP route can be resolved.
# Path health will be monitored by the SD-WAN. This is no longer the responsibility of BGP. Hence, we do
# not require aggressive BGP timers and/or additional protocols such as BFD.

# Tag-based resolution ('merge') is required with this design:
# - on branches to which shortcuts can be established (branches with ADVPN),
# - on branches which can reach another branch (or DC from other region) via multiple Hubs

config router route-map
    edit "H1_TAG"
        config rule
            edit 1
                set set-tag 1
            next
        end
    next
    edit "H2_TAG"
        config rule
            edit 1
                set set-tag 2
            next
        end
    next
end

config router bgp
    set as {{local_ASN}}
    set router-id 10.200.{{region_id}}.{{branch_id}}
    set keepalive-timer 15
    set holdtime-timer 45
    set ibgp-multipath enable

    set recursive-next-hop enable
    set tag-resolve-mode merge

    config neighbor
        edit "10.200.{{region_id}}.254"
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set remote-as {{local_ASN}}
            set route-map-in "H1_TAG"
            set connect-timer 1
            set advertisement-interval 1
            set soft-reconfiguration enable
        next
        edit "10.200.{{region_id}}.253"
            set interface "lo-BGP"
            set update-source "lo-BGP"
            set remote-as {{local_ASN}}
            set route-map-in "H2_TAG"
            set connect-timer 1
            set advertisement-interval 1
            set soft-reconfiguration enable
        next
    end
    config network
        edit 1
            set prefix  {{lan.subnet}} {{lan.mask}}
        next
    end
end

{% if vrf_aware_overlay and FOS >= 7_002_000 %}
# VRF-aware overlay
# VRF 0 is used as PE VRF to carry vpnv4 prefixes and is also used as CE VRF for ipv4 prefixes (LAN on port5)
# VRF >= 1 are CE VRFs (VLANs over port5)
#
# For VPNv4 RD and RT we DO NOT use the local ASN, we use 65000 for all devices from all regions
#
# Internet access:
# VRF 0 is the PE VRF so it contains the Internet underlays and the default routes to Internet
# SEGMENT_0 (port5) being in VRF0 it has native access to the Internet
# Other SEGMENTS (call them "SEGMENTS_x" where x<>0) must send their traffic via VRF0 to access the Internet
# It requires:
# 1- confifuring a static default-route in each VRFx to send Internet traffic into VRF0 (via an inter-vrf interface)
# 2- ensuring that the traffic ingressing VRF0 from VRFx is not rejected by RPF -> VRF0 must know the VLANs on port5
# Point 2- means configuring route leaking from VRFx to VRF0.
# BUt we only want VRF0 to learn the VLANs over port5 (call them local LANs of VRFx), we just want these subnets in the
# RIB of VRF0. They must not be re-advertised by BGP to any other VRF0 peering => use of 'NO-ADVERTISE' community.
#
# Technically, only leak from VRFx to VRF0 is needed to avoid RPF failure when packets from VRFx reaches VRF0
# but FOS requires to configure bi-directional leaking VRFx<->VRFy otherwise the BGP next-hop is marked as inaccessible
# Leaking from VRFx->VRF0 is done for the local LAN subnet of VRFx (tagged as "LOCAL" with a route-map),
# other prefixes in VRFx learned from remote peers are not leaked to VRF0.
# Pseudo-leaking from VRF0->VRFx is configured due to the "bi-directional requirement" but a route-map is used to block
# all prefixes so no leaking really occurs between VRF0->VRFx

    config router route-map
        edit "RM_SET-NONVRF0-LOCAL-TAG"
            config rule
                edit 1
                    set set-tag 666
                next
            end
        next
        edit "RM_NONVRF0-LOCAL-TAG-ONLY"
            config rule
                edit 1
                    set match-tag 666
                next
            end
        next
        edit "RM_DENY-NONVRF0"
            config rule
                edit 1
                    set action deny
                    set match-tag 666
                next
                edit 2
                next
            end
        next
        edit "RM_Deny-ALL"
            config rule
                edit 1
                    set action deny
                next
            end
        next
    end

    config router bgp
        config neighbor
            edit "10.200.{{region_id}}.254"
                set route-map-in-vpnv4 "H1_TAG"
                set route-map-out "RM_DENY-NONVRF0"
                set soft-reconfiguration-vpnv4 enable
            next
            edit "10.200.{{region_id}}.253"
                set route-map-in-vpnv4 "H2_TAG"
                set route-map-out "RM_DENY-NONVRF0"
                set soft-reconfiguration-vpnv4 enable
            next
        end
        config network
            {% for segment in segments.values() %}
                edit "1{{segment.vrfid}}"
                    set prefix {{segment.subnet}} {{segment.mask}}
                    set route-map "RM_SET-NONVRF0-LOCAL-TAG"
                next
            {% endfor %}
        end
        config vrf
            edit "0"
                set role pe
                config leak-target
                {% for name, segments in inter_segments.items() %}
                    edit "{{segments[1].vrfid}}"
                        set route-map "RM_Deny-ALL"
                        set interface "{{name}}0"
                    next
                {% endfor %}
                end
            next
            {% for segment in segments.values() %}
                edit "{{segment.vrfid}}"
                    set role ce
                    set rd "65000:{{segment.vrfid}}"
                    set export-rt "65000:{{segment.vrfid}}"
                    set import-rt "65000:{{segment.vrfid}}"
                    config leak-target
                        edit "0"
                            set route-map "RM_NONVRF0-LOCAL-TAG-ONLY"
                            {% for name, segs in inter_segments.items() %}
                                {% if segment.vrfid == segs[1].vrfid %}
                                    set interface "{{name}}1"
                                {% endif %}
                            {% endfor %}
                        next
                    end
                next
            {% endfor %}
        end
    end
{% endif %}

#
# BGP routes
#

{% if region == 'West' and branch_id == 1 and FOS >= 7_000_004 and cross_region_advpn %}
# WEST-BR1 # alias rib
# Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
#        O - OSPF, IA - OSPF inter area
#        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
#        E1 - OSPF external type 1, E2 - OSPF external type 2
#        i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
#        * - candidate default
#
# Routing table for VRF=0
# S*      0.0.0.0/0 [1/0] via 100.64.31.254, Internet_1, [1/0]
#                   [1/0] via 100.64.32.254, Internet_2, [1/0]
#                   [1/0] via H1_INET2 tunnel 10.0.0.1, [10/0]
#                   [1/0] via H2_INET2 tunnel 10.0.0.3, [10/0]
#                   [1/0] via H1_MPLS tunnel 10.0.14.1, [10/0]
#                   [1/0] via H2_MPLS tunnel 10.0.24.2, [10/0]
#                   [1/0] via H1_INET1 tunnel 100.64.11.1, [10/0]
#                   [1/0] via H2_INET1 tunnel 100.64.21.2, [10/0]
# C       10.0.1.0/24 is directly connected, port5
# B       10.0.2.0/24 [200/0] via 10.200.1.2 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:44:49
#                                                  (recursive via H2_MPLS tunnel 10.0.24.2), 02:44:49
#                                                  (recursive via H2_INET1 tunnel 100.64.21.2), 02:44:49
#                     [200/0] via 10.200.1.2 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:44:49
#                                                  (recursive via H1_MPLS tunnel 10.0.14.1), 02:44:49
#                                                  (recursive via H1_INET1 tunnel 100.64.11.1), 02:44:49
# S       10.0.14.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.15.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.24.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.25.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# C       10.0.34.0/24 is directly connected, MPLS
# S       10.0.35.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.44.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.45.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# B       10.1.0.0/24 [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:43
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 02:45:43
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 02:45:43
# B       10.2.0.0/24 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:45:44
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 02:45:44
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 02:45:44
# B       10.4.0.0/24 [200/0] via 10.200.2.254 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:44:49
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 02:44:49
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 02:44:49
#                     [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:44:49
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 02:44:49
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 02:44:49
# B       10.4.1.0/24 [200/0] via 10.200.2.1 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:44:49
#                                                  (recursive via H2_MPLS tunnel 10.0.24.2), 02:44:49
#                                                  (recursive via H2_INET1 tunnel 100.64.21.2), 02:44:49
#                     [200/0] via 10.200.2.1 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:44:49
#                                                  (recursive via H1_MPLS tunnel 10.0.14.1), 02:44:49
#                                                  (recursive via H1_INET1 tunnel 100.64.11.1), 02:44:49
# B       10.200.0.0/16 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:45:34
#                                                      (recursive via H2_MPLS tunnel 10.0.24.2), 02:45:34
#                                                      (recursive via H2_INET1 tunnel 100.64.21.2), 02:45:34
#                       [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:34
#                                                      (recursive via H1_MPLS tunnel 10.0.14.1), 02:45:34
#                                                      (recursive via H1_INET1 tunnel 100.64.11.1), 02:45:34
# C       10.200.1.1/32 is directly connected, lo-BGP
# S       10.200.1.253/32 [15/0] via H2_INET2 tunnel 10.0.0.3, [1/0]
#                         [15/0] via H2_MPLS tunnel 10.0.24.2, [1/0]
#                         [15/0] via H2_INET1 tunnel 100.64.21.2, [1/0]
# S       10.200.1.254/32 [15/0] via H1_INET2 tunnel 10.0.0.1, [1/0]
#                         [15/0] via H1_MPLS tunnel 10.0.14.1, [1/0]
#                         [15/0] via H1_INET1 tunnel 100.64.11.1, [1/0]
# C       100.64.31.0/24 is directly connected, Internet_1
# C       100.64.32.0/24 is directly connected, Internet_2
# C       172.16.31.0/24 is directly connected, port10
{% endif %}

{% if region == 'West' and branch_id == 2 and FOS >= 7_000_004 and cross_region_advpn %}
# WEST-BR2 # alias rib
# Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
#        O - OSPF, IA - OSPF inter area
#        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
#        E1 - OSPF external type 1, E2 - OSPF external type 2
#        i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
#        * - candidate default
#
# Routing table for VRF=0
# S*      0.0.0.0/0 [1/0] via 100.64.41.254, Internet_1, [1/0]
#                   [1/0] via 100.64.42.254, Internet_2, [1/0]
#                   [1/0] via H1_INET2 tunnel 10.0.0.1, [10/0]
#                   [1/0] via H2_INET2 tunnel 10.0.0.3, [10/0]
#                   [1/0] via H1_MPLS tunnel 10.0.14.1, [10/0]
#                   [1/0] via H2_MPLS tunnel 10.0.24.2, [10/0]
#                   [1/0] via H1_INET1 tunnel 100.64.11.1, [10/0]
#                   [1/0] via H2_INET1 tunnel 100.64.21.2, [10/0]
# B       10.0.1.0/24 [200/0] via 10.200.1.1 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:45:26
#                                                  (recursive via H2_MPLS tunnel 10.0.24.2), 02:45:26
#                                                  (recursive via H2_INET1 tunnel 100.64.21.2), 02:45:26
#                     [200/0] via 10.200.1.1 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:26
#                                                  (recursive via H1_MPLS tunnel 10.0.14.1), 02:45:26
#                                                  (recursive via H1_INET1 tunnel 100.64.11.1), 02:45:26
# C       10.0.2.0/24 is directly connected, port5
# S       10.0.14.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.15.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.24.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.25.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.34.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.35.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# C       10.0.44.0/24 is directly connected, MPLS
# S       10.0.45.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# B       10.1.0.0/24 [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:46:20
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 02:46:20
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 02:46:20
# B       10.2.0.0/24 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:46:21
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 02:46:21
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 02:46:21
# B       10.4.0.0/24 [200/0] via 10.200.2.254 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:45:26
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 02:45:26
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 02:45:26
#                     [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:26
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 02:45:26
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 02:45:26
# B       10.4.1.0/24 [200/0] via 10.200.2.1 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:45:26
#                                                  (recursive via H2_MPLS tunnel 10.0.24.2), 02:45:26
#                                                  (recursive via H2_INET1 tunnel 100.64.21.2), 02:45:26
#                     [200/0] via 10.200.2.1 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:26
#                                                  (recursive via H1_MPLS tunnel 10.0.14.1), 02:45:26
#                                                  (recursive via H1_INET1 tunnel 100.64.11.1), 02:45:26
# B       10.200.0.0/16 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 02:46:12
#                                                      (recursive via H2_MPLS tunnel 10.0.24.2), 02:46:12
#                                                      (recursive via H2_INET1 tunnel 100.64.21.2), 02:46:12
#                       [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:46:12
#                                                      (recursive via H1_MPLS tunnel 10.0.14.1), 02:46:12
#                                                      (recursive via H1_INET1 tunnel 100.64.11.1), 02:46:12
# C       10.200.1.2/32 is directly connected, lo-BGP
# S       10.200.1.253/32 [15/0] via H2_INET2 tunnel 10.0.0.3, [1/0]
#                         [15/0] via H2_MPLS tunnel 10.0.24.2, [1/0]
#                         [15/0] via H2_INET1 tunnel 100.64.21.2, [1/0]
# S       10.200.1.254/32 [15/0] via H1_INET2 tunnel 10.0.0.1, [1/0]
#                         [15/0] via H1_MPLS tunnel 10.0.14.1, [1/0]
#                         [15/0] via H1_INET1 tunnel 100.64.11.1, [1/0]
# C       100.64.41.0/24 is directly connected, Internet_1
# C       100.64.42.0/24 is directly connected, Internet_2
# C       172.16.31.0/24 is directly connected, port10
{% endif %}

{% if region == 'East' and branch_id == 1 and FOS >= 7_000_004 and cross_region_advpn %}
# EAST-BR1 # alias rib
# Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
#        O - OSPF, IA - OSPF inter area
#        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
#        E1 - OSPF external type 1, E2 - OSPF external type 2
#        i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
#        * - candidate default
#
# Routing table for VRF=0
# S*      0.0.0.0/0 [1/0] via 100.64.41.254, Internet_1, [1/0]
#                   [1/0] via 100.64.42.254, Internet_2, [1/0]
#                   [1/0] via H1_INET2 tunnel 10.0.0.1, [10/0]
#                   [1/0] via H1_MPLS tunnel 10.0.24.3, [10/0]
#                   [1/0] via H1_INET1 tunnel 100.64.21.3, [10/0]
# B       10.0.1.0/24 [200/0] via 10.200.1.1 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:57
#                                                  (recursive via H1_MPLS tunnel 10.0.24.3), 02:45:57
#                                                  (recursive via H1_INET1 tunnel 100.64.21.3), 02:45:57
# B       10.0.2.0/24 [200/0] via 10.200.1.2 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:57
#                                                  (recursive via H1_MPLS tunnel 10.0.24.3), 02:45:57
#                                                  (recursive via H1_INET1 tunnel 100.64.21.3), 02:45:57
# S       10.0.14.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.15.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.24.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.25.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.34.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.35.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# C       10.0.44.0/24 is directly connected, MPLS
# S       10.0.45.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# B       10.1.0.0/24 [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:57
#                                                    (recursive via H1_MPLS tunnel 10.0.24.3), 02:45:57
#                                                    (recursive via H1_INET1 tunnel 100.64.21.3), 02:45:57
# B       10.2.0.0/24 [200/0] via 10.200.1.253 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:45:57
#                                                    (recursive via H1_MPLS tunnel 10.0.24.3), 02:45:57
#                                                    (recursive via H1_INET1 tunnel 100.64.21.3), 02:45:57
# B       10.4.0.0/24 [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:46:51
#                                                    (recursive via H1_MPLS tunnel 10.0.24.3), 02:46:51
#                                                    (recursive via H1_INET1 tunnel 100.64.21.3), 02:46:51
# C       10.4.1.0/24 is directly connected, port5
# B       10.200.0.0/16 [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 02:46:42
#                                                      (recursive via H1_MPLS tunnel 10.0.24.3), 02:46:42
#                                                      (recursive via H1_INET1 tunnel 100.64.21.3), 02:46:42
# C       10.200.2.1/32 is directly connected, lo-BGP
# S       10.200.2.254/32 [15/0] via H1_INET2 tunnel 10.0.0.1, [1/0]
#                         [15/0] via H1_MPLS tunnel 10.0.24.3, [1/0]
#                         [15/0] via H1_INET1 tunnel 100.64.21.3, [1/0]
# C       100.64.41.0/24 is directly connected, Internet_1
# C       100.64.42.0/24 is directly connected, Internet_2
# C       172.16.31.0/24 is directly connected, port10
{% endif %}

{#============================================================================================================= #}

{% if region == 'West' and branch_id == 1 and FOS >= 7_000_004 and not cross_region_advpn %}
# WEST-BR1 # alias rib
# Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
#        O - OSPF, IA - OSPF inter area
#        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
#        E1 - OSPF external type 1, E2 - OSPF external type 2
#        i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
#        * - candidate default
#
# Routing table for VRF=0
# S*      0.0.0.0/0 [1/0] via 100.64.31.254, Internet_1, [1/0]
#                   [1/0] via 100.64.32.254, Internet_2, [1/0]
#                   [1/0] via H1_INET2 tunnel 10.0.0.1, [10/0]
#                   [1/0] via H2_INET2 tunnel 10.0.0.3, [10/0]
#                   [1/0] via H1_MPLS tunnel 10.0.14.1, [10/0]
#                   [1/0] via H2_MPLS tunnel 10.0.24.2, [10/0]
#                   [1/0] via H1_INET1 tunnel 100.64.11.1, [10/0]
#                   [1/0] via H2_INET1 tunnel 100.64.21.2, [10/0]
# C       10.0.1.0/24 is directly connected, port5
# B       10.0.2.0/24 [200/0] via 10.200.1.2 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:03:33
#                                                  (recursive via H2_MPLS tunnel 10.0.24.2), 00:03:33
#                                                  (recursive via H2_INET1 tunnel 100.64.21.2), 00:03:33
#                     [200/0] via 10.200.1.2 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:03:33
#                                                  (recursive via H1_MPLS tunnel 10.0.14.1), 00:03:33
#                                                  (recursive via H1_INET1 tunnel 100.64.11.1), 00:03:33
# S       10.0.14.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.15.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.24.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.25.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# C       10.0.34.0/24 is directly connected, MPLS
# S       10.0.35.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.44.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# S       10.0.45.0/24 [10/0] via 10.0.34.254, MPLS, [1/0]
# B       10.1.0.0/24 [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:04:26
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 00:04:26
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 00:04:26
# B       10.2.0.0/24 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:28
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:28
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:28
# B       10.4.0.0/14 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:26
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:26
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:26
#                     [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:04:26
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 00:04:26
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 00:04:26
# B       10.200.1.0/24 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:19
#                                                      (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:19
#                                                      (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:19
#                       [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:04:19
#                                                      (recursive via H1_MPLS tunnel 10.0.14.1), 00:04:19
#                                                      (recursive via H1_INET1 tunnel 100.64.11.1), 00:04:19
# C       10.200.1.1/32 is directly connected, lo-BGP
# S       10.200.1.253/32 [15/0] via H2_INET2 tunnel 10.0.0.3, [1/0]
#                         [15/0] via H2_MPLS tunnel 10.0.24.2, [1/0]
#                         [15/0] via H2_INET1 tunnel 100.64.21.2, [1/0]
# S       10.200.1.254/32 [15/0] via H1_INET2 tunnel 10.0.0.1, [1/0]
#                         [15/0] via H1_MPLS tunnel 10.0.14.1, [1/0]
#                         [15/0] via H1_INET1 tunnel 100.64.11.1, [1/0]
# C       100.64.31.0/24 is directly connected, Internet_1
# C       100.64.32.0/24 is directly connected, Internet_2
# C       172.16.31.0/24 is directly connected, port10
{% endif %}

{% if region == 'West' and branch_id == 2 and FOS >= 7_000_004 and not cross_region_advpn %}
# WEST-BR2 # alias rib
# Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
#        O - OSPF, IA - OSPF inter area
#        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
#        E1 - OSPF external type 1, E2 - OSPF external type 2
#        i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
#        * - candidate default
#
# Routing table for VRF=0
# S*      0.0.0.0/0 [1/0] via 100.64.41.254, Internet_1, [1/0]
#                   [1/0] via 100.64.42.254, Internet_2, [1/0]
#                   [1/0] via H1_INET2 tunnel 10.0.0.1, [10/0]
#                   [1/0] via H2_INET2 tunnel 10.0.0.3, [10/0]
#                   [1/0] via H1_MPLS tunnel 10.0.14.1, [10/0]
#                   [1/0] via H2_MPLS tunnel 10.0.24.2, [10/0]
#                   [1/0] via H1_INET1 tunnel 100.64.11.1, [10/0]
#                   [1/0] via H2_INET1 tunnel 100.64.21.2, [10/0]
# B       10.0.1.0/24 [200/0] via 10.200.1.1 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:36
#                                                  (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:36
#                                                  (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:36
#                     [200/0] via 10.200.1.1 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:04:36
#                                                  (recursive via H1_MPLS tunnel 10.0.14.1), 00:04:36
#                                                  (recursive via H1_INET1 tunnel 100.64.11.1), 00:04:36
# C       10.0.2.0/24 is directly connected, port5
# S       10.0.14.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.15.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.24.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.25.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.34.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.35.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# C       10.0.44.0/24 is directly connected, MPLS
# S       10.0.45.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# B       10.1.0.0/24 [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:05:30
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 00:05:30
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 00:05:30
# B       10.2.0.0/24 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:36
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:36
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:36
# B       10.4.0.0/14 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:36
#                                                    (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:36
#                                                    (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:36
#                     [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:04:36
#                                                    (recursive via H1_MPLS tunnel 10.0.14.1), 00:04:36
#                                                    (recursive via H1_INET1 tunnel 100.64.11.1), 00:04:36
# B       10.200.1.0/24 [200/0] via 10.200.1.253 tag 2 (recursive via H2_INET2 tunnel 10.0.0.3), 00:04:36
#                                                      (recursive via H2_MPLS tunnel 10.0.24.2), 00:04:36
#                                                      (recursive via H2_INET1 tunnel 100.64.21.2), 00:04:36
#                       [200/0] via 10.200.1.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:04:36
#                                                      (recursive via H1_MPLS tunnel 10.0.14.1), 00:04:36
#                                                      (recursive via H1_INET1 tunnel 100.64.11.1), 00:04:36
# C       10.200.1.2/32 is directly connected, lo-BGP
# S       10.200.1.253/32 [15/0] via H2_INET2 tunnel 10.0.0.3, [1/0]
#                         [15/0] via H2_MPLS tunnel 10.0.24.2, [1/0]
#                         [15/0] via H2_INET1 tunnel 100.64.21.2, [1/0]
# S       10.200.1.254/32 [15/0] via H1_INET2 tunnel 10.0.0.1, [1/0]
#                         [15/0] via H1_MPLS tunnel 10.0.14.1, [1/0]
#                         [15/0] via H1_INET1 tunnel 100.64.11.1, [1/0]
# C       100.64.41.0/24 is directly connected, Internet_1
# C       100.64.42.0/24 is directly connected, Internet_2
# C       172.16.31.0/24 is directly connected, port10
{% endif %}

{% if region == 'East' and branch_id == 1 and FOS >= 7_000_004 and not cross_region_advpn %}
# EAST-BR1 # alias rib
# Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
#        O - OSPF, IA - OSPF inter area
#        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
#        E1 - OSPF external type 1, E2 - OSPF external type 2
#        i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
#        * - candidate default
#
# Routing table for VRF=0
# S*      0.0.0.0/0 [1/0] via 100.64.41.254, Internet_1, [1/0]
#                   [1/0] via 100.64.42.254, Internet_2, [1/0]
#                   [1/0] via H1_INET2 tunnel 10.0.0.1, [10/0]
#                   [1/0] via H1_MPLS tunnel 10.0.24.3, [10/0]
#                   [1/0] via H1_INET1 tunnel 100.64.21.3, [10/0]
# B       10.0.0.0/14 [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:06:36
#                                                    (recursive via H1_MPLS tunnel 10.0.24.3), 00:06:36
#                                                    (recursive via H1_INET1 tunnel 100.64.21.3), 00:06:36
# S       10.0.14.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.15.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.24.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.25.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.34.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# S       10.0.35.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# C       10.0.44.0/24 is directly connected, MPLS
# S       10.0.45.0/24 [10/0] via 10.0.44.254, MPLS, [1/0]
# B       10.4.0.0/24 [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:06:36
#                                                    (recursive via H1_MPLS tunnel 10.0.24.3), 00:06:36
#                                                    (recursive via H1_INET1 tunnel 100.64.21.3), 00:06:36
# C       10.4.1.0/24 is directly connected, port5
# B       10.200.2.0/24 [200/0] via 10.200.2.254 tag 1 (recursive via H1_INET2 tunnel 10.0.0.1), 00:06:30
#                                                      (recursive via H1_MPLS tunnel 10.0.24.3), 00:06:30
#                                                      (recursive via H1_INET1 tunnel 100.64.21.3), 00:06:30
# C       10.200.2.1/32 is directly connected, lo-BGP
# S       10.200.2.254/32 [15/0] via H1_INET2 tunnel 10.0.0.1, [1/0]
#                         [15/0] via H1_MPLS tunnel 10.0.24.3, [1/0]
#                         [15/0] via H1_INET1 tunnel 100.64.21.3, [1/0]
# C       100.64.41.0/24 is directly connected, Internet_1
# C       100.64.42.0/24 is directly connected, Internet_2
# C       172.16.31.0/24 is directly connected, port10
{% endif %}
