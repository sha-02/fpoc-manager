{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set branch_id = SETTINGS.DEVICES[FMG_FORTIGATE_ID].branch_id %}
    {% set cross_region_advpn = SETTINGS.DEVICES[FMG_FORTIGATE_ID].cross_region_advpn %}
    {% set datacenter = SETTINGS.DEVICES[FMG_FORTIGATE_ID].datacenter %}
    {% set FOS = SETTINGS.DEVICES[FMG_FORTIGATE_ID].FOS %}
    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
{% endif %}

{% set dc1 = '' %}  {# Initialize variables outside of a 'if' block to avoid FMG creating metadata #}
{% set dc2 = '' %}
{% set local_ASN = '' %}

###############################################################################################################
# BGP peerings over VPN overlays

# iBGP between a Branch and its DC
# Edge BGP is used to:
# - learn the local DCs subnet (e.g. BR1/BR2 to learn DC1 and DC2 subnets ; BR3 to learn DC3 subnet)
# - learn a corporate summary (10.0.0.0/14) which covers all subnets
#    . of other branches (within same region or from other region)
#    . DCs from other regions
# - signal SLA status to the Hub (bidirectional sdwan: Hub-side steering)

{%- if region == 'West' -%}
    {%- set local_ASN = 65012 -%}
{%- else -%} {# East region #}
    {%- set local_ASN = 65003 -%}
{%- endif -%}

{# Define the dc-id #}
{%- if region == 'West' -%}
    {%- set dc1 = datacenter.west.first.id -%}
    {%- set dc2 = datacenter.west.second.id -%}
{%- else -%} {# East region #}
    {%- set dc1 = datacenter.east.first.id -%}  {# DC3 #}
    {%- set dc2 = datacenter.east.second.id -%} {# DC4 #}
{%- endif -%}

{# BGP neighbors #}
{% set neighbors = [
    {'ip': '10.201.'~dc1~'.254', 'interface': 'H1_INET1'},
    {'ip': '10.202.'~dc1~'.254', 'interface': 'H1_INET2'},
    {'ip': '10.203.'~dc1~'.254', 'interface': 'H1_MPLS'},
    {'ip': '10.201.'~dc2~'.254', 'interface': 'H2_INET1'},
    {'ip': '10.202.'~dc2~'.254', 'interface': 'H2_INET2'},
    {'ip': '10.203.'~dc2~'.254', 'interface': 'H2_MPLS'},
    ]
%}

{% if bidirectional_sdwan %}
    config router route-map
        edit "SLA_OK"
            config rule
                edit 1
                    set set-community "{{local_ASN}}:1"
                next
            end
        next
        edit "SLA_NOK"
            config rule
                edit 1
                    set set-community "{{local_ASN}}:2"
                next
            end
        next
    end
{% endif %}

config router bgp
    set as {{local_ASN}}
    set router-id 10.0.{{branch_id}}.1
    set keepalive-timer 10
    set holdtime-timer 30
    set ibgp-multipath enable

    set recursive-next-hop disable

    config neighbor
        {% for neighbor in neighbors %}
            edit "{{neighbor.ip}}"
                set interface "{{neighbor.interface}}"
                set remote-as {{local_ASN}}

                set additional-path disable

                set connect-timer 1
                set advertisement-interval 1
                set link-down-failover enable
                set soft-reconfiguration enable

                {% if bidirectional_sdwan %}
                    set route-map-out "SLA_NOK"
                    set route-map-out-preferable "SLA_OK"
                {% endif %}
            next
        {% endfor %}
    end
    config network
        edit 1
            set prefix 10.0.{{branch_id}}.0 255.255.255.0
        next
    end
end

#
# BGP routes
#

{% if branch_id == 1 %}
# FGT-W-BR1 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.0.0/14 [200/0] via 10.201.1.254 (recursive via H1_INET1 tunnel 100.64.11.1 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.202.1.254 (recursive via H1_INET2 tunnel 100.64.12.1 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.203.1.254 (recursive via H1_MPLS tunnel 10.0.14.1 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.201.2.254 (recursive via H2_INET1 tunnel 100.64.21.2 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.202.2.254 (recursive via H2_INET2 tunnel 100.64.22.2 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.203.2.254 (recursive via H2_MPLS tunnel 10.0.24.2 vrf 0), 00:37:29, [1/0]
# B       10.1.0.0/24 [200/0] via 10.201.1.254 (recursive via H1_INET1 tunnel 100.64.11.1 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.202.1.254 (recursive via H1_INET2 tunnel 100.64.12.1 vrf 0), 00:37:29, [1/0]
#                     [200/0] via 10.203.1.254 (recursive via H1_MPLS tunnel 10.0.14.1 vrf 0), 00:37:29, [1/0]
# B       10.2.0.0/24 [200/0] via 10.201.2.254 (recursive via H2_INET1 tunnel 100.64.21.2 vrf 0), 00:37:30, [1/0]
#                     [200/0] via 10.202.2.254 (recursive via H2_INET2 tunnel 100.64.22.2 vrf 0), 00:37:30, [1/0]
#                     [200/0] via 10.203.2.254 (recursive via H2_MPLS tunnel 10.0.24.2 vrf 0), 00:37:30, [1/0]
{% endif %}

{% if branch_id == 2 %}
# FGT-W-BR2 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.0.0/14 [200/0] via 10.201.1.254 (recursive via H1_INET1 tunnel 100.64.11.1 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.202.1.254 (recursive via H1_INET2 tunnel 100.64.12.1 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.203.1.254 (recursive via H1_MPLS tunnel 10.0.14.1 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.201.2.254 (recursive via H2_INET1 tunnel 100.64.21.2 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.202.2.254 (recursive via H2_INET2 tunnel 100.64.22.2 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.203.2.254 (recursive via H2_MPLS tunnel 10.0.24.2 vrf 0), 00:39:40, [1/0]
# B       10.1.0.0/24 [200/0] via 10.201.1.254 (recursive via H1_INET1 tunnel 100.64.11.1 vrf 0), 00:39:41, [1/0]
#                     [200/0] via 10.202.1.254 (recursive via H1_INET2 tunnel 100.64.12.1 vrf 0), 00:39:41, [1/0]
#                     [200/0] via 10.203.1.254 (recursive via H1_MPLS tunnel 10.0.14.1 vrf 0), 00:39:41, [1/0]
# B       10.2.0.0/24 [200/0] via 10.201.2.254 (recursive via H2_INET1 tunnel 100.64.21.2 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.202.2.254 (recursive via H2_INET2 tunnel 100.64.22.2 vrf 0), 00:39:40, [1/0]
#                     [200/0] via 10.203.2.254 (recursive via H2_MPLS tunnel 10.0.24.2 vrf 0), 00:39:40, [1/0]
{% endif %}

{% if branch_id == 3 %}
# FGT-E-BR3 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.0.0/14 [200/0] via 10.201.3.254 (recursive via H1_INET1 tunnel 100.64.21.3 vrf 0), 01:09:38, [1/0]
#                     [200/0] via 10.202.3.254 (recursive via H1_INET2 tunnel 100.64.22.3 vrf 0), 01:09:38, [1/0]
#                     [200/0] via 10.203.3.254 (recursive via H1_MPLS tunnel 10.0.24.3 vrf 0), 01:09:38, [1/0]
# B       10.3.0.0/24 [200/0] via 10.201.3.254 (recursive via H1_INET1 tunnel 100.64.21.3 vrf 0), 01:09:38, [1/0]
#                     [200/0] via 10.202.3.254 (recursive via H1_INET2 tunnel 100.64.22.3 vrf 0), 01:09:38, [1/0]
#                     [200/0] via 10.203.3.254 (recursive via H1_MPLS tunnel 10.0.24.3 vrf 0), 01:09:38, [1/0]
{% endif %}
