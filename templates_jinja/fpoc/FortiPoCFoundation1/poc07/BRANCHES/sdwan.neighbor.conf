{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
    {% set datacenter = SETTINGS.DEVICES[FMG_FORTIGATE_ID].datacenter %}
    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
{% endif %}

###############################################################################################################
# SD-WAN BGP neighbor

{% set dc1 = '' %}  {# Initialize local variables outside of a 'if' block to avoid FMG creating metadata #}
{% set dc2 = '' %}
{% set neighbors = '' %}

{% if bidir_sdwan == 'route_tag' or bidir_sdwan == 'route_priority' %}

{# Define the dc-id #}
{%- if region == 'West' -%}
    {%- set dc1 = datacenter.west.first.id -%}
    {%- set dc2 = datacenter.west.second.id -%}
{%- else -%} {# East region #}
    {%- set dc1 = datacenter.east.first.id -%}  {# DC3 #}
    {%- set dc2 = datacenter.east.second.id -%} {# DC4 #}
{%- endif %}

{% set neighbors = [
    {'ip': '10.201.'~dc1~'.254', 'healthcheck': 'SLA_DataCenters', 'memberid': 11, 'slaid': 1},
    {'ip': '10.202.'~dc1~'.254', 'healthcheck': 'SLA_DataCenters', 'memberid': 12, 'slaid': 1},
    {'ip': '10.203.'~dc1~'.254', 'healthcheck': 'SLA_DataCenters', 'memberid': 13, 'slaid': 1},
    {'ip': '10.201.'~dc2~'.254', 'healthcheck': 'SLA_DataCenters', 'memberid': 21, 'slaid': 1},
    {'ip': '10.202.'~dc2~'.254', 'healthcheck': 'SLA_DataCenters', 'memberid': 22, 'slaid': 1},
    {'ip': '10.203.'~dc2~'.254', 'healthcheck': 'SLA_DataCenters', 'memberid': 23, 'slaid': 1},
    ]
%}

config system sdwan
    config neighbor
        {% for neighbor in neighbors %}
            edit "{{neighbor.ip}}"
                set member {{neighbor.memberid}}
                set health-check "{{neighbor.healthcheck}}"
                set sla-id {{neighbor.slaid}}
            next
        {% endfor %}
    end
end
{% endif %}

