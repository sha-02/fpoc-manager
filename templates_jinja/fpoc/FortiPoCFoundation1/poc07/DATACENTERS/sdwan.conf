{% if FMG_FORTIGATE_ID %}
    {% import 'SETTINGS.DEVICES' as SETTINGS with context %}

    {% set region = SETTINGS.DEVICES[FMG_FORTIGATE_ID].region %}
    {% set wan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].wan %}
    {% set bidir_sdwan = SETTINGS.DEVICES[FMG_FORTIGATE_ID].bidir_sdwan %}
{% endif %}

###############################################################################################################
# SD-WAN manual rules for ADVPN "domain" routing strategy (overlay stickiness)

# SD-WAN manual rules for ADVPN inter-region stickiness to guarantee that traffic initiated by a branch over an overlay
# (e.g., INET1) is forwarded inter-region through the INET1 overlays (DC to DC, and then DC to edge)

{% if bidir_sdwan == 'route_tag' %}
# ADVPN Rules are based on SLA feedback from Branch
# Rules 121, 122, 222, 221 try to keep shortcut negotiation within the Internet domain
# Rule 323 tries to keep shortcut negotiation within the MPLS domain

# Rules 11,12,13,14 are based on SLA feedback from Branch as well
# They are used:
# - as best-effort when the ADVPN fail.
#    for e.g., traffic received on INET1 cannot be forwarded INET1/INET2 because of SLA issues
#    in this case traffic must not hit FIB (uncontrolled decision) and must be go via MPLS -> rule 13 will be hit
#    if MPLS is bad SLA as well then all overlays are bad (INET1/INET2/MPLS) and rule 14 is hit -> INET1 is selected
# - for traffic from the DC itself to a Branch
# - for traffic from other region to a Branch
{% endif %}

config system sdwan
    set status enable
    config zone
        edit "internet"
        next
        edit "branches"
        next
        edit "inter-regions"
        next
    end
    config members
        edit 1
            set interface "EDGE_INET1"
            set zone "branches"
        next
        edit 2
            set interface "EDGE_INET2"
            set zone "branches"
        next
        edit 3
            set interface "EDGE_MPLS"
            set zone "branches"
        next
        edit 201
            set interface "Internet_1"
            set gateway {{wan.inet1.subnet}}.254
            set zone "internet"
        next
        edit 202
            set interface "Internet_2"
            set gateway {{wan.inet2.subnet}}.254
            set zone "internet"
        next
        {% if region == 'West' %}
            edit 131
                set interface "EAST_DC3_INET1"
                set zone "inter-regions"
            next
            edit 132
                set interface "EAST_DC3_INET2"
                set zone "inter-regions"
            next
            edit 133
                set interface "EAST_DC3_MPLS"
                set zone "inter-regions"
            next
        {% else %} {# East region #}
            edit 131
                set interface "WEST_DC1_INET1"
                set zone "inter-regions"
            next
            edit 132
                set interface "WEST_DC1_INET2"
                set zone "inter-regions"
            next
            edit 133
                set interface "WEST_DC1_MPLS"
                set zone "inter-regions"
            next
            edit 231
                set interface "WEST_DC2_INET1"
                set zone "inter-regions"
            next
            edit 232
                set interface "WEST_DC2_INET2"
                set zone "inter-regions"
            next
            edit 233
                set interface "WEST_DC2_MPLS"
                set zone "inter-regions"
            next
        {% endif %}
    end
    config health-check
        edit "SLA_Internet"
            set server "198.18.8.8"
            set sla-fail-log-period 10
            set sla-pass-log-period 10
            set members 201 202
            config sla
                edit 1
                    set latency-threshold 150
                    set jitter-threshold 30
                    set packetloss-threshold 2
                next
            end
        next
    end
    config service
        {% if bidir_sdwan == 'route_tag' %}
            edit 121
                set name "INET1_TO_EDGE_INET1_SLA_OK"
                {% if region == 'West' %}
                    set input-device "EDGE_INET1" "EAST_DC3_INET1"
                {% else %} {# East region #}
                    set input-device "EDGE_INET1" "WEST_DC1_INET1" "WEST_DC2_INET1"
                {% endif %}
                set src "all"
                set route-tag 1
                set priority-members 1
            next
            edit 122
                set name "INET1_TO_EDGE_INET2_SLA_OK"
                {% if region == 'West' %}
                    set input-device "EDGE_INET1" "EAST_DC3_INET1"
                {% else %} {# East region #}
                    set input-device "EDGE_INET1" "WEST_DC1_INET1" "WEST_DC2_INET1"
                {% endif %}
                set src "all"
                set route-tag 1
                set priority-members 2
            next
            edit 222
                set name "INET2_TO_EDGE_INET2_SLA_OK"
                {% if region == 'West' %}
                    set input-device "EDGE_INET2" "EAST_DC3_INET2"
                {% else %} {# East region #}
                    set input-device "EDGE_INET2" "WEST_DC1_INET2" "WEST_DC2_INET2"
                {% endif %}
                set src "all"
                set route-tag 1
                set priority-members 2
            next
            edit 221
                set name "INET2_TO_EDGE_INET1_SLA_OK"
                {% if region == 'West' %}
                    set input-device "EDGE_INET2" "EAST_DC3_INET2"
                {% else %} {# East region #}
                    set input-device "EDGE_INET2" "WEST_DC1_INET2" "WEST_DC2_INET2"
                {% endif %}
                set src "all"
                set route-tag 1
                set priority-members 1
            next
            edit 323
                set name "MPLS_TO_EDGE_MPLS_SLA_OK"
                {% if region == 'West' %}
                    set input-device "EDGE_MPLS" "EAST_DC3_MPLS"
                {% else %} {# East region #}
                    set input-device "EDGE_MPLS" "WEST_DC1_MPLS" "WEST_DC2_MPLS"
                {% endif %}
                set src "all"
                set route-tag 1
                set priority-members 3
            next
            edit 11
                set name "TO_EDGE_INET1_SLA_OK"
                set src "all"
                set route-tag 1
                set priority-members 1
            next
            edit 12
                set name "TO_EDGE_INET2_SLA_OK"
                set src "all"
                set route-tag 1
                set priority-members 2
            next
            edit 13
                set name "TO_EDGE_MPLS_SLA_OK"
                set src "all"
                set route-tag 1
                set priority-members 3
            next
            edit 14
                set name "TO_EDGE_SLA_NOK"
                set src "all"
                set route-tag 2
                set priority-members 1 2 3
            next
        {% else %} {# no BGP route-tags #}
            {% if region == 'West' %}
                edit 7
                    set name "EAST_to_EDGE_INET1"
                    set input-device "EAST_DC3_INET1"
                    set src "all"
                    set dst "all"
                    set priority-members 1
                next
                edit 8
                    set name "EAST_to_EDGE_INET2"
                    set input-device "EAST_DC3_INET2"
                    set src "all"
                    set dst "all"
                    set priority-members 2
                next
                edit 9
                    set name "EAST_to_EDGE_MPLS"
                    set input-device "EAST_DC3_MPLS"
                    set src "all"
                    set dst "all"
                    set priority-members 3
                next
            {% else %} {# East region #}
                edit 7
                    set name "WEST_to_EDGE_INET1"
                    set input-device "WEST_DC1_INET1" "WEST_DC2_INET1"
                    set src "all"
                    set dst "all"
                    set priority-members 1
                next
                edit 8
                    set name "WEST_to_EDGE_INET2"
                    set input-device "WEST_DC1_INET2" "WEST_DC2_INET2"
                    set src "all"
                    set dst "all"
                    set priority-members 2
                next
                edit 9
                    set name "WEST_to_EDGE_MPLS"
                    set input-device "WEST_DC1_MPLS" "WEST_DC2_MPLS"
                    set src "all"
                    set dst "all"
                    set priority-members 3
                next
            {% endif %}
        {% endif %}
            edit 4
                set input-device "EDGE_INET1"
                set src "all"
                set dst "all"
                {% if region == 'West' %}
                    set name "EDGE_INET1_to_EAST"
                    set priority-members 131
                {% else %} {# East region #}
                    set name "EDGE_INET1_to_WEST"
                    set priority-members 131 231
                {% endif %}
            next
            edit 5
                set input-device "EDGE_INET2"
                set src "all"
                set dst "all"
                {% if region == 'West' %}
                    set name "EDGE_INET2_to_EAST"
                    set priority-members 132
                {% else %} {# East region #}
                    set name "EDGE_INET2_to_WEST"
                    set priority-members 132 232
                {% endif %}
            next
            edit 6
                set input-device "EDGE_MPLS"
                set src "all"
                set dst "all"
                {% if region == 'West' %}
                    set name "EDGE_MPLS_to_EAST"
                    set priority-members 133
                {% else %} {# East region #}
                    set name "EDGE_MPLS_to_WEST"
                    set priority-members 133 233
                {% endif %}
            next

        edit 20
            set name "Internet"
            set mode sla
            set src "Corporate"
            set dst "all"
            config sla
                edit "SLA_Internet"
                    set id 1
                next
            end
            set priority-members 201 202
        next
    end
end
