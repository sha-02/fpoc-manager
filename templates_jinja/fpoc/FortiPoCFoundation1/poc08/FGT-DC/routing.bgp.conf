# BGP peering over VPNs
# default BGP timers (1min/3min)for advpn3 (LTE overlay)
# Advertise overlay subnets via BGP since BGP NH recursion via BGP is available as of 7.0

config router bgp
    set as 65000
    set router-id 192.168.3.3
    set ibgp-multipath enable
    set additional-path enable
    set additional-path-select 4
    set keepalive-timer 10
    set holdtime-timer 30
    {% if HA_FGCP %}
        set network-import-check disable
        set graceful-restart enable
        set graceful-end-on-timer enable
        set graceful-restart-time 180
        set graceful-update-delay 150
    {% endif %}
    config aggregate-address
        edit 1
            set prefix 10.255.1.0 255.255.255.0
            set summary-only enable
        next
        edit 2
            set prefix 10.255.2.0 255.255.255.0
            set summary-only enable
        next
        edit 3
            set prefix 10.255.3.0 255.255.255.0
            set summary-only enable
        next
        edit 4
            set prefix 10.255.4.0 255.255.255.0
            set summary-only enable
        next
    end
    config neighbor-group
        edit "advpn1"
            set interface "advpn1"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            {% if HA_FGCP %}
                set capability-graceful-restart enable
                set link-down-failover enable
                set stale-route enable
                set passive enable
            {% endif %}
        next
        edit "advpn2"
            set interface "advpn2"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            {% if HA_FGCP %}
                set capability-graceful-restart enable
                set link-down-failover enable
                set stale-route enable
                set passive enable
            {% endif %}
        next
        edit "advpn3"
            set interface "advpn3"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set keep-alive-timer 60
            set holdtime-timer 180
            set route-reflector-client enable
            set advertisement-interval 1
            {% if HA_FGCP %}
                set capability-graceful-restart enable
                set link-down-failover enable
                set stale-route enable
                set passive enable
            {% endif %}
        next
        edit "advpn4"
            set interface "advpn4"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            {% if HA_FGCP %}
                set capability-graceful-restart enable
                set link-down-failover enable
                set stale-route enable
                set passive enable
            {% endif %}
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.255.1.0 255.255.255.0
            set neighbor-group "advpn1"
        next
        edit 2
            set prefix 10.255.2.0 255.255.255.0
            set neighbor-group "advpn2"
        next
        edit 3
            set prefix 10.255.3.0 255.255.255.0
            set neighbor-group "advpn3"
        next
        edit 4
            set prefix 10.255.4.0 255.255.255.0
            set neighbor-group "advpn4"
        next
    end
    config network
        edit 1
            set prefix 192.168.3.0 255.255.255.0
        next
        edit 2
            set prefix 10.255.1.254 255.255.255.255
        next
        edit 3
            set prefix 10.255.2.254 255.255.255.255
        next
        edit 4
            set prefix 10.255.3.254 255.255.255.255
        next
        edit 5
            set prefix 10.255.4.254 255.255.255.255
        next
    end
end

{% if vrf_aware_overlay and FOS >= 7_002_000 %}
# VRF-aware overlay
# VRF 0 is used as PE VRF to carry vpnv4 prefixes and is also used as CE VRF (port5)
# VRF 1-3 are CE VRFs (vlans over port5)

    config router bgp
        set additional-path-vpnv4 enable
        set additional-path-select-vpnv4 4
        config neighbor-group
            edit "advpn1"
                set additional-path-vpnv4 send
                set adv-additional-path-vpnv4 4
                set route-reflector-client-vpnv4 enable
            next
            edit "advpn2"
                set additional-path-vpnv4 send
                set adv-additional-path-vpnv4 4
                set route-reflector-client-vpnv4 enable
            next
            edit "advpn3"
                set additional-path-vpnv4 send
                set adv-additional-path-vpnv4 4
                set route-reflector-client-vpnv4 enable
            next
            edit "advpn4"
                set additional-path-vpnv4 send
                set adv-additional-path-vpnv4 4
                set route-reflector-client-vpnv4 enable
            next
        end
        config network
            edit 11
                set prefix 192.168.13.0 255.255.255.0
            next
            edit 12
                set prefix 192.168.23.0 255.255.255.0
            next
            edit 13
                set prefix 192.168.33.0 255.255.255.0
            next
        end
        config vrf
            edit "0"
                set role pe
            next
            edit "1"
                set role ce
                set rd "65000:1"
                set export-rt "65000:1"
                set import-rt "65000:1"
            next
            edit "2"
                set role ce
                set rd "65000:2"
                set export-rt "65000:2"
                set import-rt "65000:2"
            next
            edit "3"
                set role ce
                set rd "65000:3"
                set export-rt "65000:3"
                set import-rt "65000:3"
            next
        end
    end
{% endif %}