
# BGP peerings

# "additional-path-select 6" because
# - each Branch advertise its subnet with up to 3 different BGP NH
# - but there are 6 overlays with DC1/DC2: 6 different BGP NH can be received from BR1/BR2 via DC1/DC2
# The 6 BGP NH of BR1/BR2 must be sent to BR3 via each overlay. Hence "set adv-additional-path 6" for the edge peering

{% set local_ASN=local_ASN_FOS7 %}
{% set remote_ASN=remote_ASN_FOS7 %}

config router bgp
    set as {{local_ASN}}
    set router-id 10.{{dc_id}}.0.1
    set ibgp-multipath enable
    set ebgp-multipath enable
    set additional-path enable

    set additional-path-select 6

    set keepalive-timer 10
    set holdtime-timer 30

    set recursive-next-hop enable
    config aggregate-address
        edit 1
            set prefix 10.201.0.0 255.255.0.0
            set summary-only disable
        next
        edit 2
            set prefix 10.202.0.0 255.255.0.0
            set summary-only disable
        next
        edit 3
            set prefix 10.203.0.0 255.255.0.0
            set summary-only disable
        next
        edit 4
            set prefix 10.200.0.0 255.252.0.0
            set summary-only disable
        next
    end

    config neighbor
        edit "10.201.13.1"
            set interface "W1E3_INET1"
            set remote-as {{remote_ASN}}
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET1_OUT"
        next
        edit "10.202.13.1"
            set interface "W1E3_INET2"
            set remote-as {{remote_ASN}}
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET2_OUT"
        next
        edit "10.203.13.1"
            set interface "W1E3_MPLS"
            set remote-as {{remote_ASN}}
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_MPLS_OUT"
        next
        edit "10.201.23.1"
            set interface "W2E3_INET1"
            set remote-as {{remote_ASN}}
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET1_OUT"
        next
        edit "10.202.23.1"
            set interface "W2E3_INET2"
            set remote-as {{remote_ASN}}
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_INET2_OUT"
        next
        edit "10.203.23.1"
            set interface "W2E3_MPLS"
            set remote-as {{remote_ASN}}
            set attribute-unchanged next-hop
            set ebgp-enforce-multihop enable

            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable
            set connect-timer 1

            set additional-path both
            set adv-additional-path 6
            set route-map-out "RM_REGION_MPLS_OUT"
        next
    end
    config neighbor-group
        edit "EDGE_INET1"
            set interface "EDGE_INET1"
            set update-source "EDGE_INET1"
            set remote-as {{local_ASN}}
            set additional-path send

            set adv-additional-path 6

            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable

            set route-map-out "RM_EDGE_INET1_OUT"
        next
        edit "EDGE_INET2"
            set interface "EDGE_INET2"
            set update-source "EDGE_INET2"
            set remote-as {{local_ASN}}
            set additional-path send

            set adv-additional-path 6

            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable

            set route-map-out "RM_EDGE_INET2_OUT"
        next
        edit "EDGE_MPLS"
            set interface "EDGE_MPLS"
            set update-source "EDGE_MPLS"
            set remote-as {{local_ASN}}
            set additional-path send

            set adv-additional-path 6

            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set soft-reconfiguration enable

            set route-map-out "RM_EDGE_MPLS_OUT"
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.201.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_INET1"
        next
        edit 2
            set prefix 10.202.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_INET2"
        next
        edit 3
            set prefix 10.203.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_MPLS"
        next
    end
    config network
        edit 1
            set prefix 10.{{dc_id}}.0.0 255.255.255.0
            set route-map "RM_LOCAL_TAG"
        next
        edit 2
            set prefix 10.201.{{dc_id}}.0 255.255.255.0
        next
        edit 3
            set prefix 10.202.{{dc_id}}.0 255.255.255.0
        next
        edit 4
            set prefix 10.203.{{dc_id}}.0 255.255.255.0
        next
    end
end

#
# BGP routes
#

# FGT-E-DC3 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.1.0/24 [200/0] via 10.201.1.1 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:32:33
#                     [200/0] via 10.201.2.1 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:32:33
#                     [200/0] via 10.202.1.1 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:32:33
#                     [200/0] via 10.202.2.1 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:32:33
#                     [200/0] via 10.203.1.1 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:32:33
#                     [200/0] via 10.203.2.1 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:32:33
# B       10.0.2.0/24 [200/0] via 10.201.1.2 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:32:33
#                     [200/0] via 10.201.2.2 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:32:33
#                     [200/0] via 10.202.1.2 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:32:33
#                     [200/0] via 10.202.2.2 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:32:33
#                     [200/0] via 10.203.1.2 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:32:33
#                     [200/0] via 10.203.2.2 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:32:33
# B       10.0.3.0/24 [200/0] via 10.201.3.1 (recursive via EDGE_INET1 tunnel 10.201.3.1), 00:33:20
#                     [200/0] via 10.202.3.1 (recursive via EDGE_INET2 tunnel 10.202.3.1), 00:33:20
#                     [200/0] via 10.203.3.1 (recursive via EDGE_MPLS tunnel 10.203.3.1), 00:33:20
# B       10.1.0.0/24 [200/0] via 10.201.13.1 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:33:20
#                     [200/0] via 10.202.13.1 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:33:20
#                     [200/0] via 10.203.13.1 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:33:20
# B       10.2.0.0/24 [200/0] via 10.201.23.1 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:33:22
#                     [200/0] via 10.202.23.1 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:33:22
#                     [200/0] via 10.203.23.1 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:33:22
# B       10.200.0.0/14 [200/0] is a summary, Null, 00:33:25
# B       10.201.0.0/16 [200/0] is a summary, Null, 00:33:25
# B       10.201.1.0/24 [200/0] via 10.201.13.1 (recursive via W1E3_INET1 tunnel 100.64.11.1), 00:33:25
# B       10.201.2.0/24 [200/0] via 10.201.23.1 (recursive via W2E3_INET1 tunnel 100.64.21.2), 00:33:22
# B       10.202.0.0/16 [200/0] is a summary, Null, 00:33:25
# B       10.202.1.0/24 [200/0] via 10.202.13.1 (recursive via W1E3_INET2 tunnel 100.64.12.1), 00:33:23
# B       10.202.2.0/24 [200/0] via 10.202.23.1 (recursive via W2E3_INET2 tunnel 100.64.22.2), 00:33:25
# B       10.203.0.0/16 [200/0] is a summary, Null, 00:33:25
# B       10.203.1.0/24 [200/0] via 10.203.13.1 (recursive via W1E3_MPLS tunnel 10.0.14.1), 00:33:20
# B       10.203.2.0/24 [200/0] via 10.203.23.1 (recursive via W2E3_MPLS tunnel 10.0.24.2), 00:33:25
