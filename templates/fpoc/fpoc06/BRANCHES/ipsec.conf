# IPsec

################ First DataCenter #############################################################

config vpn ipsec phase1-interface
    edit "H1_INET1"
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        {% if region == 'West' %}
            set network-id {{datacenter.west.first.id}}1
        {% else %} {# East region #}
            set network-id {{datacenter.east.first.id}}1
        {% endif %}
        set peertype any
        set localid "{{region|upper}}-BR{{branch_id}}_INET1"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        set mode-cfg enable
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        {% if region == 'West' %}
            set remote-gw {{datacenter.west.first.inet1}}
        {% else %} {# East region #}
            set remote-gw {{datacenter.east.first.inet1}}
        {% endif %}
        {% if region == 'West' %} {# The PSK is 3x times the network-id #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.west.first.id}}1{% endfor %}
        {% else %} {# East region #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.east.first.id}}1{% endfor %}
        {% endif %}
    next
end

config vpn ipsec phase2-interface
    edit "H1_INET1"
        set phase1name "H1_INET1"
        set keepalive enable
    next
end

config system interface
    edit "H1_INET1"
        set allowaccess ping
    next
end


####

config vpn ipsec phase1-interface
    edit "H1_INET2"
        set interface "Internet_2"
        set ike-version 2
        set network-overlay enable
        {% if region == 'West' %}
            set network-id {{datacenter.west.first.id}}2
        {% else %} {# East region #}
            set network-id {{datacenter.east.first.id}}2
        {% endif %}
        set peertype any
        set localid "{{region|upper}}-BR{{branch_id}}_INET2"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        set mode-cfg enable
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        {% if region == 'West' %}
            set remote-gw {{datacenter.west.first.inet2}}
        {% else %} {# East region #}
            set remote-gw {{datacenter.east.first.inet2}}
        {% endif %}
        {% if region == 'West' %} {# The PSK is 3x times the network-id #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.west.first.id}}2{% endfor %}
        {% else %} {# East region #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.east.first.id}}2{% endfor %}
        {% endif %}
    next
end

config vpn ipsec phase2-interface
    edit "H1_INET2"
        set phase1name "H1_INET2"
        set keepalive enable
    next
end

config system interface
    edit "H1_INET2"
        set allowaccess ping
    next
end


####

config vpn ipsec phase1-interface
    edit "H1_MPLS"
        set interface "MPLS"
        set ike-version 2
        set network-overlay enable
        {% if region == 'West' %}
            set network-id {{datacenter.west.first.id}}3
        {% else %} {# East region #}
            set network-id {{datacenter.east.first.id}}3
        {% endif %}
        set peertype any
        set localid "{{region|upper}}-BR{{branch_id}}_MPLS"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        set mode-cfg enable
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        {% if region == 'West' %}
            set remote-gw {{datacenter.west.first.mpls}}
        {% else %} {# East region #}
            set remote-gw {{datacenter.east.first.mpls}}
        {% endif %}
        {% if region == 'West' %} {# The PSK is 3x times the network-id #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.west.first.id}}3{% endfor %}
        {% else %} {# East region #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.east.first.id}}3{% endfor %}
        {% endif %}
    next
end

config vpn ipsec phase2-interface
    edit "H1_MPLS"
        set phase1name "H1_MPLS"
        set keepalive enable
    next
end

config system interface
    edit "H1_MPLS"
        set allowaccess ping
    next
end

################ Second DataCenter ###########################################################

config vpn ipsec phase1-interface
    edit "H2_INET1"
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        {% if region == 'West' %}
            set network-id {{datacenter.west.second.id}}1
        {% else %} {# East region #}
            set network-id {{datacenter.east.second.id}}1
        {% endif %}
        set peertype any
        set localid "{{region|upper}}-BR{{branch_id}}_INET1"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        set mode-cfg enable
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        {% if region == 'West' %}
            set remote-gw {{datacenter.west.second.inet1}}
        {% else %} {# East region #}
            set remote-gw {{datacenter.east.second.inet1}}
        {% endif %}
        {% if region == 'West' %} {# The PSK is 3x times the network-id #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.west.second.id}}1{% endfor %}
        {% else %} {# East region #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.east.second.id}}1{% endfor %}
        {% endif %}
    next
end

config vpn ipsec phase2-interface
    edit "H2_INET1"
        set phase1name "H2_INET1"
        set keepalive enable
    next
end

config system interface
    edit "H2_INET1"
        set allowaccess ping
        {% if region == 'East' %}
            set status down
        {% endif %}
    next
end


####

config vpn ipsec phase1-interface
    edit "H2_INET2"
        set interface "Internet_2"
        set ike-version 2
        set network-overlay enable
        {% if region == 'West' %}
            set network-id {{datacenter.west.second.id}}2
        {% else %} {# East region #}
            set network-id {{datacenter.east.second.id}}2
        {% endif %}
        set peertype any
        set localid "{{region|upper}}-BR{{branch_id}}_INET2"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        set mode-cfg enable
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        {% if region == 'West' %}
            set remote-gw {{datacenter.west.second.inet2}}
        {% else %} {# East region #}
            set remote-gw {{datacenter.east.second.inet2}}
        {% endif %}
        {% if region == 'West' %} {# The PSK is 3x times the network-id #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.west.second.id}}2{% endfor %}
        {% else %} {# East region #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.east.second.id}}2{% endfor %}
        {% endif %}
    next
end

config vpn ipsec phase2-interface
    edit "H2_INET2"
        set phase1name "H2_INET2"
        set keepalive enable
    next
end

config system interface
    edit "H2_INET2"
        set allowaccess ping
        {% if region == 'East' %}
            set status down
        {% endif %}
    next
end


####

config vpn ipsec phase1-interface
    edit "H2_MPLS"
        set interface "MPLS"
        set ike-version 2
        set network-overlay enable
        {% if region == 'West' %}
            set network-id {{datacenter.west.second.id}}3
        {% else %} {# East region #}
            set network-id {{datacenter.east.second.id}}3
        {% endif %}
        set peertype any
        set localid "{{region|upper}}-BR{{branch_id}}_MPLS"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        set mode-cfg enable
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        {% if region == 'West' %}
            set remote-gw {{datacenter.west.second.mpls}}
        {% else %} {# East region #}
            set remote-gw {{datacenter.east.second.mpls}}
        {% endif %}
        {% if region == 'West' %} {# The PSK is 3x times the network-id #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.west.second.id}}3{% endfor %}
        {% else %} {# East region #}
            set psksecret {% for x in ""|ljust:"3" %}{{datacenter.east.second.id}}3{% endfor %}
        {% endif %}
    next
end

config vpn ipsec phase2-interface
    edit "H2_MPLS"
        set phase1name "H2_MPLS"
        set keepalive enable
    next
end

config system interface
    edit "H2_MPLS"
        set allowaccess ping
        {% if region == 'East' %}
            set status down
        {% endif %}
    next
end
