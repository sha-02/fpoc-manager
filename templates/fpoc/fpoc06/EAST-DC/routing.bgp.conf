# BGP peering over VPNs

# Cross-region shortcuts are part of this design which complicates things.
# We need to ensure BGP NH are preserved (iBGP or eBGP 'next-hop unchanged')
# BR3 must receive each of the 6 BGP NH of BR1/BR2
#
# Without cross-region shortcuts, regular eBGP (no BGP NH preservation) would be used
# and there would be no need for BGP add-path as well
# Prefixes for BR1/BR2 learned by BR3 could have DC3 IP (next-hop-self with the iBGP peering)
# or could have DC1/DC2 IP (from eBGP peering between DC1/DC2 and DC3)
# Only thing which would matter is to reach BR1/BR2 via DC3 INET1/INET2/MPLS and DC3 would take care of the rest


{% if FOS >= 7_000_000 %}
    # Advertise overlay subnets via BGP since BGP NH recursion via BGP is available as of 7.0
{% endif %}

# Overlay subnets of the INET1, INET2, MPLS tunnels

config router prefix-list
    edit "PFL_NH_INET1"
        config rule
            edit 1
                set prefix 10.201.0.0 255.255.0.0
                unset ge
                set le 32
            next
        end
    next
    edit "PFL_NH_INET2"
        config rule
            edit 1
                set prefix 10.202.0.0 255.255.0.0
                unset ge
                set le 32
            next
        end
    next
    edit "PFL_NH_MPLS"
        config rule
            edit 1
                set prefix 10.203.0.0 255.255.0.0
                unset ge
                set le 32
            next
        end
    next
end

# Overlay stickiness is done for inter-region advertisement

config router route-map
    edit "RM_INET1_OUT"
        config rule
            edit 1
                set match-ip-nexthop "PFL_NH_INET1"
            next
        end
    next
    edit "RM_INET2_OUT"
        config rule
            edit 1
                set match-ip-nexthop "PFL_NH_INET2"
            next
        end
    next
    edit "RM_MPLS_OUT"
        config rule
            edit 1
                set match-ip-nexthop "PFL_NH_MPLS"
            next
        end
    next
end

# "additional-path-select 6" because
# - each Branch advertise its subnet with up to 3 different BGP NH
# - but there are 6 overlays with DC1/DC2: 6 different BGP NH can be received from BR1/BR2 via DC1/DC2
# The 6 BGP NH of BR1/BR2 must be sent to BR3 via each overlay. Hence "set adv-additional-path 6" for the edge peering

config router bgp
    set as 65000
    set router-id 10.{{dc_id}}.0.1
    set ibgp-multipath enable
    set additional-path enable
    set additional-path-select 6
    set keepalive-timer 10
    set holdtime-timer 30
    {% if FOS >= 7_000_000 %}
        config aggregate-address
            edit 1
                set prefix 10.201.{{dc_id}}.0 255.255.255.0
                set summary-only enable
            next
            edit 2
                set prefix 10.202.{{dc_id}}.0 255.255.255.0
                set summary-only enable
            next
            edit 3
                set prefix 10.203.{{dc_id}}.0 255.255.255.0
                set summary-only enable
            next
        end
    {% endif %}
    config neighbor
        edit "10.201.13.1"
            set interface "W1E3_INET1"
            set remote-as 65000
            set additional-path both
            set adv-additional-path 6
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            set route-map-out "RM_INET1_OUT"
        next
        edit "10.202.13.1"
            set interface "W1E3_INET2"
            set remote-as 65000
            set additional-path both
            set adv-additional-path 6
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            set route-map-out "RM_INET2_OUT"
        next
        edit "10.203.13.1"
            set interface "W1E3_MPLS"
            set remote-as 65000
            set additional-path both
            set adv-additional-path 6
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            set route-map-out "RM_MPLS_OUT"
        next
        edit "10.201.23.1"
            set interface "W2E3_INET1"
            set remote-as 65000
            set additional-path both
            set adv-additional-path 6
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            set route-map-out "RM_INET1_OUT"
        next
        edit "10.202.23.1"
            set interface "W2E3_INET2"
            set remote-as 65000
            set additional-path both
            set adv-additional-path 6
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            set route-map-out "RM_INET2_OUT"
        next
        edit "10.203.23.1"
            set interface "W2E3_MPLS"
            set remote-as 65000
            set additional-path both
            set adv-additional-path 6
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            set route-map-out "RM_MPLS_OUT"
        next
    end
    config neighbor-group
        edit "EDGE_INET1"
            set interface "EDGE_INET1"
            set update-source "EDGE_INET1"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 6
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
        next
        edit "EDGE_INET2"
            set interface "EDGE_INET2"
            set update-source "EDGE_INET2"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 6
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
        next
        edit "EDGE_MPLS"
            set interface "EDGE_MPLS"
            set update-source "EDGE_MPLS"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 6
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.201.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_INET1"
        next
        edit 2
            set prefix 10.202.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_INET2"
        next
        edit 3
            set prefix 10.203.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_MPLS"
        next
    end
    config network
        edit 1
            set prefix 10.{{dc_id}}.0.0 255.255.255.0
        next
        {% if FOS >= 7_000_000 %}
            edit 2
                set prefix 10.201.{{dc_id}}.254 255.255.255.255
            next
            edit 3
                set prefix 10.202.{{dc_id}}.254 255.255.255.255
            next
            edit 4
                set prefix 10.203.{{dc_id}}.254 255.255.255.255
            next
        {% endif %}
    end
end
