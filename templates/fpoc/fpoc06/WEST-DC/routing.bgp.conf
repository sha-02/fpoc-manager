# BGP peerings

{% if FOS >= 7_000_000 %}
    # Advertise overlay subnets via BGP since BGP NH recursion via BGP is available as of 7.0
{% endif %}

# "additional-path-select 3" because
# - each Branch advertise its subnet with up to 3 different BGP NH
# - there are 3 overlays with DC3

config router bgp
    set as {{west_ASN}}
    set router-id 10.{{dc_id}}.0.1
    set ibgp-multipath enable
    set additional-path enable
    set additional-path-select 3
    set keepalive-timer 10
    set holdtime-timer 30
    {% if cross_region_advpn and FOS >= 7_000_000 %}
        set recursive-next-hop enable
        config aggregate-address
            edit 1
                set prefix 10.201.0.0 255.255.0.0
                set summary-only disable
            next
            edit 2
                set prefix 10.202.0.0 255.255.0.0
                set summary-only disable
            next
            edit 3
                set prefix 10.203.0.0 255.255.0.0
                set summary-only disable
            next
            edit 4
                set prefix 10.200.0.0 255.252.0.0
                set summary-only disable
            next
        end
    {% endif %}
    {% if not cross_region_advpn %}
        set ebgp-multipath enable
        {% if FOS >= 7_000_000 %}
            config aggregate-address
                edit 1
                    set prefix 10.0.0.0 255.252.0.0
                next
                edit 2
                    set prefix 10.200.0.0 255.252.0.0
                    set summary-only enable
                next
            end
        {% endif %}
    {% endif %}
    config neighbor
        edit "10.201.{{dc_id}}3.2"
            set interface "W{{dc_id}}E3_INET1"
            set remote-as {{east_ASN}}
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            {% if cross_region_advpn %}
                set additional-path both
                set adv-additional-path 3
                set route-map-out "RM_REGION_INET1_OUT"
            {% else %} {# no cross-region shortcuts #}
                set route-map-in "RM_REGION_IN"
                set route-map-out "RM_REGION_OUT"
            {% endif %}
        next
        edit "10.202.{{dc_id}}3.2"
            set interface "W{{dc_id}}E3_INET2"
            set remote-as {{east_ASN}}
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            {% if cross_region_advpn %}
                set additional-path both
                set adv-additional-path 3
                set route-map-out "RM_REGION_INET2_OUT"
            {% else %} {# no cross-region shortcuts #}
                set route-map-in "RM_REGION_IN"
                set route-map-out "RM_REGION_OUT"
            {% endif %}
        next
        edit "10.203.{{dc_id}}3.2"
            set interface "W{{dc_id}}E3_MPLS"
            set remote-as {{east_ASN}}
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            set connect-timer 1
            {% if cross_region_advpn %}
                set additional-path both
                set adv-additional-path 3
                set route-map-out "RM_REGION_MPLS_OUT"
            {% else %} {# no cross-region shortcuts #}
                set route-map-in "RM_REGION_IN"
                set route-map-out "RM_REGION_OUT"
            {% endif %}
        next
    end
    config neighbor-group
        edit "EDGE_INET1"
            set interface "EDGE_INET1"
            set update-source "EDGE_INET1"
            set remote-as {{west_ASN}}
            set additional-path send
            set adv-additional-path 3
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            {% if cross_region_advpn %}
                set route-map-out "RM_EDGE_INET1_OUT"
            {% else %} {# no cross-region shortcuts #}
                set route-map-out "RM_EDGE_OUT"
            {% endif %}
        next
        edit "EDGE_INET2"
            set interface "EDGE_INET2"
            set update-source "EDGE_INET2"
            set remote-as {{west_ASN}}
            set additional-path send
            set adv-additional-path 3
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            {% if cross_region_advpn %}
                set route-map-out "RM_EDGE_INET2_OUT"
            {% else %} {# no cross-region shortcuts #}
                set route-map-out "RM_EDGE_OUT"
            {% endif %}
        next
        edit "EDGE_MPLS"
            set interface "EDGE_MPLS"
            set update-source "EDGE_MPLS"
            set remote-as {{west_ASN}}
            set additional-path send
            set adv-additional-path 3
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
            set next-hop-self enable
            set soft-reconfiguration enable
            {% if cross_region_advpn %}
                set route-map-out "RM_EDGE_MPLS_OUT"
            {% else %} {# no cross-region shortcuts #}
                set route-map-out "RM_EDGE_OUT"
            {% endif %}
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.201.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_INET1"
        next
        edit 2
            set prefix 10.202.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_INET2"
        next
        edit 3
            set prefix 10.203.{{dc_id}}.0 255.255.255.0
            set neighbor-group "EDGE_MPLS"
        next
    end
    config network
        edit 1
            set prefix 10.{{dc_id}}.0.0 255.255.255.0
            {% if cross_region_advpn %}
                set route-map "RM_LOCAL_TAG"
            {% endif %}
        next
        {% if FOS >= 7_000_000 %}
            edit 2
                set prefix 10.201.{{dc_id}}.0 255.255.255.0
            next
            edit 3
                set prefix 10.202.{{dc_id}}.0 255.255.255.0
            next
            edit 4
                set prefix 10.203.{{dc_id}}.0 255.255.255.0
            next
        {% endif %}
    end
end

#
# BGP routes
#

{% if dc_id == 1 and FOS >= 7_000_000 and cross_region_advpn %}
# FGT-W-DC1 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.1.0/24 [200/0] via 10.201.1.1 (recursive via EDGE_INET1 tunnel 10.201.1.1), 01:04:06
#                     [200/0] via 10.202.1.1 (recursive via EDGE_INET2 tunnel 10.202.1.1), 01:04:06
#                     [200/0] via 10.203.1.1 (recursive via EDGE_MPLS tunnel 10.203.1.1), 01:04:06
# B       10.0.2.0/24 [200/0] via 10.201.1.2 (recursive via EDGE_INET1 tunnel 10.201.1.2), 01:04:03
#                     [200/0] via 10.202.1.2 (recursive via EDGE_INET2 tunnel 10.202.1.2), 01:04:03
#                     [200/0] via 10.203.1.2 (recursive via EDGE_MPLS tunnel 10.203.1.2), 01:04:03
# B       10.0.3.0/24 [200/0] via 10.201.3.1 (recursive via W1E3_INET1 tunnel 100.64.21.3), 00:31:29
#                     [200/0] via 10.202.3.1 (recursive via W1E3_INET2 tunnel 100.64.22.3), 00:31:29
#                     [200/0] via 10.203.3.1 (recursive via W1E3_MPLS tunnel 10.0.24.3), 00:31:29
# B       10.3.0.0/24 [200/0] via 10.201.13.2 (recursive via W1E3_INET1 tunnel 100.64.21.3), 00:32:18
#                     [200/0] via 10.202.13.2 (recursive via W1E3_INET2 tunnel 100.64.22.3), 00:32:18
#                     [200/0] via 10.203.13.2 (recursive via W1E3_MPLS tunnel 10.0.24.3), 00:32:18
# B       10.200.0.0/14 [200/0] is a summary, Null, 01:03:59
# B       10.201.0.0/16 [200/0] is a summary, Null, 01:03:59
# B       10.201.3.0/24 [200/0] via 10.201.13.2 (recursive via W1E3_INET1 tunnel 100.64.21.3), 00:32:17
# B       10.202.0.0/16 [200/0] is a summary, Null, 01:03:59
# B       10.202.3.0/24 [200/0] via 10.202.13.2 (recursive via W1E3_INET2 tunnel 100.64.22.3), 00:32:17
# B       10.203.0.0/16 [200/0] is a summary, Null, 01:03:59
# B       10.203.3.0/24 [200/0] via 10.203.13.2 (recursive via W1E3_MPLS tunnel 10.0.24.3), 00:32:17
{% endif %}

{% if dc_id == 1 and FOS >= 7_000_000 and not cross_region_advpn %}
# FGT-W-DC1 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.0.0/14 [200/0] is a summary, Null, 00:07:21
# B       10.0.1.0/24 [200/0] via 10.201.1.1 (recursive via EDGE_INET1 tunnel 10.201.1.1), 00:07:13
#                     [200/0] via 10.202.1.1 (recursive via EDGE_INET2 tunnel 10.202.1.1), 00:07:13
#                     [200/0] via 10.203.1.1 (recursive via EDGE_MPLS tunnel 10.203.1.1), 00:07:13
# B       10.0.2.0/24 [200/0] via 10.201.1.2 (recursive via EDGE_INET1 tunnel 10.201.1.2), 00:07:15
#                     [200/0] via 10.202.1.2 (recursive via EDGE_INET2 tunnel 10.202.1.2), 00:07:15
#                     [200/0] via 10.203.1.2 (recursive via EDGE_MPLS tunnel 10.203.1.2), 00:07:15
# B       10.0.3.0/24 [20/0] via 10.201.13.2 (recursive via W1E3_INET1 tunnel 100.64.21.3), 00:05:20
#                     [20/0] via 10.202.13.2 (recursive via W1E3_INET2 tunnel 100.64.22.3), 00:05:20
#                     [20/0] via 10.203.13.2 (recursive via W1E3_MPLS tunnel 10.0.24.3), 00:05:20
# B       10.3.0.0/24 [20/0] via 10.202.13.2 (recursive via W1E3_INET2 tunnel 100.64.22.3), 00:07:15
#                     [20/0] via 10.201.13.2 (recursive via W1E3_INET1 tunnel 100.64.21.3), 00:07:15
#                     [20/0] via 10.203.13.2 (recursive via W1E3_MPLS tunnel 10.0.24.3), 00:07:15
# B       10.200.0.0/14 [200/0] is a summary, Null, 00:07:06
{% endif %}

{% if dc_id == 1 and FOS < 7_000_000 and cross_region_advpn %}
{% endif %}

{% if dc_id == 1 and FOS < 7_000_000 and not cross_region_advpn %}
{% endif %}

{% if dc_id == 2 and FOS >= 7_000_000 and cross_region_advpn %}
# FGT-W-DC2 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.1.0/24 [200/0] via 10.201.2.1 (recursive via EDGE_INET1 tunnel 10.201.2.1), 01:04:41
#                     [200/0] via 10.202.2.1 (recursive via EDGE_INET2 tunnel 10.202.2.1), 01:04:41
#                     [200/0] via 10.203.2.1 (recursive via EDGE_MPLS tunnel 10.203.2.1), 01:04:41
# B       10.0.2.0/24 [200/0] via 10.201.2.2 (recursive via EDGE_INET1 tunnel 10.201.2.2), 01:04:36
#                     [200/0] via 10.202.2.2 (recursive via EDGE_INET2 tunnel 10.202.2.2), 01:04:36
#                     [200/0] via 10.203.2.2 (recursive via EDGE_MPLS tunnel 10.203.2.2), 01:04:36
# B       10.0.3.0/24 [200/0] via 10.201.3.1 (recursive via W2E3_INET1 tunnel 100.64.21.3), 00:32:34
#                     [200/0] via 10.202.3.1 (recursive via W2E3_INET2 tunnel 100.64.22.3), 00:32:34
#                     [200/0] via 10.203.3.1 (recursive via W2E3_MPLS tunnel 10.0.24.3), 00:32:34
# B       10.3.0.0/24 [200/0] via 10.201.23.2 (recursive via W2E3_INET1 tunnel 100.64.21.3), 00:32:54
#                     [200/0] via 10.202.23.2 (recursive via W2E3_INET2 tunnel 100.64.22.3), 00:32:54
#                     [200/0] via 10.203.23.2 (recursive via W2E3_MPLS tunnel 10.0.24.3), 00:32:54
# B       10.200.0.0/14 [200/0] is a summary, Null, 01:04:34
# B       10.201.0.0/16 [200/0] is a summary, Null, 01:04:34
# B       10.201.3.0/24 [200/0] via 10.201.23.2 (recursive via W2E3_INET1 tunnel 100.64.21.3), 00:32:50
# B       10.202.0.0/16 [200/0] is a summary, Null, 01:04:34
# B       10.202.3.0/24 [200/0] via 10.202.23.2 (recursive via W2E3_INET2 tunnel 100.64.22.3), 00:32:50
# B       10.203.0.0/16 [200/0] is a summary, Null, 01:04:34
# B       10.203.3.0/24 [200/0] via 10.203.23.2 (recursive via W2E3_MPLS tunnel 10.0.24.3), 00:32:50
{% endif %}

{% if dc_id == 2 and FOS >= 7_000_000 and not cross_region_advpn %}
# FGT-W-DC2 # alias bgp_rib
# Routing table for VRF=0
# B       10.0.0.0/14 [200/0] is a summary, Null, 00:07:28
# B       10.0.1.0/24 [200/0] via 10.201.2.1 (recursive via EDGE_INET1 tunnel 10.201.2.1), 00:07:19
#                     [200/0] via 10.202.2.1 (recursive via EDGE_INET2 tunnel 10.202.2.1), 00:07:19
#                     [200/0] via 10.203.2.2 (recursive via EDGE_MPLS tunnel 10.203.2.2), 00:07:19
# B       10.0.2.0/24 [200/0] via 10.201.2.2 (recursive via EDGE_INET1 tunnel 10.201.2.2), 00:07:21
#                     [200/0] via 10.202.2.2 (recursive via EDGE_INET2 tunnel 10.202.2.2), 00:07:21
#                     [200/0] via 10.203.2.1 (recursive via EDGE_MPLS tunnel 10.203.2.1), 00:07:21
# B       10.0.3.0/24 [20/0] via 10.203.23.2 (recursive via W2E3_MPLS tunnel 10.0.24.3), 00:05:27
#                     [20/0] via 10.202.23.2 (recursive via W2E3_INET2 tunnel 100.64.22.3), 00:05:27
#                     [20/0] via 10.201.23.2 (recursive via W2E3_INET1 tunnel 100.64.21.3), 00:05:27
# B       10.3.0.0/24 [20/0] via 10.201.23.2 (recursive via W2E3_INET1 tunnel 100.64.21.3), 00:07:21
#                     [20/0] via 10.203.23.2 (recursive via W2E3_MPLS tunnel 10.0.24.3), 00:07:21
#                     [20/0] via 10.202.23.2 (recursive via W2E3_INET2 tunnel 100.64.22.3), 00:07:21
# B       10.200.0.0/14 [200/0] is a summary, Null, 00:07:13
{% endif %}

{% if dc_id == 2 and FOS < 7_000_000 and cross_region_advpn %}
{% endif %}

{% if dc_id == 2 and FOS < 7_000_000 and not cross_region_advpn %}
{% endif %}
