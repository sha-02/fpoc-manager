## Routing

# Static default-routes

config router static
    edit 1
        set device "Internet_1"
        set gateway {{wan.inet1.subnet}}.254
        set comment "Default-route via Internet-1"
    next
    edit 2
        set device "Internet_2"
        set gateway {{wan.inet2.subnet}}.254
        set comment "Default-route via Internet-2"
    next
    edit 4
        set dstaddr "Corporate_subnets"
        set device "MPLS"
        set gateway {{wan.mpls1.subnet}}.254
        set comment "corporate subnets via MPLS underlay"
    next
    edit 5
        set dstaddr "MPLS_interco_summary"
        set device "MPLS"
        set gateway {{wan.mpls1.subnet}}.254
        set comment "interco subnets of MPLS underlay"
    next
end

{% if FOS < 6_002_005 %}
    # Policy routes for ADVPN "domain" routing strategy
    config router policy
        edit 121
            set input-device "advpn1"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn1"
            set comments "ADVPN1/INET1 stickiness"
        next
        edit 122
            set input-device "advpn1"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn2"
            set comments "INET domain stickiness"
        next
        edit 124
            set input-device "advpn1"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn4"
            set comments "Cross-domain INET/MPLS preferred over LTE-to-LTE"
        next
        edit 222
            set input-device "advpn2"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn2"
            set comments "ADVPN2/INET2 stickiness"
        next
        edit 221
            set input-device "advpn2"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn1"
            set comments "INET domain stickiness"
        next
        edit 224
            set input-device "advpn2"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn4"
            set comments "Cross-domain INET/MPLS preferred over LTE-to-LTE"
        next
        edit 424
            set input-device "advpn4"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn4"
            set comments "ADVPN4/MPLS stickiness"
        next
        edit 421
            set input-device "advpn4"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn1"
            set comments "Cross-domain INET/MPLS"
        next
        edit 422
            set input-device "advpn4"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn2"
            set comments "Cross-domain INET/MPLS"
        next
        edit 321
            set input-device "advpn3"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn1"
            set comments "Domain INET stickiness while avoiding LTE-to-LTE"
        next
        edit 322
            set input-device "advpn3"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn2"
            set comments "Domain INET stickiness while avoiding LTE-to-LTE"
        next
        edit 324
            set input-device "advpn3"
            set srcaddr "all"
            set dstaddr "all"
            set output-device "advpn4"
            set comments "Cross-domain INET/MPLS preferred over LTE-to-LTE"
        next
    end
{% endif %}

# BGP peering over VPNs
# default BGP timers (1min/3min)for advpn3 (LTE overlay)

config router bgp
    set as 65000
    set router-id 192.168.3.3
    set ibgp-multipath enable
    set additional-path enable
    set additional-path-select 4
    set keepalive-timer 10
    set holdtime-timer 30
    config neighbor-group
        edit "advpn1"
            set interface "advpn1"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
        next
        edit "advpn2"
            set interface "advpn2"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
        next
        edit "advpn3"
            set interface "advpn3"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set keep-alive-timer 60
            set holdtime-timer 180
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
        next
        edit "advpn4"
            set interface "advpn4"
            set remote-as 65000
            set additional-path send
            set adv-additional-path 4
            set route-reflector-client enable
            set advertisement-interval 1
            set link-down-failover enable
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.255.1.0 255.255.255.0
            set neighbor-group "advpn1"
        next
        edit 2
            set prefix 10.255.2.0 255.255.255.0
            set neighbor-group "advpn2"
        next
        edit 3
            set prefix 10.255.3.0 255.255.255.0
            set neighbor-group "advpn3"
        next
        edit 4
            set prefix 10.255.4.0 255.255.255.0
            set neighbor-group "advpn4"
        next
    end
    config network
        edit 1
            set prefix 192.168.3.0 255.255.255.0
        next
    end
end

{% if duplicate_paths == 'offnet_filter_hub' %}
    # --------------------------------------------------------------
    # Filter duplicates paths from Hub. Filter off-net prefixes
    #

    # Define the overlay subnets

    config router prefix-list
        edit "overlay_advpn1"
            config rule
                edit 1
                    set prefix 10.255.1.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
        edit "overlay_advpn2"
            config rule
                edit 1
                    set prefix 10.255.2.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
        edit "overlay_advpn3"
            config rule
                edit 1
                    set prefix 10.255.3.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
        edit "overlay_advpn4"
            config rule
                edit 1
                    set prefix 10.255.4.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
    end

    # Filter off-net prefixes

    config router route-map
        edit "advpn1_out"
            config rule
                edit 2
                    set action deny
                    set match-ip-nexthop "overlay_advpn2"
                next
                edit 3
                    set action deny
                    set match-ip-nexthop "overlay_advpn3"
                next
                edit 4
                    set action deny
                    set match-ip-nexthop "overlay_advpn4"
                next
                edit 5
                next
            end
        next
        edit "advpn2_out"
            config rule
                edit 1
                    set action deny
                    set match-ip-nexthop "overlay_advpn1"
                next
                edit 3
                    set action deny
                    set match-ip-nexthop "overlay_advpn3"
                next
                edit 4
                    set action deny
                    set match-ip-nexthop "overlay_advpn4"
                next
                edit 5
                next
            end
        next
        edit "advpn3_out"
            config rule
                edit 1
                    set action deny
                    set match-ip-nexthop "overlay_advpn1"
                next
                edit 2
                    set action deny
                    set match-ip-nexthop "overlay_advpn2"
                next
                edit 4
                    set action deny
                    set match-ip-nexthop "overlay_advpn4"
                next
                edit 5
                next
            end
        next
        edit "advpn4_out"
            config rule
                edit 1
                    set action deny
                    set match-ip-nexthop "overlay_advpn1"
                next
                edit 2
                    set action deny
                    set match-ip-nexthop "overlay_advpn2"
                next
                edit 3
                    set action deny
                    set match-ip-nexthop "overlay_advpn3"
                next
                edit 5
                next
            end
        next
    end

    # Apply route maps

    config router bgp
        config neighbor-group
            edit "advpn1"
                set route-map-out "advpn1_out"
            next
            edit "advpn2"
                set route-map-out "advpn2_out"
            next
            edit "advpn3"
                set route-map-out "advpn3_out"
            next
            edit "advpn4"
                set route-map-out "advpn4_out"
            next
        end
    end
{% endif %}
