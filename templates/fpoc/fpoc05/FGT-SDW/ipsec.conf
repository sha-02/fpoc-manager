# IPsec


# ADVPN1 over Internet-1 - overlay subnet 10.255.1.0/24
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd optimized for Lab purpose

config vpn ipsec phase1-interface
    edit "advpn1"
        set interface "Internet_1"
        set ike-version 2
        set network-overlay enable
        set network-id 1
        set peertype any
        set localid "FGT-SDW-{{i}}_advpn1"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        {% if overlay == 'modecfg' %}
            set mode-cfg enable
        {% endif %}
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw {{hub_inet1}}
        set psksecret advpn1
    next
end

config vpn ipsec phase2-interface
    edit "advpn1"
        set phase1name "advpn1"
    next
end

config system interface
    edit "advpn1"
        {% if overlay == 'static' %}
            set ip 10.255.1.{{i}} 255.255.255.255
            set remote-ip 10.255.1.254 255.255.255.0
        {% endif %}
        set allowaccess ping
    next
end


# ADVPN2 over Internet-2 - overlay subnet 10.255.2.0/24
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd optimized for Lab purpose

config vpn ipsec phase1-interface
    edit "advpn2"
        set interface "Internet_2"
        set ike-version 2
        set network-overlay enable
        set network-id 2
        set peertype any
        set localid "FGT-SDW-{{i}}_advpn2"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        {% if overlay == 'modecfg' %}
            set mode-cfg enable
        {% endif %}
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw {{hub_inet2}}
        set psksecret advpn2
    next
end

config vpn ipsec phase2-interface
    edit "advpn2"
        set phase1name "advpn2"
    next
end

config system interface
    edit "advpn2"
        {% if overlay == 'static' %}
            set ip 10.255.2.{{i}} 255.255.255.255
            set remote-ip 10.255.2.254 255.255.255.0
        {% endif %}
        set allowaccess ping
    next
end


# ADVPN3 over LTE - overlay subnet 10.255.3.0/24
# remote-gw is the IP of port1 (Internet-1) on FGT-DC
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd-ondemand + interval 60 sec bcse LTE link

config vpn ipsec phase1-interface
    edit "advpn3"
        set interface "LTE"
        set ike-version 2
        set network-overlay enable
        set network-id 3
        set peertype any
        set localid "FGT-SDW-{{i}}_advpn3"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        {% if overlay == 'modecfg' %}
            set mode-cfg enable
        {% endif %}
        set dpd on-demand
        set dpd-retryinterval 60
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw {{hub_lte}}
        set psksecret advpn3
    next
end

config vpn ipsec phase2-interface
    edit "advpn3"
        set phase1name "advpn3"
    next
end

config system interface
    edit "advpn3"
        {% if overlay == 'static' %}
            set ip 10.255.3.{{i}} 255.255.255.255
            set remote-ip 10.255.3.254 255.255.255.0
        {% endif %}
        set allowaccess ping
    next
end

# ADVPN4 over MPLS - overlay subnet 10.255.4.0/24
# 'net-device enable' madatory for sd-wan over shortcuts
# dpd optimized for Lab purpose

config vpn ipsec phase1-interface
    edit "advpn4"
        set interface "MPLS"
        set ike-version 2
        set network-overlay enable
        set network-id 4
        set peertype any
        set localid "FGT-SDW-{{i}}_advpn4"
        set net-device enable
        set auto-discovery-receiver enable
        set add-route disable
        {% if overlay == 'modecfg' %}
            set mode-cfg enable
        {% endif %}
        set dpd on-idle
        set dpd-retryinterval 5
        set idle-timeout enable
        set idle-timeoutinterval 5
        set suite-b suite-b-gcm-128
        set remote-gw {{hub_mpls}}
        set psksecret advpn4
    next
end

config vpn ipsec phase2-interface
    edit "advpn4"
        set phase1name "advpn4"
    next
end

config system interface
    edit "advpn4"
        {% if overlay == 'static' %}
            set ip 10.255.4.{{i}} 255.255.255.255
            set remote-ip 10.255.4.254 255.255.255.0
        {% endif %}
        set allowaccess ping
    next
end

{% if duplicate_paths == 'onnet_pref_spokes' and override_with_hub_nexthop == False %}
    ## ----------------------------------------------------------------------------
    # RPF fix needed when on-net preference on Spoke is used with cross-overlay next-hop resolution
    #
    config system interface
        edit "advpn1"
            set src-check disable
        next
        edit "advpn2"
            set src-check disable
        next
        edit "advpn3"
            set src-check disable
        next
        edit "advpn4"
            set src-check disable
        next
    end
{% endif %}
