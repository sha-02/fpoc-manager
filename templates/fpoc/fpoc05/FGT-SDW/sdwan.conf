# SD-WAN
{% if FOS <= 7_000_000 %}
# 'set hold-down-time 20' to prevent falling back to most-preferred member before measuring its quality
{% else %}
# 'set tie-break fib-best-match' to select path with best-route to another shortcut instead of
# going back to feasible routes via Hub
{% endif %}

{% if FOS >= 6_004_001 %}
config system sdwan
    set status enable
    config zone
        edit "sdwan_overlay_internet"
        next
        edit "sdwan_overlay_mpls"
        next
        edit "sdwan_underlay_internet"
        next
        edit "sdwan_underlay_mpls"
        next
    end
    config members
        edit 1
            set interface "advpn1"
            set zone "sdwan_overlay_internet"
            {% if FOS <= 7_000_000 %}
                set gateway 10.255.1.254
            {% endif %}
        next
        edit 2
            set interface "advpn2"
            set zone "sdwan_overlay_internet"
            {% if FOS <= 7_000_000 %}
                set gateway 10.255.2.254
            {% endif %}
        next
        edit 3
            set interface "advpn3"
            set zone "sdwan_overlay_internet"
            {% if FOS <= 7_000_000 %}
                set gateway 10.255.3.254
            {% endif %}
        next
        edit 4
            set interface "advpn4"
            set zone "sdwan_overlay_mpls"
            {% if FOS <= 7_000_000 %}
                set gateway 10.255.4.254
            {% endif %}
        next
        edit 201
            set interface "Internet_1"
            set zone "sdwan_underlay_internet"
            set gateway {{wan.inet1.subnet}}.254
        next
        edit 202
            set interface "Internet_2"
            set zone "sdwan_underlay_internet"
            set gateway {{wan.inet2.subnet}}.254
        next
        edit 203
            set interface "LTE"
            set zone "sdwan_underlay_internet"
            set gateway {{wan.inet3.subnet}}.254
        next
        edit 204
            set interface "MPLS"
            set zone "sdwan_underlay_mpls"
            set gateway {{wan.mpls1.subnet}}.254
        next
    end
{% endif %}

{% if FOS <= 6_004_000 %}
config system virtual-wan-link
    set status enable
    config members
        edit 1
            set interface "advpn1"
            set gateway 10.255.1.254
        next
        edit 2
            set interface "advpn2"
            set gateway 10.255.2.254
        next
        edit 3
            set interface "advpn3"
            set gateway 10.255.3.254
        next
        edit 4
            set interface "advpn4"
            set gateway 10.255.4.254
        next
        edit 201
            set interface "Internet_1"
            set gateway {{wan.inet1.subnet}}.254
        next
        edit 202
            set interface "Internet_2"
            set gateway {{wan.inet2.subnet}}.254
        next
        edit 203
            set interface "LTE"
            set gateway {{wan.inet3.subnet}}.254
        next
        edit 204
            set interface "MPLS"
            set gateway {{wan.mpls1.subnet}}.254
        next
    end
{% endif %}

    config health-check
        edit "SLA_DC"
            set server "192.168.3.4"
            set members 1 2 4
            config sla
                edit 1
                    set link-cost-factor latency
                    set latency-threshold 150
                next
            end
        next
    end
    config service
        edit 1
            set name "PING_lowest_cost"
            set mode sla
            set protocol 1
            set dst "Corporate_subnets"
            set src "LAN"
            {% if FOS <= 7_000_000 %}
                set hold-down-time 20
            {% else %}
                set tie-break fib-best-match
            {% endif %}
            config sla
                edit "SLA_DC"
                    set id 1
                next
            end
            set priority-members 1 2
        next
        edit 2
            set name "SSH_best_quality"
            set mode priority
            set protocol 6
            set start-port 22
            set end-port 22
            set dst "Corporate_subnets"
            set src "LAN"
            set health-check "SLA_DC"
            set priority-members 2 1
        next
    end
end
