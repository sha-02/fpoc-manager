
## Routing

# Static default-routes
# give lower preference to default-route over LTE

config router static
    edit 1
        set device "Internet_1"
        set gateway {{wan.inet1.subnet}}.254
        set priority 10
        set comment "Default-route via Internet-1"
    next
    edit 2
        set device "Internet_2"
        set gateway {{wan.inet2.subnet}}.254
        set priority 10
        set comment "Default-route via Internet-2"
    next
    edit 3
        set device "LTE"
        set gateway {{wan.inet3.subnet}}.254
        set priority 20
        set comment "Default-route via Internet-LTE"
    next
    edit 4
        set dstaddr "Corporate_subnets"
        set device "MPLS"
        set gateway {{wan.mpls1.subnet}}.254
        set comment "corporate subnets via MPLS underlay"
    next
    edit 5
        set dstaddr "MPLS_interco_summary"
        set device "MPLS"
        set gateway {{wan.mpls1.subnet}}.254
        set comment "interco subnets of MPLS underlay"
    next
end

{% if remote_internet_mpls %}
    # ---------------------------------------------
    # Remote Internet Breakout via the MPLS tunnel

    config router static
        edit 0
            set device "advpn4"
            set priority 30
            set comment "Default-route via MPLS tunnel avdpn4"
        next
    end
{% endif %}

# BGP peerings over VPN overlays
# 'set interface' only taken into account for ipv4 as of 6.4/6.2.4 (0611900)
# default BGP timers (1min/3min) for advpn3 (LTE overlay)

config router bgp
    set as 65000
    set router-id 192.168.{{i}}.{{i}}
    set ibgp-multipath enable
    config neighbor
        edit "10.255.1.254"
            set interface "advpn1"
            set remote-as 65000
            set additional-path receive
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
        next
        edit "10.255.2.254"
            set interface "advpn2"
            set remote-as 65000
            set additional-path receive
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
        next
        edit "10.255.3.254"
            set interface "advpn3"
            set remote-as 65000
            set additional-path receive
            set keep-alive-timer 60
            set holdtime-timer 180
            set connect-timer 1
        next
        edit "10.255.4.254"
            set interface "advpn4"
            set remote-as 65000
            set additional-path receive
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
        next
    end
    config network
        edit 1
            set prefix 192.168.{{i}}.0 255.255.255.0
        next
    end
end

{# =============================================================================================================== #}

{% if override_with_hub_nexthop == False and duplicate_paths == 'keep_duplicates' %}
    ## ----------------------------------------------------------------------------
    # Cross-overlay preference using :
    #
    # - a summary route to cover all overlays (10.255.0.0/16)
    # - same distance to have all summaries in FIB/RIB
    # - different priorities to express the preference order (higher priority = lower preference)

    config router static
        edit 0
            set dstaddr "Overlay_summary"
            set device "advpn1"
            set priority 1
            set comment "Cross-overlay via advpn1"
        next
        edit 0
            set dstaddr "Overlay_summary"
            set device "advpn2"
            set priority 2
            set comment "Cross-overlay via advpn2"
        next
        edit 0
            set dstaddr "Overlay_summary"
            set device "advpn4"
            set priority 3
            set comment "Cross-overlay via advpn4"
        next
        edit 0
            set dstaddr "Overlay_summary"
            set device "advpn3"
            set priority 4
            set comment "Cross-overlay via advpn3"
        next
    end
{% endif %}


{# =============================================================================================================== #}

{% if duplicate_paths == 'onnet_pref_spokes' or override_with_hub_nexthop == True %}

    # on-net prefix = prefix learned on an overlay (eg, 10.255.1.0/24) which matches its BGP Next-Hop (eg, 10.255.1.2)
    # off-net prefix = prefix learned on an overlay (eg, 10.255.1.0/24) which does NOT match its BGP Next-Hop (say, 10.255.4.2)

    {% if duplicate_paths == 'onnet_pref_spokes' %}
        ## ----------------------------------------------------------------------------
        # On-net preference
        #
        # A local pref of 200 is assigned to "on-net" prefixes
        # "off-net" prefixes keep their default local-pref of 100 and are therefore less preferred
    {% endif %}
    {% if override_with_hub_nexthop == True %}
        ## ----------------------------------------------------------------------------
        # Cross-overlay shortcuts are not allowed
        #
        # keep the existing BGP NH for on-net prefixes
        # override the BGP NH of off-net prefixes with the BGP NH of the Hub
    {% endif %}

    # Identify each overlay subnet with a prefix-list

    config router prefix-list
        edit "overlay_advpn1"
            config rule
                edit 1
                    set prefix 10.255.1.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
        edit "overlay_advpn2"
            config rule
                edit 1
                    set prefix 10.255.2.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
        edit "overlay_advpn3"
            config rule
                edit 1
                    set prefix 10.255.3.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
        edit "overlay_advpn4"
            config rule
                edit 1
                    set prefix 10.255.4.0 255.255.255.0
                    unset ge
                    set le 32
                next
            end
        next
    end

    {% if duplicate_paths == 'onnet_pref_spokes' %}
        # Assign higher preference (higher local-pref) to "on-net" prefixes
    {% endif %}
    {% if override_with_hub_nexthop == True %}
        # override the BGP NH of off-net prefixes with the BGP NH of the Hub
    {% endif %}

    config router route-map
        edit "prefer_advpn1"
            config rule
                edit 1
                    set match-ip-nexthop "overlay_advpn1"
                    {% if duplicate_paths == 'onnet_pref_spokes' %}
                        set set-local-preference 200
                    {% endif %}
                next
                edit 2
                    {% if override_with_hub_nexthop == True %}
                        set set-ip-nexthop 10.255.1.254
                    {% endif %}
                next
            end
        next
        edit "prefer_advpn2"
            config rule
                edit 1
                    set match-ip-nexthop "overlay_advpn2"
                    {% if duplicate_paths == 'onnet_pref_spokes' %}
                        set set-local-preference 200
                    {% endif %}
                next
                edit 2
                    {% if override_with_hub_nexthop == True %}
                        set set-ip-nexthop 10.255.2.254
                    {% endif %}
                next
            end
        next
        edit "prefer_advpn3"
            config rule
                edit 1
                    set match-ip-nexthop "overlay_advpn3"
                    {% if duplicate_paths == 'onnet_pref_spokes' %}
                        set set-local-preference 200
                    {% endif %}
                next
                edit 2
                    {% if override_with_hub_nexthop == True %}
                        set set-ip-nexthop 10.255.3.254
                    {% endif %}
                next
            end
        next
        edit "prefer_advpn4"
            config rule
                edit 1
                    set match-ip-nexthop "overlay_advpn4"
                    {% if duplicate_paths == 'onnet_pref_spokes' %}
                        set set-local-preference 200
                    {% endif %}
                next
                edit 2
                    {% if override_with_hub_nexthop == True %}
                        set set-ip-nexthop 10.255.4.254
                    {% endif %}
                next
            end
        next
    end

    # Apply the on-net preference logic with an inbound route-map

    config router bgp
        config neighbor
            edit "10.255.1.254"
                set route-map-in "prefer_advpn1"
            next
            edit "10.255.2.254"
                set route-map-in "prefer_advpn2"
            next
            edit "10.255.3.254"
                set route-map-in "prefer_advpn3"
            next
            edit "10.255.4.254"
                set route-map-in "prefer_advpn4"
            next
        end
    end
{% endif %}


{# =============================================================================================================== #}

{% if feasible_routes != 'none' %}
    ## ----------------------------------------------------------------------------
    # Feasible routes when on-net preference on Spoke or off-net filtering on Hub is used with cross-overlay shortcuts
    #
    {% if duplicate_paths == 'onnet_pref_spokes' %}
        # RPF fix : allow corporate subnet received from any overlay. Cover any possible subnets from branches.
    {% endif %}
    {% if duplicate_paths == 'offnet_filter_hub' %}
        # Required for "off-net filtering on Hub"
    {% endif %}
    config router static
        edit 0
            set device "advpn1"
            set comment "Provides a feasible route over advpn1"
            {% if feasible_routes == 'rfc1918' %}
                set dstaddr "RFC1918-private-subnets"
            {% else %}
                set priority 30
            {% endif %}
        next
        edit 0
            set device "advpn2"
            set comment "Provides a feasible route over advpn2"
            {% if feasible_routes == 'rfc1918' %}
                set dstaddr "RFC1918-private-subnets"
            {% else %}
                set priority 30
            {% endif %}
        next
        edit 0
            set device "advpn3"
            set comment "Provides a feasible route over advpn3"
            {% if feasible_routes == 'rfc1918' %}
                set dstaddr "RFC1918-private-subnets"
            {% else %}
                set priority 30
            {% endif %}
        next
        edit 0
            set device "advpn4"
            set comment "Provides a feasible route over advpn4"
            {% if feasible_routes == 'rfc1918' %}
                set dstaddr "RFC1918-private-subnets"
            {% else %}
                set priority 30
            {% endif %}
        next
    end
{% endif %}

