# Static default-routes for Internet and MPLS accesses

config router static
    edit 1
        set gateway {{wan.inet1.subnet}}.254
        set device "INET1"
        set comment "default-route to Internet-1"
    next
    edit 2
        set gateway {{wan.inet2.subnet}}.254
        set device "INET2"
        set comment "default-route to Internet-2"
    next
end

{% if routing == 'static' %}
# =============== static routing ======================================================================
#
config router static
    edit 11
        set device "vpn1"
        {% if i == 1 %}
            set dstaddr "FGT2-LANs"
        {% else %}
            set dstaddr "FGT1-LANs"
        {% endif %}
    next
    edit 22
        set device "vpn2"
        {% if i == 1 %}
            set dstaddr "FGT2-LANs"
        {% else %}
            set dstaddr "FGT1-LANs"
        {% endif %}
    next
end
{% endif %}

{% if routing != 'static' %}
# =============== tunnel interfaces ======================================================================
#

config system interface
    edit "vpn1"
        {% if i == 1 %}
            set ip 192.168.255.1 255.255.255.255
            set remote-ip 192.168.255.2 255.255.255.255
        {% else %}
            set ip 192.168.255.2 255.255.255.255
            set remote-ip 192.168.255.1 255.255.255.255
        {% endif %}
    next
    edit "vpn2"
        {% if i == 1 %}
            set ip 192.168.255.11 255.255.255.255
            set remote-ip 192.168.255.22 255.255.255.255
        {% else %}
            set ip 192.168.255.22 255.255.255.255
            set remote-ip 192.168.255.11 255.255.255.255
        {% endif %}
    next
end
{% endif %}

{% if routing == 'ospf' %}
# =============== OSPF routing ======================================================================
#

# OSPF in backbone area

config router ospf
    set router-id 192.168.{{i}}.254
    config area
        edit 0.0.0.0
        next
        edit 0.0.0.{{i}}
        next
    end
    config network
        edit 1
            set prefix 192.168.{{i}}.0 255.255.255.0
            set area 0.0.0.{{i}}
        next
        edit 2
            set prefix 192.168.{{i}}{{i}}.0 255.255.255.0
            set area 0.0.0.{{i}}
        next
        edit 3
            set prefix 192.168.255.0 255.255.255.0
        next
    end
    set passive-interface "port5" "port6"
end
{% endif %}

{% if routing == 'ibgp' %}
# =============== iBGP routing (one peering per VPN) ==================================================================
#

# two iBGP peerings in ASN 65000

config router bgp
    set as 65000
    set router-id 192.168.{{i}}.254
    set ibgp-multipath enable
    config neighbor
        {% if i == 1 %}
            edit "192.168.255.2"
        {% else %}
            edit "192.168.255.1"
        {% endif %}
            set interface "vpn1"
            set remote-as 65000
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
        next
        {% if i == 1 %}
            edit "192.168.255.22"
        {% else %}
            edit "192.168.255.11"
        {% endif %}
            set interface "vpn2"
            set remote-as 65000
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
        next
    end
    config network
        edit 1
            set prefix 192.168.{{i}}.0 255.255.255.0
        next
        edit 2
            set prefix 192.168.{{i}}{{i}}.0 255.255.255.0
        next
    end
end
{% endif %}


{% if routing == 'ebgp' %}
# =============== eBGP routing (one peering per VPN) ==================================================================
#

# two eBGP peerings

config router bgp
    set as 6500{{i}}
    set router-id 192.168.{{i}}.254
    set ebgp-multipath enable
    config neighbor
        {% if i == 1 %}
            edit "192.168.255.2"
                set interface "vpn1"
                set remote-as 65002
                set keep-alive-timer 10
                set holdtime-timer 30
                set connect-timer 1
            next
            edit "192.168.255.22"
                set interface "vpn2"
                set remote-as 65002
                set keep-alive-timer 10
                set holdtime-timer 30
                set connect-timer 1
            next
        {% else %}
            edit "192.168.255.1"
                set interface "vpn1"
                set remote-as 65001
                set keep-alive-timer 10
                set holdtime-timer 30
                set connect-timer 1
            next
            edit "192.168.255.11"
                set interface "vpn2"
                set remote-as 65001
                set keep-alive-timer 10
                set holdtime-timer 30
                set connect-timer 1
            next
        {% endif %}
    end
    config network
        edit 1
            set prefix 192.168.{{i}}.0 255.255.255.0
        next
        edit 2
            set prefix 192.168.{{i}}{{i}}.0 255.255.255.0
        next
    end
end
{% endif %}

{% if routing == 'ibgp-loopback' %}
# =============== single iBGP peering (ASN 65000) over a loopback advertized by OSPF ===================================
#

# loopback interface for iBGP peering

config system interface
    edit "loopback_BGP"
        set vdom "root"
        set type loopback
        set ip 192.168.255.{{i}}{{i}}{{i}} 255.255.255.255
        set allowaccess ping
    next
end

# OSPF in backbone area

config router ospf
    set router-id 192.168.255.{{i}}{{i}}{{i}}
    config area
        edit 0.0.0.0
        next
    end
    config network
        edit 1
            set prefix 192.168.255.0 255.255.255.0
        next
    end
    set passive-interface "loopback_BGP"
end

# single iBGP peering (ASN 65000) over a loopback advertized by OSPF

config router bgp
    set as 65000
    set router-id 192.168.255.{{i}}{{i}}{{i}}
    set ibgp-multipath enable
    config neighbor
        {% if i == 1 %}
            edit "192.168.255.222"
        {% else %}
            edit "192.168.255.111"
        {% endif %}
            set remote-as 65000
            set keep-alive-timer 10
            set holdtime-timer 30
            set connect-timer 1
            set update-source "loopback_BGP"
        next
    end
    config network
        edit 1
            set prefix 192.168.{{i}}.0 255.255.255.0
        next
        edit 2
            set prefix 192.168.{{i}}{{i}}.0 255.255.255.0
        next
    end
end

# Allow BGP/PING traffic from vpn interfaces to the loopback interface

config firewall address
    edit "BGP_loopback_ip"
        set subnet 192.168.255.{{i}}{{i}}{{i}} 255.255.255.255
    next
end

config firewall policy
    edit 0
        set name "Allow inbound BGP peering"
        set srcintf "vpn1" "vpn2"
        set dstintf "loopback_BGP"
        set srcaddr "all"
        set dstaddr "BGP_loopback_ip"
        set action accept
        set schedule "always"
        set service "BGP" "PING"
    next
end

{% endif %}
